<div class="sheet-container">
  <div class='sheet-2colrow'>
    <div class='sheet-col'>
          <label class='sheet-label'>Name:</label>
          <input type="text" class='sheet-input' name="attr_character_name" placeholder="Character Name" />
          <label class='sheet-label'>Title:</label>
          <input type="text" class='sheet-input' name="attr_character_title" placeholder="Character Title" />
          <label class='sheet-label'>Species:</label>
          <input type="text" class='sheet-input' name="attr_character_race" placeholder="Race/Species" />
      </div>
    <div class='sheet-col'>
      <img style="padding-top:15px;" src="https://github.com/SPConlin/roll20-character-sheets/blob/elemental/Elemental/images/logo.png?raw=true" />
    </div>
  </div>
  <hr />
  <div class='sheet-3colrow'>
    <div class='sheet-col'>
      <div class="sheet-header">Attributes & Skills</div>
      <div class="sheet-attrblock">
          <button type="roll" class="sheet-rollatrrib" name="roll_agi" value="&{template:default} {{name= Agility}} {{roll= [[1d6+@{agi}]]}}"></button>
          <input type="text" class="sheet-attrname" value="Agility" readonly />
          <input type="number" class="sheet-number" name="attr_agi" value="0" />
          <input type="hidden" name="attr_agi_xp_used" value="0" />
          <input type="hidden" name="attr_agiskill_xp_used" value="0" />
          <div class="sheet-skillblock">
              <fieldset class="repeating_agiskills">
                <button type="roll" class="sheet-rollskill" name="roll_agi_skill" value="&{template:default} {{name= @{agi_skill_name} }} {{roll= [[1d6 + @{agi} + @{agi_skill_rating}]]}}"></button>
                <input type="text" style="width: 125px;" name="attr_agi_skill_name" value="" placeholder="Skill Name" />
                <input type="number" class="sheet-attrval" name="attr_agi_skill_rating" value="0" />
              </fieldset>
          </div>
      </div>
      <br />
      <div class="sheet-attrblock">
          <button type="roll" class="sheet-rollatrrib" name="roll_tough" value="&{template:default} {{name= Agility}} {{roll= [[1d6+@{tough}]]}}"></button>
          <input type="text" class="sheet-attrname" value="Toughness" readonly />
          <input type="number" class="sheet-number" name="attr_tough" value="0" />
          <input type="hidden" name="attr_tough_xp_used" value="0" />
          <input type="hidden" name="attr_toughskill_xp_used" value="0" />
          <div class="sheet-skillblock">
              <fieldset class="repeating_toughskills">
                <button type="roll" class="sheet-rollskill" name="roll_tough_skill" value="&{template:default} {{name= @{tough_skill_name} }} {{roll= [[1d6 + @{tough} + @{tough_skill_rating}]]}}"></button>
                <input type="text" style="width: 125px;" name="attr_tough_skill_name" value="" placeholder="Skill Name" />
                <input type="number" class="sheet-attrval" name="attr_tough_skill_rating" value="0" />
              </fieldset>
          </div>
      </div>
      <br />
      <div class="sheet-attrblock">
          <button type="roll" class="sheet-rollatrrib" name="roll_aware" value="&{template:default} {{name= Awareness}} {{roll= [[1d6+@{aware}]]}}"></button>
          <input type="text" class="sheet-attrname" value="Awareness" readonly />
          <input type="number" class="sheet-number" name="attr_aware" value="0" />
          <input type="hidden" name="attr_aware_xp_used" value="0" />
          <input type="hidden" name="attr_awareskill_xp_used" value="0" />
          <div class="sheet-skillblock">
              <fieldset class="repeating_awareskills">
                <button type="roll" class="sheet-rollskill" name="roll_aware_skill" value="&{template:default} {{name= @{aware_skill_name} }} {{roll= [[1d6 + @{aware} + @{aware_skill_rating}]]}}"></button>
                <input type="text" style="width: 125px;" name="attr_aware_skill_name" value="" placeholder="Skill Name" />
                <input type="number" class="sheet-attrval" name="attr_aware_skill_rating" value="0" />
              </fieldset>
          </div>
      </div>
      <br />
      <div class="sheet-attrblock">
          <button type="roll" class="sheet-rollatrrib" name="roll_will" value="&{template:default} {{name= will}} {{roll= [[1d6+@{will}]]}}"></button>
          <input type="text" class="sheet-attrname" value="Will" readonly />
          <input type="number" class="sheet-number" name="attr_will" value="0" />
          <input type="hidden" name="attr_will_xp_used" value="0" />
          <input type="hidden" name="attr_willskill_xp_used" value="0" />
          <div class="sheet-skillblock">
              <fieldset class="repeating_willskills">
                <td><button type="roll" class="sheet-rollskill" name="roll_will_skill" value="&{template:default} {{name= @{will_skill_name} }} {{roll= [[1d6 + @{will} + @{will_skill_rating}]]}}"></button>
                <td><input type="text"  style="width: 125px;" name="attr_will_skill_name" value="" placeholder="Skill Name" />
                  <input type="number" class="sheet-attrval" name="attr_will_skill_rating" value="0" />
              </fieldset>
          </div>
      </div>
    </div>
    <div class='sheet-col'>
      <br /><br />
      <table align='center' class='sheet-xp'>
        <tr>
          <th class='sheet-header' colspan=4>Experience Points</th>
        </tr>
        <tr>
          <th>Total</th>
          <th>Spent</th>
          <th>Sacrificed</th>
          <th>Reserve</th>
        </tr>
        <tr>
          <td><input type="number" class="sheet-number" name="attr_xp_total" placeholder="0" /></td>
          <td><input type="number" class="sheet-dirstats" name="attr_xp_spent" value="0" readonly /></td>
          <td><input type="number" class="sheet-number" name="attr_xp_sacrificed" placeholder="0" /></td>
          <td><input type="number" class="sheet-dirstats" name="attr_xp_reserve" value="0" readonly /></td>
        </tr>
      </table>
      <br />
      <table align='center' class="sheet-xp">
        <tr>
          <th class='sheet-header' colspan=4>Derived Statistics</th>
        </tr>
        <tr>
          <th>Max Health</th>
          <th>Move</th>
          <th>Initiative</th>
          <th>Spirit</th>
        </tr>
        <tr>
          <td><input type="text" class="sheet-dirstats" style="width:30px" name="attr_curhealth" value="0" readonly />/<input type="text" class="sheet-dirstats" style="width:30px" name="attr_health" value="0" readonly /></td>
          <td><input type="number" class="sheet-dirstats" name="attr_move" value="0" readonly /></td>
          <td><input type="number" class="sheet-dirstats" name="attr_initiative" value="0" readonly /></td>
          <td><input type="number" class="sheet-dirstats" name="attr_spirit" value="0" readonly /></td>
        </tr>
      </table>
      <br />
      <table align='center' class='sheet-xp'>
        <tr>
          <th class='sheet-header' colspan=4>Bonuses/Impairments</th>
        </tr>
        <tr>
          <th>Injuries</th>
          <th>ARM</th>
          <th>DAM</th>
          <th>Other</th>
        </tr>
        <tr>
          <td><input type="number" class="sheet-number" name="attr_injury" value="0" /></td>
          <td><input type="number" class="sheet-number" name="attr_arm_bonus" placeholder="0" /></td>
          <td><input type="number" class="sheet-number" name="attr_dam_bonus" value="0"  /></td>
          <td><input type="number" class="sheet-number" name="attr_other_bonus" placeholder="0" /></td>
        </tr>
      </table>
    </div>
    <div class='sheet-col'>
      <div class="sheet-header">Weapons</div>
      <div class="sheet-weaponblock">
            <div class="sheet-top">
                <span class="sheet-blocklabel" style="width: 155px;" data-i18n="name-u">Name</span>
                <span class="sheet-blocklabel" style="width: 70px;" data-i18n="dam-u">DAM</span>
                <br />
                <span class="sheet-blocklabel" style="margin-left:20px; width: 55px;" data-i18n="ammo-u">Ammo</span>
                <span class="sheet-blocklabel" style="width: 55px;" data-i18n="rng-u">Range</span>
                <span class="sheet-blocklabel" style="width: 55px;" data-i18n="aoe-u">AOE</span>
                <span class="sheet-blocklabel" style="width: 20px;" data-i18n="wt-u">Wt</span>
            </div>
          <fieldset class="repeating_weapons">
            <input type="text" style="width:150px" name="attr_weaponname" />
            <input type="text" style="width:75px" name="attr_weapondmg" />
            <br />
            <input type="number" style="margin-left:20px; width:50px" name="attr_weaponammo" />
            <input type="number" style="width:50px" name="attr_weaponrng" />
            <input type="number" style="width:50px" name="attr_weaponaoe" />
            <input type="number" style="width:50px" name="attr_weaponwt" />
            <br />
            <input type="number" style="margin-left:20px; width:210px" name="attr_weaponnote" placeholder="Notes" />
          </fieldset>
      </div>
      <br/>
      <div class="sheet-header">Armor</div>
      <div class="sheet-armorblock">
            <div class="sheet-top">
                <span class="sheet-blocklabel" style="width: 125px;" data-i18n="name-u">Name</span>
                <span class="sheet-blocklabel" style="width: 55px;" data-i18n="arm-u">ARM</span>
                <span class="sheet-blocklabel" style="width: 20px;" data-i18n="wt-u">Wt</span>
            </div>
          <fieldset class="repeating_armor">
            <input type="text" style="width:120px" name="attr_armorname" />
            <input type="number" style="width:50px"name="attr_armorsoak" />
            <input type="number" style="width:50px" name="attr_armorwt" />
            <br />
            <input type="number" style="margin-left:20px; width:210px" name="attr_weaponnote" placeholder="Notes" />
          </fieldset>
      </div>
      <br/>
      <div class="sheet-header">Equipment</div>
      <div class="sheet-equipblock">
            <div class="sheet-top">
                <span class="sheet-blocklabel" style="width: 190px;" data-i18n="name-u">Name</span>
                <span class="sheet-blocklabel" style="width: 20px;" data-i18n="wt-u">Wt</span>
            </div>
          <fieldset class="repeating_equipment">
            <input type="text" class="sheet-equipname" name="attr_equipname" />
            <input type="number" class="sheet-equipwt" name="attr_equipwt" />
          </fieldset>
      </div>
    </div>
  </div>
</div>

<script type="text/worker">

on("change:agi", function() {
    getAttrs(["agi","xp_total","xp_sacrificed","tough_xp_used","aware_xp_used","will_xp_used","agiskill_xp_used","toughskill_xp_used","awareskill_xp_used","willskill_xp_used"], function(values) {
      agi = parseInt(values.agi,10)||0;
      xp_total = parseInt(values.xp_total,10)||0;
      xp_sacrificed = parseInt(values.xp_sacrificed,10)||0;
      tough_xp_used = parseInt(values.tough_xp_used,10)||0;
      aware_xp_used = parseInt(values.aware_xp_used,10)||0;
      will_xp_used = parseInt(values.will_xp_used,10)||0;
      agiskill_xp_used = parseInt(values.agiskill_xp_used,10)||0;
      toughskill_xp_used = parseInt(values.toughskill_xp_used,10)||0;
      awareskill_xp_used = parseInt(values.awareskill_xp_used,10)||0;
      willskill_xp_used = parseInt(values.willskill_xp_used,10)||0;
      agi_xp_used = calc_XPUsed(agi);
      xpUsed = agi_xp_used + tough_xp_used + aware_xp_used + will_xp_used + agiskill_xp_used + toughskill_xp_used + awareskill_xp_used + willskill_xp_used;
      setAttrs({
          move: 9 + agi_xp_used,
          agi_xp_used: agi_xp_used,
          xp_spent: xpUsed,
          xp_reserve: xp_total - xpUsed - xp_sacrificed
      });
    });
});

on("change:tough", function() {
    getAttrs(["tough","xp_total","xp_sacrificed","injury","agi_xp_used","aware_xp_used","will_xp_used","agiskill_xp_used","toughskill_xp_used","awareskill_xp_used","willskill_xp_used"], function(values) {
      tough = parseInt(values.tough,10)||0;
      xp_total = parseInt(values.xp_total,10)||0;
      xp_sacrificed = parseInt(values.xp_sacrificed,10)||0;
      injuries = parseInt(values.injury,10)||0;
      agi_xp_used = parseInt(values.agi_xp_used,10)||0;
      aware_xp_used = parseInt(values.aware_xp_used,10)||0;
      will_xp_used = parseInt(values.will_xp_used,10)||0;
      agiskill_xp_used = parseInt(values.agiskill_xp_used,10)||0;
      toughskill_xp_used = parseInt(values.toughskill_xp_used,10)||0;
      awareskill_xp_used = parseInt(values.awareskill_xp_used,10)||0;
      willskill_xp_used = parseInt(values.willskill_xp_used,10)||0;
      tough_xp_used = calc_XPUsed(tough);
      xpUsed = agi_xp_used + tough_xp_used + aware_xp_used + will_xp_used + agiskill_xp_used + toughskill_xp_used + awareskill_xp_used + willskill_xp_used;
      setAttrs({
          health: 9 + tough_xp_used,
          curhealth: 9 + tough_xp_used - injuries,
          tough_xp_used: tough_xp_used,
          xp_spent: xpUsed,
          xp_reserve: xp_total - xpUsed - xp_sacrificed
      });
    });
});

on("change:aware", function() {
    getAttrs(["aware","xp_total","xp_sacrificed","tough_xp_used","agi_xp_used","will_xp_used","agiskill_xp_used","toughskill_xp_used","awareskill_xp_used","willskill_xp_used"], function(values) {
      aware = parseInt(values.aware,10)||0;
      xp_total = parseInt(values.xp_total,10)||0;
      xp_sacrificed = parseInt(values.xp_sacrificed,10)||0;
      agi_xp_used = parseInt(values.agi_xp_used,10)||0;
      tough_xp_used = parseInt(values.tough_xp_used,10)||0;
      will_xp_used = parseInt(values.will_xp_used,10)||0;
      agiskill_xp_used = parseInt(values.agiskill_xp_used,10)||0;
      toughskill_xp_used = parseInt(values.toughskill_xp_used,10)||0;
      awareskill_xp_used = parseInt(values.awareskill_xp_used,10)||0;
      willskill_xp_used = parseInt(values.willskill_xp_used,10)||0;
      aware_xp_used = calc_XPUsed(aware);
      xpUsed = agi_xp_used + tough_xp_used + aware_xp_used + will_xp_used + agiskill_xp_used + toughskill_xp_used + awareskill_xp_used + willskill_xp_used;
      setAttrs({
          initiative: 9 + aware_xp_used,
          aware_xp_used: aware_xp_used,
          xp_spent: xpUsed,
          xp_reserve: xp_total - xpUsed - xp_sacrificed
      });
    });
});

on("change:will", function() {
    getAttrs(["will","xp_total","xp_sacrificed","tough_xp_used","aware_xp_used","agi_xp_used","agiskill_xp_used","toughskill_xp_used","awareskill_xp_used","willskill_xp_used"], function(values) {
      will = parseInt(values.will,10)||0;
      xp_total = parseInt(values.xp_total,10)||0;
      xp_sacrificed = parseInt(values.xp_sacrificed,10)||0;
      agi_xp_used = parseInt(values.agi_xp_used,10)||0;
      tough_xp_used = parseInt(values.tough_xp_used,10)||0;
      aware_xp_used = parseInt(values.aware_xp_used,10)||0;
      agiskill_xp_used = parseInt(values.agiskill_xp_used,10)||0;
      toughskill_xp_used = parseInt(values.toughskill_xp_used,10)||0;
      awareskill_xp_used = parseInt(values.awareskill_xp_used,10)||0;
      willskill_xp_used = parseInt(values.willskill_xp_used,10)||0;
      will_xp_used = calc_XPUsed(will);
      xpUsed = agi_xp_used + tough_xp_used + aware_xp_used + will_xp_used + agiskill_xp_used + toughskill_xp_used + awareskill_xp_used + willskill_xp_used;
      setAttrs({
          spirit: 9 + will_xp_used,
          will_xp_used: will_xp_used,
          xp_spent: xpUsed,
          xp_reserve: xp_total - xpUsed - xp_sacrificed
      });
    });
});

on("change:xp_total", function() {
    getAttrs(["xp_total","xp_spent","xp_sacrificed"], function(values) {
      xp_total = parseInt(values.xp_total,10)||0;
      xp_spent = parseInt(values.xp_spent,10)||0;
      xp_sacrificed = parseInt(values.xp_sacrificed,10)||0;
      setAttrs({
          xp_reserve: xp_total - xp_spent - xp_sacrificed
      });
    });
});

on("change:xp_sacrificed", function() {
    getAttrs(["xp_total","xp_spent","xp_sacrificed"], function(values) {
      xp_total = parseInt(values.xp_total,10)||0;
      xp_spent = parseInt(values.xp_spent,10)||0;
      xp_sacrificed = parseInt(values.xp_sacrificed,10)||0;
      setAttrs({
          xp_reserve: xp_total - xp_spent - xp_sacrificed
        });
    });
});

on("change:injury", function() {
    getAttrs(["health","injury"], function(values) {
      health = parseInt(values.health,10)||0;
      injuries = parseInt(values.injury,10)||0;
      setAttrs({
          curhealth: health - injuries
      });
    });
});

on('change:repeating_agiskills remove:repeating_agiskills', () => {
    repeatingXPSum("agiskill_xp_used","agiskills","agi_skill_rating", function() {
        getAttrs(["xp_total","xp_sacrificed","agi_xp_used","tough_xp_used","aware_xp_used","will_xp_used","agiskill_xp_used","toughskill_xp_used","awareskill_xp_used","willskill_xp_used"], function(values) {
          xp_total = parseInt(values.xp_total,10)||0;
          xp_sacrificed = parseInt(values.xp_sacrificed,10)||0;
          agi_xp_used = parseInt(values.agi_xp_used,10)||0;
          tough_xp_used = parseInt(values.tough_xp_used,10)||0;
          aware_xp_used = parseInt(values.aware_xp_used,10)||0;
          will_xp_used = parseInt(values.will_xp_used,10)||0;
          agiskill_xp_used = parseInt(values.agiskill_xp_used,10)||0;
          toughskill_xp_used = parseInt(values.toughskill_xp_used,10)||0;
          awareskill_xp_used = parseInt(values.awareskill_xp_used,10)||0;
          willskill_xp_used = parseInt(values.willskill_xp_used,10)||0;
          xpUsed = agi_xp_used + tough_xp_used + aware_xp_used + will_xp_used + agiskill_xp_used + toughskill_xp_used + awareskill_xp_used + willskill_xp_used;
          setAttrs({
              xp_spent: xpUsed,
              xp_reserve: xp_total - xpUsed - xp_sacrificed
          });
        });
    });
});

on('change:repeating_toughskills remove:repeating_toughskills', () => {
    repeatingXPSum("toughskill_xp_used","toughskills","tough_skill_rating", function() {
        getAttrs(["xp_total","xp_sacrificed","agi_xp_used","tough_xp_used","aware_xp_used","will_xp_used","agiskill_xp_used","toughskill_xp_used","awareskill_xp_used","willskill_xp_used"], function(values) {
          xp_total = parseInt(values.xp_total,10)||0;
          xp_sacrificed = parseInt(values.xp_sacrificed,10)||0;
          agi_xp_used = parseInt(values.agi_xp_used,10)||0;
          tough_xp_used = parseInt(values.tough_xp_used,10)||0;
          aware_xp_used = parseInt(values.aware_xp_used,10)||0;
          will_xp_used = parseInt(values.will_xp_used,10)||0;
          agiskill_xp_used = parseInt(values.agiskill_xp_used,10)||0;
          toughskill_xp_used = parseInt(values.toughskill_xp_used,10)||0;
          awareskill_xp_used = parseInt(values.awareskill_xp_used,10)||0;
          willskill_xp_used = parseInt(values.willskill_xp_used,10)||0;
          xpUsed = agi_xp_used + tough_xp_used + aware_xp_used + will_xp_used + agiskill_xp_used + toughskill_xp_used + awareskill_xp_used + willskill_xp_used;
          setAttrs({
              xp_spent: xpUsed,
              xp_reserve: xp_total - xpUsed - xp_sacrificed
          });
        });
    });
});

on('change:repeating_awareskills remove:repeating_awareskills', () => {
    repeatingXPSum("awareskill_xp_used","awareskills","aware_skill_rating", function() {
        getAttrs(["xp_total","xp_sacrificed","agi_xp_used","tough_xp_used","aware_xp_used","will_xp_used","agiskill_xp_used","toughskill_xp_used","awareskill_xp_used","willskill_xp_used"], function(values) {
          xp_total = parseInt(values.xp_total,10)||0;
          xp_sacrificed = parseInt(values.xp_sacrificed,10)||0;
          agi_xp_used = parseInt(values.agi_xp_used,10)||0;
          tough_xp_used = parseInt(values.tough_xp_used,10)||0;
          aware_xp_used = parseInt(values.aware_xp_used,10)||0;
          will_xp_used = parseInt(values.will_xp_used,10)||0;
          agiskill_xp_used = parseInt(values.agiskill_xp_used,10)||0;
          toughskill_xp_used = parseInt(values.toughskill_xp_used,10)||0;
          awareskill_xp_used = parseInt(values.awareskill_xp_used,10)||0;
          willskill_xp_used = parseInt(values.willskill_xp_used,10)||0;
          xpUsed = agi_xp_used + tough_xp_used + aware_xp_used + will_xp_used + agiskill_xp_used + toughskill_xp_used + awareskill_xp_used + willskill_xp_used;
          setAttrs({
              xp_spent: xpUsed,
              xp_reserve: xp_total - xpUsed - xp_sacrificed
          });
        });
    });
});

on('change:repeating_willskills remove:repeating_willskills', () => {
    repeatingXPSum("willskill_xp_used","willskills","will_skill_rating", function() {
        getAttrs(["xp_total","xp_sacrificed","agi_xp_used","tough_xp_used","aware_xp_used","will_xp_used","agiskill_xp_used","toughskill_xp_used","awareskill_xp_used","willskill_xp_used"], function(values) {
          xp_total = parseInt(values.xp_total,10)||0;
          xp_sacrificed = parseInt(values.xp_sacrificed,10)||0;
          agi_xp_used = parseInt(values.agi_xp_used,10)||0;
          tough_xp_used = parseInt(values.tough_xp_used,10)||0;
          aware_xp_used = parseInt(values.aware_xp_used,10)||0;
          will_xp_used = parseInt(values.will_xp_used,10)||0;
          agiskill_xp_used = parseInt(values.agiskill_xp_used,10)||0;
          toughskill_xp_used = parseInt(values.toughskill_xp_used,10)||0;
          awareskill_xp_used = parseInt(values.awareskill_xp_used,10)||0;
          willskill_xp_used = parseInt(values.willskill_xp_used,10)||0;
          xpUsed = agi_xp_used + tough_xp_used + aware_xp_used + will_xp_used + agiskill_xp_used + toughskill_xp_used + awareskill_xp_used + willskill_xp_used;
          setAttrs({
              xp_spent: xpUsed,
              xp_reserve: xp_total - xpUsed - xp_sacrificed
          });
        });
    });
});

function calc_XPUsed(grade) {
    total = 0;
    for (i = 1; i <= grade; i++) {total += i; }
    return total;
}

/* ===== PARAMETERS ==========
destination = the name of the attribute that stores the total quantity
section = name of repeating fieldset, without the repeating_
fields = the name of the attribute field to be summed
      can be a single attribute: 'weight'
      or an array of attributes: ['weight','number','equipped']
multiplier (optional) = a multiplier to to entire fieldset total. For instance, if summing coins of weight 0.02, might want to multiply the final total by 0.02.
*/
const repeatingXPSum = (destination, section, fields, callback, multiplier = 1) => {
    if (!Array.isArray(fields)) fields = [fields];
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce( (m,id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))],[]);
        getAttrs(attrArray, v => {
            console.log("===== values of v: "+ JSON.stringify(v) +" =====");
                 // getValue: if not a number, returns 1 if it is 'on' (checkbox), otherwise returns 0..
            const getValue = (section, id,field) => parseFloat(v[`repeating_${section}_${id}_${field}`], 10) || (v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : 0);
            const sumTotal = idArray.reduce((total, id) => total + fields.reduce((subtotal,field) => subtotal * calc_XPUsed(getValue(section, id,field)),1),0);
            setAttrs({[destination]: sumTotal * multiplier}, callback);
        });
    });
};

</script>

<div class="row-w">
    <div class="col-xs-2">
        <img src="https://i.imgur.com/iJVp8hG.jpg" alt="Pluma">
    </div>
    <div class="col-xs-8 full-tittle-center">
        <h4>CUENTOS DE ÁNIMAS</h4>
    </div>
    <div class="col-xs-2">
        <img class="inverse" src="https://i.imgur.com/iJVp8hG.jpg" alt="Pluma">
    </div>
</div>


<div class="pestana-jugador">
    <div class="margin-b-50 padding-b-50 padding-t-15">
        <div class="row-w width-100">
            <div class="column-nw col-xs-6">
                <div class="row-nw">
                    <span class="col-xs-4 text-subheader">NOMBRE:</span>
                    <input class="nobox-grey col-xs-8" type="text" name="attr_character_name" readonly>
                </div>
                <div class="row-nw padding-t-10">
                    <span class="col-xs-4 text-subheader">PROFESIÓN:</span>
                    <input class="nobox-grey col-xs-8" type="text" name="attr_profesion">
                </div>
                <div class="column-nw padding-t-10">
                    <span class="text-subheader">LUGAR DE ORIGEN:</span>
                    <input class="nobox-grey width-100" type="text" name="attr_origen">
                </div>
                <div class="column-nw padding-t-10">
                    <span class="text-subheader">DESCRIPCIÓN FÍSICA:</span>
                    <textarea class="nobox-grey" name="attr_descripcion"></textarea>
                </div>
            </div>
            <div class="column-nw col-xs-6">
                <span class="text-subheader">BREVE HISTORIA:</span>
                <textarea class="nobox-grey" name="attr_descripcion"></textarea>
            </div>
        </div>
        <div class="row-nw width-100 padding-t-35">
            <div class="row-w col-xs-8">
                <span class="text-subheader">RASGOS/OBJETOS:</span>
                <div class="row-nw">
                    <div class="row-w col-xs-6">
                        <div class="border-b margin-b-10">
                            <span  class="text-subheader">1</span>
                            <input class="nobox-grey" type="text" name="attr-rasgo-1">
                        </div>
                        <div class="border-b">
                            <span class="text-subheader">2</span>
                            <input class="nobox-grey"  type="text" name="attr-rasgo-2">
                        </div>
                    </div>
                    <div class="row-w col-xs-6">
                        <div class="border-b margin-b-10">
                            <span class="text-subheader">3</span>
                            <input class="nobox-grey"  type="text" name="attr-rasgo-3">
                        </div>
                        <div class="border-b">
                            <span class="text-subheader">4</span>
                            <input class="nobox-grey"  type="text" name="attr-rasgo-4">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row-nw col-xs-4">
                <div class="column-w col-xs-6 content-center margin-r-15">
                    <span class="text-center text-subheader">DETERMINACIÓN<br>INICIAL</span>
                    <input class="border-circle" type="number" name="attr-determinacion">
                </div>
                <div class="column-w col-xs-6 content-center">
                    <span class="text-center text-subheader">ESPÍRITU<br>INICIAL</span>
                    <input class="border-circle" type="number" name="attr-espiritu">
                </div>
            </div>
        </div>
        <div class="row-w width-100 padding-t-35">
            <span class="text-subheader">NOTAS SOBRE LA HISTORIA:</span>
            <div class="height-100 width-100">
                <textarea class="nobox-grey" name="attr_descripcion"></textarea>
            </div>
        </div>
        <div class="row-w width-100 padding-t-35">
            <div class="row-nw width-100 content-center padding-t-15">
                <span class="padding-r-10 text-subheader">TIEMPO TRANSCURRIDO:</span>
                <input class="nobox-grey" type="number" name="attr-tiempo">
                <span class="padding-l-10 text-subheader">= MEDIA JORNADA</span>
            </div>
            <div class="row-nw width-100 content-center padding-t-15">
                <input class="checkbox-icon margin-r-6"  type="checkbox">
                <input class="checkbox-icon margin-r-15" type="checkbox">
                <input class="checkbox-icon margin-r-6" type="checkbox">
                <input class="checkbox-icon margin-r-15" type="checkbox">
                <input class="checkbox-icon margin-r-6" type="checkbox">
                <input class="checkbox-icon margin-r-15" type="checkbox">
                <input class="checkbox-icon margin-r-6" type="checkbox">
                <input class="checkbox-icon margin-r-15" type="checkbox">
                <input class="checkbox-icon margin-r-6" type="checkbox">
                <input class="checkbox-icon margin-r-15" type="checkbox">
                <input class="checkbox-icon margin-r-6" type="checkbox">
                <input class="checkbox-icon margin-r-15" type="checkbox">
                <input class="checkbox-icon margin-r-6" type="checkbox">
                <input class="checkbox-icon margin-r-15" type="checkbox">
                <input class="checkbox-icon margin-r-6" type="checkbox">
                <input class="checkbox-icon margin-r-15" type="checkbox">
                <input class="checkbox-icon margin-r-6" type="checkbox">
                <input class="checkbox-icon margin-r-6" type="checkbox">
            </div>
        </div>
    </div>
</div>





    <script type="text/worker">
        const buttonlist = ["personal","estadistica","inventario"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });
    
    const repeatingSum = (destination, section, fields, multiplier = 1) => {
        if (!Array.isArray(fields)) fields = [fields];
        getSectionIDs(`repeating_${section}`, idArray => {
            const attrArray = idArray.reduce( (m,id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))],[]);
            getAttrs(attrArray, v => {
                console.log("===== values of v: "+ JSON.stringify(v) +" =====");
                     // getValue: if not a number, returns 1 if it is 'on' (checkbox), otherwise returns 0..
                const getValue = (section, id,field) => parseFloat(v[`repeating_${section}_${id}_${field}`]) || (v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : 0); 
                const sumTotal = idArray.reduce((total, id) => total + fields.reduce((subtotal,field) => subtotal * getValue(section, id,field),1),0);
                setAttrs({[destination]: sumTotal * multiplier});    
            });
        });
    };

    on("change:repeating_proteccion remove:repeating_proteccion", function() {
        repeatingSum("blindaje","proteccion","modblindaje");
    });
    
  
    on("change:nivel_npc sheet:opened", function() {  
  getAttrs(["nivel_npc"], function(values) {
    let reaccion = parseInt(values.nivel_npc,10)||0;
    setAttrs({                            
      reaccion_npc: reaccion * 3
    });
  });  
 }); 
  
    on("change:detectar change:disparar change:luchar sheet:opened", function() {  
  getAttrs(["detectar","disparar","luchar"], function(values) {
    let detectar = parseInt(values.detectar,10)||0;
    let disparar = parseInt(values.disparar,10)||0;
    let luchar = parseInt(values.luchar,10)||0;
    setAttrs({                            
      reaccion: detectar + disparar + luchar
    });
  });
});
</script>

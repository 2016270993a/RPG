
<input type="hidden" name="attr_character_sheet" style="display: none;" value="TailsOfEquestria"/>
<div class="top"><img src="http://ninjadivision.com/wp-content/uploads/2017/02/MLP-Website-Header-900x325.jpg"/>
  <div class="mask"></div>
</div>
<div class="main-container">
  <div>
    <div class="bio">
      <div class="labelledUnderlined">
        <label>Pony Name:</label>
        <div class="inner">
          <input type="text" name="attr_character_name"/>
        </div>
      </div>
      <div class="labelledUnderlined">
        <label>Player Name:</label>
        <div class="inner">
          <input type="text" name="attr_player_name"/>
        </div>
      </div>
      <div class="labelledUnderlined">
        <label>Pony Type:</label>
        <div class="inner">
          <input type="text" name="attr_race"/>
        </div>
      </div>
      <div class="labelledUnderlined">
        <label>Level:</label>
        <div class="inner">
          <input type="number" name="attr_level"/>
        </div>
      </div>
      <div class="labelledUnderlined">
        <label>Element of Harmony:</label>
        <div class="inner">
          <select name="attr_elementOfHarmony">
            <option value="generosity">generosity</option>
            <option value="honesty">honesty</option>
            <option value="kindness">kindness</option>
            <option value="laughter">laughter</option>
            <option value="loyalty">loyalty</option>
            <option value="magic">magic</option>
            <option value="other">other</option>
          </select>
        </div>
      </div>
      <!--
      div.colors
        span.mane
          label Mane Color:
            +input('color', 'mane_color')
        span.coat
          label Coat Color:
            +input('color', 'coat_color')
      
      -->
    </div>
    <div class="friendshipTokens">
      <h1><span>F</span><span>R</span><span>I</span><span>E</span><span>N</span><span>D</span><span>S</span><span>H</span><span>I</span><span>P</span></h1>
      <input type="number" name="attr_friendshipTokens" value="0"/>
    </div>
  </div>
  <div>
    <div class="stamina">
      <h1>Stamina:</h1>
      <div class="fraction">
        <input type="number" name="attr_stamina"/><span>/</span>
        <input type="number" name="attr_stamina_max"/>
      </div>
    </div>
    <div class="traits">
      <div class="trait body">
        <label>Body</label>
        <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=body}} {{result=[[@{body}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}"></button>
        <select name="attr_body">
          <option value="null" selected="selected">Pick One</option>
          <option value="D4">D4</option>
          <option value="D6">D6</option>
          <option value="D8">D8</option>
          <option value="D10">D10</option>
          <option value="D12">D12</option>
          <option value="D20">D20</option>
          <option value="{D20,D4}k1">D20/D4</option>
          <option value="{D20,D6}k1">D20/D6</option>
          <option value="{D20,D8}k1">D20/D8</option>
          <option value="{D20,D10}k1">D20/D10</option>
          <option value="{D20,D12}k1">D20/D12</option>
          <option value="{D20,D20}k1">D20x2</option>
          <option value="{D20,D20,D4}k1">D20x2/D4</option>
          <option value="{D20,D20,D6}k1">D20x2/D6</option>
          <option value="{D20,D20,D8}k1">D20x2/D8</option>
          <option value="{D20,D20,D10}k1">D20x2/D10</option>
          <option value="{D20,D20,D12}k1">D20x2/D12</option>
          <option value="{D20,D20,D20}k1">D20x3</option>
        </select>
      </div>
      <div class="trait mind"> 
        <label>Mind</label>
        <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=mind}} {{result=[[@{mind}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}"></button>
        <select name="attr_mind">
          <option value="null" selected="selected">Pick One</option>
          <option value="D4">D4</option>
          <option value="D6">D6</option>
          <option value="D8">D8</option>
          <option value="D10">D10</option>
          <option value="D12">D12</option>
          <option value="D20">D20</option>
          <option value="{D20,D4}k1">D20/D4</option>
          <option value="{D20,D6}k1">D20/D6</option>
          <option value="{D20,D8}k1">D20/D8</option>
          <option value="{D20,D10}k1">D20/D10</option>
          <option value="{D20,D12}k1">D20/D12</option>
          <option value="{D20,D20}k1">D20x2</option>
          <option value="{D20,D20,D4}k1">D20x2/D4</option>
          <option value="{D20,D20,D6}k1">D20x2/D6</option>
          <option value="{D20,D20,D8}k1">D20x2/D8</option>
          <option value="{D20,D20,D10}k1">D20x2/D10</option>
          <option value="{D20,D20,D12}k1">D20x2/D12</option>
          <option value="{D20,D20,D20}k1">D20x3</option>
        </select>
      </div>
      <div class="trait charm">
        <label>Charm</label>
        <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=charm}} {{result=[[@{charm}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}"></button>
        <select name="attr_charm">
          <option value="null" selected="selected">Pick One</option>
          <option value="D4">D4</option>
          <option value="D6">D6</option>
          <option value="D8">D8</option>
          <option value="D10">D10</option>
          <option value="D12">D12</option>
          <option value="D20">D20</option>
          <option value="{D20,D4}k1">D20/D4</option>
          <option value="{D20,D6}k1">D20/D6</option>
          <option value="{D20,D8}k1">D20/D8</option>
          <option value="{D20,D10}k1">D20/D10</option>
          <option value="{D20,D12}k1">D20/D12</option>
          <option value="{D20,D20}k1">D20x2</option>
          <option value="{D20,D20,D4}k1">D20x2/D4</option>
          <option value="{D20,D20,D6}k1">D20x2/D6</option>
          <option value="{D20,D20,D8}k1">D20x2/D8</option>
          <option value="{D20,D20,D10}k1">D20x2/D10</option>
          <option value="{D20,D20,D12}k1">D20x2/D12</option>
          <option value="{D20,D20,D20}k1">D20x3</option>
        </select>
      </div>
    </div>
  </div>
  <div class="explodingHooves">
    <h1>Exploding Hoof Dice:</h1>
    <div class="explodingHoof">
      <input type="hidden" name="attr_exploding_hoof_d4" style="display: none;" value="{1d3, floor(1d4/4)*{{0} + 4, 1d5, floor(1d6/6)*{{0} + 6, 1d7, floor(1d8/8)*{{0} + 8, 1d9, floor(1d10/10)*{{0} + 10, 1d11, floor(1d12/12)*{{0} + 12, 1d20}k1}k1}k1}k1}k1}k1"/>
      <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=exploding_hoof_d4}} {{result=[[@{exploding_hoof_d4}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}"></button>
    </div>
    <div class="explodingHoof">
      <input type="hidden" name="attr_exploding_hoof_d6" style="display: none;" value="{1d5, floor(1d6/6)*{{0} + 6, 1d7, floor(1d8/8)*{{0} + 8, 1d9, floor(1d10/10)*{{0} + 10, 1d11, floor(1d12/12)*{{0} + 12, 1d20}k1}k1}k1}k1}k1"/>
      <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=exploding_hoof_d6}} {{result=[[@{exploding_hoof_d6}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}"></button>
    </div>
    <div class="explodingHoof">
      <input type="hidden" name="attr_exploding_hoof_d8" style="display: none;" value="{1d7, floor(1d8/8)*{{0} + 8, 1d9, floor(1d10/10)*{{0} + 10, 1d11, floor(1d12/12)*{{0} + 12, 1d20}k1}k1}k1}k1"/>
      <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=exploding_hoof_d8}} {{result=[[@{exploding_hoof_d8}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}"></button>
    </div>
    <div class="explodingHoof">
      <input type="hidden" name="attr_exploding_hoof_d10" style="display: none;" value="{1d9, floor(1d10/10)*{{0} + 10, 1d11, floor(1d12/12)*{{0} + 12, 1d20}k1}k1}k1"/>
      <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=exploding_hoof_d10}} {{result=[[@{exploding_hoof_d10}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}"></button>
    </div>
    <div class="explodingHoof">
      <input type="hidden" name="attr_exploding_hoof_d12" style="display: none;" value="{1d11, floor(1d12/12)*{{0} + 12, 1d20}k1}k1"/>
      <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=exploding_hoof_d12}} {{result=[[@{exploding_hoof_d12}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}"></button>
    </div>
  </div>
  <div>
    <div class="talents">
      <h1>Talents:</h1>
            <div class="talent isCutieMark">
              <label>Cutie Mark:</label>
              <!-- button(type='roll', value='&{template:toe} {{charName=@{character_name}}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}} {{attr=@{' + prefix + 'name}}} {{result=[[@{' + prefix + 'equation}]]}} {{notes=@{' + prefix + 'notes}}} {{upgrade=@{' + prefix + 'upgrade}}} {{downgrade=@{' + prefix + 'downgrade}}}')-->
              <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=@{talent_cutieMark_name}}} {{result=[[@{talent_cutieMark_equation}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}{{notes=@{talent_cutieMark_notes}}}{{upgrade=@{talent_cutieMark_upgrade}}}{{downgrade=@{talent_cutieMark_downgrade}}}"></button>
              <div class="labelledUnderlined">
                <label></label>
                <div class="inner">
                  <input type="text" name="attr_talent_cutieMark_name"/>
                </div>
              </div>
              <div class="labelledUnderlined">
                <label>Dice:</label>
                <div class="inner">
                  <select name="attr_talent_cutieMark_dice">
                    <option value="null" selected="selected">Pick One</option>
                    <option value="D4">D4</option>
                    <option value="D6">D6</option>
                    <option value="D8">D8</option>
                    <option value="D10">D10</option>
                    <option value="D12">D12</option>
                    <option value="D20">D20</option>
                    <option value="{D20,D4}k1">D20/D4</option>
                    <option value="{D20,D6}k1">D20/D6</option>
                    <option value="{D20,D8}k1">D20/D8</option>
                    <option value="{D20,D10}k1">D20/D10</option>
                    <option value="{D20,D12}k1">D20/D12</option>
                    <option value="{D20,D20}k1">D20x2</option>
                    <option value="{D20,D20,D4}k1">D20x2/D4</option>
                    <option value="{D20,D20,D6}k1">D20x2/D6</option>
                    <option value="{D20,D20,D8}k1">D20x2/D8</option>
                    <option value="{D20,D20,D10}k1">D20x2/D10</option>
                    <option value="{D20,D20,D12}k1">D20x2/D12</option>
                    <option value="{D20,D20,D20}k1">D20x3</option>
                  </select>
                </div>
              </div>
              <div class="labelledUnderlined">
                <label>Trait</label>
                <div class="inner">
                  <select name="attr_talent_cutieMark_trait">
                    <option value="null" selected="selected">none</option>
                    <option value="body">body</option>
                    <option value="mind">mind</option>
                    <option value="charm">charm</option>
                  </select>
                </div>
              </div>
              <div class="labelledUnderlined" style="width: 0.5in;">
                <label>Upgrade Steps</label>
                <div class="inner">
                  <input type="number" name="attr_talent_cutieMark_upgrade"/>
                </div>
              </div>
              <div class="labelledUnderlined" style="width: 0.6in;">
                <label>Downgrade Steps</label>
                <div class="inner">
                  <input type="number" name="attr_talent_cutieMark_downgrade"/>
                </div>
              </div>
              <div class="labelledUnderlined" style="width: 2in;">
                <label>Notes:</label>
                <div class="inner">
                  <input type="text" name="attr_talent_cutieMark_notes"/>
                </div>
              </div>
              <input type="hidden" name="attr_talent_cutieMark_equation"/>
            </div>
            <div class="talent">
              <label>Racial:</label>
              <!-- button(type='roll', value='&{template:toe} {{charName=@{character_name}}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}} {{attr=@{' + prefix + 'name}}} {{result=[[@{' + prefix + 'equation}]]}} {{notes=@{' + prefix + 'notes}}} {{upgrade=@{' + prefix + 'upgrade}}} {{downgrade=@{' + prefix + 'downgrade}}}')-->
              <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=@{talent_racial_name}}} {{result=[[@{talent_racial_equation}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}{{notes=@{talent_racial_notes}}}{{upgrade=@{talent_racial_upgrade}}}{{downgrade=@{talent_racial_downgrade}}}"></button>
              <div class="labelledUnderlined">
                <label></label>
                <div class="inner">
                  <input type="text" name="attr_talent_racial_name"/>
                </div>
              </div>
              <div class="labelledUnderlined">
                <label>Dice:</label>
                <div class="inner">
                  <select name="attr_talent_racial_dice">
                    <option value="null" selected="selected">Pick One</option>
                    <option value="D4">D4</option>
                    <option value="D6">D6</option>
                    <option value="D8">D8</option>
                    <option value="D10">D10</option>
                    <option value="D12">D12</option>
                    <option value="D20">D20</option>
                    <option value="{D20,D4}k1">D20/D4</option>
                    <option value="{D20,D6}k1">D20/D6</option>
                    <option value="{D20,D8}k1">D20/D8</option>
                    <option value="{D20,D10}k1">D20/D10</option>
                    <option value="{D20,D12}k1">D20/D12</option>
                    <option value="{D20,D20}k1">D20x2</option>
                    <option value="{D20,D20,D4}k1">D20x2/D4</option>
                    <option value="{D20,D20,D6}k1">D20x2/D6</option>
                    <option value="{D20,D20,D8}k1">D20x2/D8</option>
                    <option value="{D20,D20,D10}k1">D20x2/D10</option>
                    <option value="{D20,D20,D12}k1">D20x2/D12</option>
                    <option value="{D20,D20,D20}k1">D20x3</option>
                  </select>
                </div>
              </div>
              <div class="labelledUnderlined">
                <label>Trait</label>
                <div class="inner">
                  <select name="attr_talent_racial_trait">
                    <option value="null" selected="selected">none</option>
                    <option value="body">body</option>
                    <option value="mind">mind</option>
                    <option value="charm">charm</option>
                  </select>
                </div>
              </div>
              <div class="labelledUnderlined" style="width: 0.5in;">
                <label>Upgrade Steps</label>
                <div class="inner">
                  <input type="number" name="attr_talent_racial_upgrade"/>
                </div>
              </div>
              <div class="labelledUnderlined" style="width: 0.6in;">
                <label>Downgrade Steps</label>
                <div class="inner">
                  <input type="number" name="attr_talent_racial_downgrade"/>
                </div>
              </div>
              <div class="labelledUnderlined" style="width: 2in;">
                <label>Notes:</label>
                <div class="inner">
                  <input type="text" name="attr_talent_racial_notes"/>
                </div>
              </div>
              <input type="hidden" name="attr_talent_racial_equation"/>
            </div>
      <fieldset class="repeating_talents">
              <div class="talent">
                <label>T:</label>
                <!-- button(type='roll', value='&{template:toe} {{charName=@{character_name}}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}} {{attr=@{' + prefix + 'name}}} {{result=[[@{' + prefix + 'equation}]]}} {{notes=@{' + prefix + 'notes}}} {{upgrade=@{' + prefix + 'upgrade}}} {{downgrade=@{' + prefix + 'downgrade}}}')-->
                <button type="roll" value="&amp;{template:toe} {{charName=@{character_name}}} {{attr=@{name}}} {{result=[[@{equation}]]}} {{maneColor=@{mane_color}}} {{coatColor=@{coat_color}}}{{notes=@{notes}}}{{upgrade=@{upgrade}}}{{downgrade=@{downgrade}}}"></button>
                <div class="labelledUnderlined">
                  <label></label>
                  <div class="inner">
                    <input type="text" name="attr_name"/>
                  </div>
                </div>
                <div class="labelledUnderlined">
                  <label>Dice:</label>
                  <div class="inner">
                    <select name="attr_dice">
                      <option value="null" selected="selected">Pick One</option>
                      <option value="D4">D4</option>
                      <option value="D6">D6</option>
                      <option value="D8">D8</option>
                      <option value="D10">D10</option>
                      <option value="D12">D12</option>
                      <option value="D20">D20</option>
                      <option value="{D20,D4}k1">D20/D4</option>
                      <option value="{D20,D6}k1">D20/D6</option>
                      <option value="{D20,D8}k1">D20/D8</option>
                      <option value="{D20,D10}k1">D20/D10</option>
                      <option value="{D20,D12}k1">D20/D12</option>
                      <option value="{D20,D20}k1">D20x2</option>
                      <option value="{D20,D20,D4}k1">D20x2/D4</option>
                      <option value="{D20,D20,D6}k1">D20x2/D6</option>
                      <option value="{D20,D20,D8}k1">D20x2/D8</option>
                      <option value="{D20,D20,D10}k1">D20x2/D10</option>
                      <option value="{D20,D20,D12}k1">D20x2/D12</option>
                      <option value="{D20,D20,D20}k1">D20x3</option>
                    </select>
                  </div>
                </div>
                <div class="labelledUnderlined">
                  <label>Trait</label>
                  <div class="inner">
                    <select name="attr_trait">
                      <option value="null" selected="selected">none</option>
                      <option value="body">body</option>
                      <option value="mind">mind</option>
                      <option value="charm">charm</option>
                    </select>
                  </div>
                </div>
                <div class="labelledUnderlined" style="width: 0.5in;">
                  <label>Upgrade Steps</label>
                  <div class="inner">
                    <input type="number" name="attr_upgrade"/>
                  </div>
                </div>
                <div class="labelledUnderlined" style="width: 0.6in;">
                  <label>Downgrade Steps</label>
                  <div class="inner">
                    <input type="number" name="attr_downgrade"/>
                  </div>
                </div>
                <div class="labelledUnderlined" style="width: 2in;">
                  <label>Notes:</label>
                  <div class="inner">
                    <input type="text" name="attr_notes"/>
                  </div>
                </div>
                <input type="hidden" name="attr_equation"/>
              </div>
      </fieldset>
    </div>
  </div>
  <div>
    <div class="quirks">
      <h1>Quirks:</h1>
            <div class="quirk quirkMain">
              <label>Main:</label>
              <div class="labelledUnderlined">
                <label></label>
                <div class="inner">
                  <input type="text" name="attr_quirk_main_name"/>
                </div>
              </div>
              <div class="labelledUnderlined">
                <label>Notes</label>
                <div class="inner">
                  <input type="text" name="attr_quirk_main_notes"/>
                </div>
              </div>
            </div>
      <fieldset class="repeating_quirks">
              <div class="quirk">
                <label>Q:</label>
                <div class="labelledUnderlined">
                  <label></label>
                  <div class="inner">
                    <input type="text" name="attr_name"/>
                  </div>
                </div>
                <div class="labelledUnderlined">
                  <label>Notes</label>
                  <div class="inner">
                    <input type="text" name="attr_notes"/>
                  </div>
                </div>
              </div>
      </fieldset>
    </div>
  </div>
  <div>
    <div class="inlineBlock" style="margin-right: 1em; vertical-align: top; width: 48%;">
      <h1>Equipment:</h1>
      <textarea name="attr_equipment" style="height: 4in;"></textarea>
    </div>
    <div class="inlineBlock" style="width: 48%;">
      <h1>Appearance/Cutie Mark:</h1>
      <textarea name="attr_appearance"></textarea>
      <h1>Campaign Notes:</h1>
      <textarea name="attr_campaignNotes"></textarea>
    </div>
  </div>
</div>
<script type="text/worker">/**
 * Forces an update on a list of numerical fields, also making sure that
 * any undefined fields are set to 0.
 * @param {string[]} attrs
 * @param {function} cb
 */
function forceUpdate(attrs, cb) {
  parseAttrs(attrs, values => {
    let tempValues = {};
    _.each(attrs, attr => {
      tempValues[attr] = -9999;
    });
    setAttrs(tempValues);
    setAttrs(values);
  });
}

var rollSteps = [
  'D4',
  'D6',
  'D8',
  'D10',
  'D12',
  'D20',
  '{D20,D4}k1',
  '{D20,D6}k1',
  '{D20,D8}k1',
  '{D20,D10}k1',
  '{D20,D12}k1',
  '{D20,D20}k1',
  '{D20,D20,D4}k1',
  '{D20,D20,D6}k1',
  '{D20,D20,D8}k1',
  '{D20,D20,D10}k1',
  '{D20,D20,D12}k1',
  '{D20,D20,D20}k1'
];

/**
 * Gets the upgraded/downgraded dice for a roll.
 * @param {string} roll
 *        The roll expression.
 * @param {int} steps
 *        Positive for upgrade, negative for downgrade.
 */
function getUpDowngradedRoll(roll, steps) {
  let index = rollSteps.indexOf(roll) + steps;
  index = Math.max(0, Math.min(index, rollSteps.length-1));
  return rollSteps[index];
}

function onChange(attrs, cb) {
  attrs = _.map(attrs, attr => {
    return 'change:' + attr;
  }).join(' ');
  on(attrs, cb);
}

function onChangeParse(attrs, cb) {
  onChange(attrs, () => {
    parseAttrs(attrs, cb);
  });
}

/**
 * Gets the specified attributes and parses them as an integer or 0.
 */
function parseAttrs(attrs, cb) {
  getAttrs(attrs, function(values) {
    _.each(attrs, function(attr) {
      if(_.isUndefined(values[attr]))
        values[attr] = 0;
      else if(!isNaN(values[attr]))
        values[attr] = parseInt(values[attr]);
    });
    cb(values);
  });
}

function updateCutieMarkTalent() {
  var prefix = 'talent_cutieMark';
  _updateTalents(prefix);
}

function updateRacialTalent() {
  var prefix = 'talent_racial';
  _updateTalents(prefix);
}

function updateTalents() {
  updateCutieMarkTalent();
  updateRacialTalent();

  getSectionIDs('repeating_talents', ids => {
    _.each(ids, id => {
      var prefix = 'repeating_talents_' + id;
      _updateTalents(prefix);
    });
  });
}

function _updateTalents(prefix) {
  parseAttrs([prefix + '_dice', prefix + '_trait', prefix + '_upgrade', prefix + '_downgrade', 'body', 'mind', 'charm'], values => {
    var talentDice = values[prefix + '_dice'];

    var trait = values[prefix + '_trait'];
    var traitDice = values[trait] || 'D0';

    var upgrade = values[prefix + '_upgrade'] || 0;
    var downgrade = values[prefix + '_downgrade'] || 0;
    var updownSum = parseInt(upgrade) - parseInt(downgrade);

    // Apply upgrades/downgrades to talent dice.
    if(talentDice && updownSum)
      talentDice = getUpDowngradedRoll(talentDice, updownSum);
    if(traitDice && traitDice !== '0' && updownSum)
      traitDice = getUpDowngradedRoll(traitDice, updownSum);

    if(talentDice === 'null')
      setAttrs({
        [prefix + '_equation']: 0
      });
    else {
      //var traitDice = values[trait];
      setAttrs({
        [prefix + '_equation']: `{${talentDice},${traitDice}}k1`
      });
    }
  });
}

// Change events

on('change:repeating_talents', evt => {
  updateTalents();
});

onChange(['talent_cutieMark_dice', 'talent_cutieMark_trait', 'talent_cutieMark_upgrade', 'talent_cutieMark_upgrade', 'talent_cutieMark_downgrade'], () => {
  updateCutieMarkTalent();
});

onChange(['talent_racial_dice', 'talent_racial_trait', 'talent_racial_upgrade', 'talent_racial_upgrade', 'talent_racial_downgrade'], () => {
  updateRacialTalent();
});

onChange(['body', 'mind', 'charm'], () => {
  updateTalents();
});

on('sheet:opened', () => {
  setAttrs({
    character_sheet: 'TailsOfEquestria v1.2'
  });
  updateTalents();
});

</script>
<rolltemplate class="sheet-rolltemplate-toe">
  <table>
    <thead>
      <tr>
        <th>{{charName}} &#x21D2; {{attr}}</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Result {{result}}</td>
      </tr>{{#upgrade}}
      <tr>
        <td class="upgrade"><span>Upgrade:</span><span>{{upgrade}}</span></td>
      </tr>
      {{/upgrade}}
      {{#downgrade}}
      <tr>
        <td class="downgrade"><span>Downgrade:</span><span>{{downgrade}}</span></td>
      </tr>
      {{/downgrade}}
      {{#notes}}
      <tr>
        <td class="notes">
          <div>Notes:</div>
          <div>{{notes}}</div>
        </td>
      </tr>{{/notes}}
    </tbody>
  </table>
</rolltemplate>
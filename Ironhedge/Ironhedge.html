<div class="sheet-wrapper">
  <div class="sheet-header1">
    <div class="sheet-input-group sheet-input-group-char-name">
      <div class="sheet-lbl1 sheet-char-name">Character Name:</div>
      <input type="text" name="attr_character_name"
             class="sheet-header1-input"
             style="height: 30px;"
             placeholder="need a name" >
    </div>
    <div class="sheet-input-group sheet-input-group-type">
      <span class="sheet-lbl1">Type:</span>
      <select class="sheet-select sheet-select-type"
              name="attr_char_type">
        <option value="F">Fighter</option>
        <option value="T">Thief</option>
        <option value="M">Magician</option>
        <option value="A">Alchemist</option>
        <option value="P">Priest</option>
      </select>
    </div>
    <div class="sheet-input-group sheet-input-group-race">
      <span class="sheet-lbl1">Race:</span>
      <select name="attr_char_race" id="select_char_race"
              class="sheet-select">
        <option value="M">Man</option>
        <option value="D">Dwarf</option>
        <option value="E">Elf</option>
      </select>
    </div>
  </div>
  <div class="sheet-tab-area">
    <input type="radio" class="sheet-tab sheet-tab1"
           name="attr_core-tab" value="1" id="tab1"
           title="Stats" checked="checked"/>
    <label class="sheet-tab sheet-tab1" for="tab1"
           style='line-height: 20px;'>
      Stats</label>

    <input type="radio" class="sheet-tab sheet-tab2"
           name="attr_core-tab" value="2" id="tab2"
           title="Equipment/Notes" />
    <label class="sheet-tab sheet-tab2"
           for="tab2"
           style='line-height: 20px;'>
      Equipment / Notes</label>

    <input type="radio" class="sheet-tab sheet-tab3"
           name="attr_core-tab" value="3" id="tab3"
           title="Experience" />
    <label class="sheet-tab sheet-tab3"
           for="tab3"
           style='line-height: 20px;'>
      Experience</label>

    <!--  ====== Stats panel view  =======  -->
    <div class="sheet-tab-view1 sheet-tab-view">
      <div class="sheet-stats-panel-view">
        <div class="sheet-flexr sheet-jcsa sheet-stats-tlquad">
          <div class="sheet-flexc sheet-jcfs sheet-panel-col">
            <div class="sheet-input-group2">
              <div class="sheet-lbl2">Strength:</div>
              <input type="text" class="sheet-input2" name="attr_char_str">
            </div>

            <div class="sheet-input-group2">
              <div class="sheet-lbl2">Intelligence:</div>
              <input type="text" class="sheet-input2" name="attr_char_int">
            </div>

            <div class="sheet-input-group2">
              <div class="sheet-lbl2">Dexterity:</div>
              <input type="text" class="sheet-input2" name="attr_char_dex">
            </div>

            <div class="sheet-input-group2">
              <div class="sheet-lbl2">Attack Lvl:</div>
              <input type="text" class="sheet-input2" name="attr_attacklvl">
            </div>

            <div class="sheet-input-group2">
              <div class="sheet-lbl2">#of Attacks:</div>
              <input type="text" class="sheet-input2" name="attr_numattacks">
            </div>

            <div class="sheet-row-spacer"></div>

            <div class="sheet-flexr sheet-jcc" style="margin-top: 5px;">
              <span class="sheet-info-col-lbl">Tactics:</span>
              <input type="checkbox" name="attr_tactics"
                     class="sheet-cb-tactics">
            </div>



            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl">On a horse?:</span>
              <input type="checkbox" name="attr_onhorse"
                     class="sheet-cb-onhorse">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl">Higher ground?:</span>
              <input type="checkbox" name="attr_higherground"
                     class="sheet-cb-higherground">
            </div>

          </div>

          <div class="sheet-flexc sheet-jcfs sheet-panel-col">
            <div class="sheet-col-header">
              Life Points
            </div>
            <div class="sheet-flexr sheet-jcc">
              <span class="">Base</span>
              <input class="sheet-perm-value sheet-input2"
                     name="attr_base_lp" readonly/>
            </div>
            <div class="sheet-flexr sheet-jcc">
              <div class="sheet-flexc sheet-jcfs">
                <input type="text" name="attr_lp"
                       class="sheet-input-lp">
                <input type="hidden" name="attr_lp_max">
              </div>
              <div class="sheet-flexc sheet-jcsa">
                <button type="action" name="act_lpadd"
                        class="sheet-btns-lp">
                  <span class="sheet-btn-lp-add sheet-btn-up">{</span>
                </button>
                <button type="action" name="act_lpminus"
                        class="sheet-btns-lp ">
                  <span class="sheet-btn-lp-minus sheet-btn-down">}</span>
                </button>
              </div>
            </div>



          </div>

          <div class="sheet-flexc sheet-jcfs sheet-panel-col">

            <div class="sheet-col-header">
              Brawl Strength
            </div>
            <div class="sheet-flexr sheet-jcc">
              <span class="">Base</span>
              <input type="text" name="attr_base_bs"
                     class="sheet-perm-value sheet-input2"
                     readonly>
            </div>
            <div class="sheet-flexr sheet-jcc">
              <div class="sheet-flexc sheet-jcfs">
                <input type="text" name="attr_bs"
                       class="sheet-input-bs sheet-input-bs">
                <input type="hidden" name="attr_bs_max">
              </div>
              <div class="sheet-flexc sheet-jcsa">
                <button type="action" name="act_bsadd"
                        class="sheet-btns-bs">
                  <span class="sheet-btn-bs-add sheet-btn-up">{</span>
                </button>
                <button type="action" name="act_bsminus"
                        class="sheet-btns-bs">
                  <span class="sheet-btn-down sheet-btn-bs-minus">}</span>
                </button>
              </div>
            </div>

            <div class="sheet-row-spacer"></div>

            <div class="sheet-col-header"
                 style="margin-top: 5px;">
              Run Speeds
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl-sm"
                    style="">Full Load:</span>
              <input type="text" name="attr_full_load"
                     class="sheet-perm-value sheet-input2-sm" readonly >
              <span class="sheet-info-col-lbl-sm"
                    style="">lbs</span>
              <input type="hidden" name="attr_run_idx">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl-sm"
                    style="">Load:</span>
              <select name="attr_load_cat" id="select_load_cat"
                      class="sheet-select-load-cat">
                <option value="no">No</option>
                <option value="half">Half</option>
                <option value="full">Full</option>
              </select>
            </div>
            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl-sm"
                    style="">Max run:</span>
              <input type="text" name="attr_max_run"
                     class="sheet-perm-value sheet-input2-sm" readonly>
              <span class="sheet-info-col-lbl-sm"
                    style="">mph</span>
            </div>
          </div>
        </div>  <!--  end tlquad   -->

        <div class="sheet-flexr sheet-jcsa sheet-stats-trquad">
          <div class="sheet-flexc sheet-jcfs sheet-col-money">
            <div class="sheet-col-header">
              Money
            </div>
<!--  ================== copper =================  -->
            <div class="sheet-flexr sheet-jcc">
              <input type="text" name="attr_copper"
                     class="sheet-input-dotted">
              <span class="sheet-money-col-lbl">c</span>
            </div>
<!--  ================== silver =================  -->
            <div class="sheet-flexr sheet-jcc">
              <input type="text" name="attr_silver"
                     class="sheet-input-dotted">
              <span class="sheet-money-col-lbl">s</span>
            </div>
<!--  ================== gold =================  -->
            <div class="sheet-flexr sheet-jcc">
              <input type="text" name="attr_gold"
                     class="sheet-input-dotted">
              <span class="sheet-money-col-lbl">g</span>
            </div>
<!--  ================== mythril =================  -->
            <div class="sheet-flexr sheet-jcc">
              <input type="text" name="attr_mythril"
                     class="sheet-input-dotted">
              <span class="sheet-money-col-lbl">m</span>
            </div>

            <div class="sheet-row-spacer"></div>

            <div class="sheet-flexr sheet-jcc">
              <input type="text" name="attr_magicpoints"
                     class="sheet-input-dotted">
              <span class="sheet-money-col-lbl">mp</span>
            </div>
            <div class="sheet-flexr sheet-jcc">
              <input type="text" name="attr_ingredients"
                     class="sheet-input-dotted">
              <span class="sheet-money-col-lbl">ingredients</span>
            </div>
          </div> <!-- end col money -->

          <div class="sheet-flexc sheet-jcfs sheet-col-info1">
            <div class="sheet-col-header">
              General Info
            </div>
            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl">Born in:</span>
              <input type="text" name="attr_city_born"
                     class="sheet-input-dotted">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl">Home:</span>
              <input type="text" name="attr_city_home"
                     class="sheet-input-dotted">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl">City in:</span>
              <input type="text" name="attr_city_in"
                     class="sheet-input-dotted">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl">Date:</span>
              <input type="text" name="attr_game_date"
                     class="sheet-input-dotted">
            </div>

            <div class="sheet-row-spacer"></div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl">Resurected?:</span>
              <input type="checkbox" name="attr_resurected"
                     class="sheet-cb-resurected">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl">Holy Book?:</span>
              <input type="checkbox" name="attr_holybook"
                     class="sheet-cb-holybook">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl">Silver Cross?:</span>
              <input type="checkbox" name="attr_silver_cross"
                     class="sheet-cb-silvercross">
            </div>

          </div>
        </div>  <!-- end trquad -->

        <div class="sheet-flexr sheet-jcsa sheet-stats-blquad">
          <div class="sheet-flexc sheet-jcfs sheet-col-hth">
            <div class="sheet-lbl3">Hand to Hand Combat</div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl-hth">Attack Factor:</span>

              <input type="text" name="attr_af"
                     class="sheet-input-dotted-hth">
              <input type="hidden" name="attr_af_plus">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl-hth">Defense Factor:</span>

              <input type="text" name="attr_df"
                     class="sheet-input-dotted-hth">
              <input type="hidden" name="attr_df_plus">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl-hth">Amor Type:</span>

              <input type="text" name="attr_ar"
                     class="sheet-input-dotted-hth">
              <input type="hidden" name="attr_ar_plus">
            </div>

          </div>

          <div class="sheet-flexc sheet-jcfs sheet-col-slaying">
            <div class="sheet-col-header">
              Weapon
            </div>
            <div class="sheet-col-header">
              Slaying Types
            </div>
            <!--  Slaying types row 1  -->
            <div class="sheet-flexr sheet-jcsa">
              <div class="sheet-flexr sheet-jcfs">
                <span class="sheet-col-lbl-slay">Me</span>
                <input type="checkbox" name="attr_slay_men"
                       class="sheet-cb-slaying">
              </div>

              <div class="sheet-flexr sheet-jcfs">
                <span class="sheet-col-lbl-slay">Dw</span>
                <input type="checkbox" name="attr_slay_dwarf"
                       class="sheet-cb-slaying">
              </div>

              <div class="sheet-flexr sheet-jcfs">
                <span class="sheet-col-lbl-slay">Ef</span>
                <input type="checkbox" name="attr_slay_elf"
                       class="sheet-cb-slaying">
              </div>
            </div>
            <!--  Slaying types row 2  -->
            <div class="sheet-flexr sheet-jcsa">
              <div class="sheet-flexr sheet-jcfs">
                <span class="sheet-col-lbl-slay">Ok</span>
                <input type="checkbox" name="attr_slay_ork"
                       class="sheet-cb-slaying">
              </div>

              <div class="sheet-flexr sheet-jcfs">
                <span class="sheet-col-lbl-slay">Gi</span>
                <input type="checkbox" name="attr_slay_giant"
                       class="sheet-cb-slaying">
              </div>

              <div class="sheet-flexr sheet-jcfs">
                <span class="sheet-col-lbl-slay">Dr</span>
                <input type="checkbox" name="attr_slay_dragon"
                       class="sheet-cb-slaying">
              </div>
            </div>
          </div>


        </div>  <!-- end blquad -->

        <div class="sheet-flexr sheet-jcsa sheet-stats-brquad">

          <div class="sheet-flexc sheet-jcfs sheet-col-mth">
            <div class="sheet-lbl3">Missile</div>
            <div class="sheet-lbl3">to Hit#'s</div>
            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl-mth">Short:</span>

              <input type="text" name="attr_mth_short"
                     class="sheet-input-dotted-mth">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl-mth">Medium:</span>

              <input type="text" name="attr_mth_medium"
                     class="sheet-input-dotted-mth">
            </div>

            <div class="sheet-flexr sheet-jcc">
              <span class="sheet-info-col-lbl-mth">Long:</span>

              <input type="text" name="attr_mth_long"
                     class="sheet-input-dotted-mth">
            </div>

            <div class="sheet-flexr sheet-jcc" style="margin-top: 5px;">
              <span class="sheet-info-col-lbl">Armorments?:</span>
              <input type="checkbox" name="attr_armorments"
                     class="sheet-cb-armorments">
            </div>

          </div>

          <div class="sheet-flexc sheet-jcfs sheet-col-saving">
            <div class="sheet-lbl3">Saving Roll vs:</div>
              <div class="sheet-flexr sheet-jcsb">
                <div class="sheet-flexc sheet-jcfs sheet-col-luckycharms">
                  <div class="sheet-flexr sheet-jcc" style="">
                    <span class="sheet-lc-col-lbl">4Lc:</span>
                    <input type="checkbox" name="attr_lc_4lc"
                           class="sheet-cb-luckycharm">
                  </div>

                  <div class="sheet-flexr sheet-jcc" style="">
                    <span class="sheet-lc-col-lbl">Dto:</span>
                    <input type="checkbox" name="attr_lc_dto"
                           class="sheet-cb-luckycharm">
                  </div>

                  <div class="sheet-flexr sheet-jcc" style="">
                    <span class="sheet-lc-col-lbl">Moo:</span>
                    <input type="checkbox" name="attr_lc_moo"
                           class="sheet-cb-luckycharm">
                  </div>

                  <div class="sheet-flexr sheet-jcc" style="">
                    <span class="sheet-lc-col-lbl">Lod:</span>
                    <input type="checkbox" name="attr_lc_lod"
                           class="sheet-cb-armorments">
                  </div>
                </div>
                <div class="sheet-flexc sheet-jcfs sheet-col-lcbonus"
                     style="margin-left: 5px;">
                  <div class="sheet-flexr sheet-jcfe">
                    <span class="sheet-col-header">SPELL:</span>

                    <input type="text" name="attr_sv_spell"
                           class="sheet-input-dotted-save">
                  </div>

                  <div class="sheet-flexr sheet-jcfe">
                    <span class="sheet-col-header">THIEF:</span>

                    <input type="text" name="attr_sv_thief"
                           class="sheet-input-dotted-save">
                  </div>

                  <div class="sheet-flexr sheet-jcfe">
                    <span class="sheet-col-header">POISON:</span>

                    <input type="text" name="attr_sv_poison"
                           class="sheet-input-dotted-save">
                  </div>

                  <div class="sheet-flexr sheet-jcfe">
                    <span class="sheet-lc-col-lbl">Immune?#</span>

                    <input type="text" name="attr_sv_immune"
                           class="sheet-input-dotted-save">
                  </div>
                </div>  <!--  col lc bonus  -->

              </div>
                <div class="sheet-flexr sheet-jcfe">
                  <div class="sheet-flexr sheet-jcfe">
                    <span class="sheet-col-header">EXPOSURE:</span>

                    <input type="text" name="attr_sv_exposure"
                           class="sheet-input-dotted-save">
                  </div>
                </div>
              </div>


        </div>  <!-- end brquad -->

        </div> <!-- end stats panel view -->
    </div>  <!-- end tab view -->

    <!--   ====== Equipment panel view  =======  -->
    <div class="sheet-tab-view2 sheet-tab-view">
      Equipment panel
    </div>  <!-- end Equipment tab view -->

    <!--  ===== Experience panel view  ======  -->
    <div class="sheet-tab-view3 sheet-tab-view">
      <div class="sheet-experience-panel-view">
        <div class="sheet-flexr flex-jcsb sheet-exp-gtop">
          <div class="sheet-flexr sheet-jcsa sheet-fighter-thief-box">
            <!--  Fighter & Thief experience column   -->
            <div class="sheet-flexc sheet-jcsb sheet-fighter-thief-exp-box">
              <!--  Fighter experience box   -->
              <div class="sheet-flexc sheet-jcfs sheet-col-fighter-exp"
                   id="col-fighter-exp">
                <div class="sheet-flexr sheet-jcfs">
                  <span class="sheet-lbl3">Fighter:</span>
                  <span class="sheet-lbl1">EL:</span>
                  <span class="sheet-val-lg" name="attr_el_fighter"
                        value="1">
                  </span>
                </div>
                <div class="sheet-lbl2">EP's:</div>
                <input type="number" class="sheet-input-eps" name="attr_ep_fighter">
              </div>

              <!--  Thief experience box   -->
              <div class="sheet-flexc sheet-jcfs sheet-col-thief-exp"
                   id="col-thief-exp">
                <div class="sheet-flexr sheet-jcfs">
                  <span class="sheet-lbl3">Thief:</span>
                  <span class="sheet-lbl1">EL:</span>
                  <span class="sheet-val-lg" name="attr_el_thief"
                        value="1"></span>
                </div>
                <div class="sheet-lbl2">EP's:</div>
                <input type="number" class="sheet-input-eps" name="attr_ep_thief">
              </div>
            </div>  <!-- end Fighter Thief experience box -->

            <!--  Thief skills box   -->
            <div class="sheet-flexc sheet-jcfe sheet-thief-skills-box"
                 style="padding-left: 5px;">
              <div class="sheet-flexr jcfe">
                <span class="sheet-lbl">Dex Bonus</span>
                <span class="sheet-val" name="attr_dex_bonus"></span>%
              </div>

              <div class="sheet-flexr jcfe">
                <span class="sheet-lbl">CW</span>
                <span class="sheet-val-sm2" name="attr_cw"></span>+
                <span class="sheet-val-sm" name="attr_cw_bonus"></span>%
              </div>

              <div class="sheet-flexr jcfe">
                <span class="sheet-lbl">PL</span>
                <span class="sheet-val-sm2" name="attr_pl"></span>+
                <span class="sheet-val-sm" name="attr_pl_bonus"></span>%
              </div>

              <div class="sheet-flexr jcfe">
                <span class="sheet-lbl">NT</span>
                <span class="sheet-val-sm2" name="attr_nt"></span>+
                <span class="sheet-val-sm" name="attr_nt_bonus"></span>%
              </div>

              <div class="sheet-flexr jcfe">
                <span class="sheet-lbl">PS</span>
                <span class="sheet-val-sm2" name="attr_ps"></span>+
                <span class="sheet-val-sm" name="attr_ps_bonus"></span>%
              </div>

              <div class="sheet-flexr jcfe">
                <span class="sheet-lbl">MQ</span>
                <span class="sheet-val-sm2" name="attr_mq"></span>+
                <span class="sheet-val-sm" name="attr_mq_bonus"></span>%
              </div>

              <div class="sheet-flexr jcfe">
                <span class="sheet-lbl">MU</span>
                <span class="sheet-val-sm2" name="attr_mu"></span>+
                <span class="sheet-val-sm" name="attr_mu_bonus"></span>%
              </div>

              <div class="sheet-flexr jcfe">
                <span class="sheet-lbl">HN</span>
                <span class="sheet-val-sm2" name="attr_hn"></span>+
                <span class="sheet-val-sm" name="attr_hn_bonus"></span>%
              </div>


            </div> <!-- end Thief Skills col -->

            </div>


        </div>
      </div>
    </div>  <!-- end Experience tab view -->
  </div>



  </div>
</div>
<script type="text/worker">
  const parseValues = function(values, stat, type='int') {
    if(type === 'int') return parseInt(values[stat])||0;
    else if(type === 'float') return parseFloat(values[stat])||0;
    else if(type === 'str') return values[stat];
  }

  const race_base_lp = {
    'M': 7,
    'D': 6,
    'E': 5
  }

  const getBaseLP = (_str, race) => {
    let lp = 0;
    lp = race_base_lp[race];
    if (_str > 9) lp += 1;
    if (_str > 12) lp += 1;
    if (_str === 15) lp += 1;
    return lp;
  };


  const run_str_bp = [3, 5, 8, 10, 12];
  const getMaxLoad = (str) => {
    if (str === '') return;

    let run_idx = 0;
    const full_loads = [70, 80, 90, 100, 120, 150];
    for (let bp of run_str_bp) {
      if (str > bp) run_idx += 1;
    }
    const ml = full_loads[run_idx];
    return {
      "max": ml,
      "run_idx": run_idx
    };
  };

  const getMaxRunSpeed = (idx, cat) => {
    const speeds = {
      no: [7, 8, 9, 10, 10, 9],
      half: [5, 6, 7, 8, 9, 8],
      full: [4, 4, 5, 6, 7, 7]
    }
    return speeds[cat][idx];
  };

  const roll = function(rng=6) {
    return (Math.floor(Math.random() * 6)) + 1;
  };

  const rollStat = function() {
    let stat =  roll() + roll() + 2;
    if (stat === 12) {
      if (roll() > 4) {
        stat += 1;
        if (roll() > 4) {
          stat += 1;
          if (roll() > 4) {
            stat += 1;
          }
        }
      }
    }
    return stat;
  };

  on('sheet:opened', function() {
    getAttrs(['char_str', 'char_int', 'char_dex', 'char_race', 'load_cat'], (values) => {
      let Str = parseValues(values, 'char_str');
      let Int = parseValues(values, 'char_int');
      let Dex = parseValues(values, 'char_dex');
      const Race = values.char_race;
      const load_cat = values.load_cat;

      if (Str === 0) {
        Str = rollStat();
      }

      if (Int === 0) {
        Int = rollStat();
      }

      if (Dex === 0) {
        Dex = rollStat();
      }

      const lp = getBaseLP(Str, Race);
      const load = getMaxLoad(Str);
      const speed = getMaxRunSpeed(load.run_idx, load_cat);
      
      set_dex_bonus();

      setAttrs({
        char_str: Str,
        char_int: Int,
        char_dex: Dex,
        base_lp: lp,
        lp_max: lp,
        full_load: load.max,
        run_idx: load.run_idx,
        max_run: speed,
        base_bs: Str,
        bs_max: Str
      });
    });
  });

  on('change:load_cat', () => {
    getAttrs(['run_idx', 'load_cat'], (values) => {
      const idx = parseValues(values, 'run_idx');
      const cat = values.load_cat;
      setAttrs({
        max_run: getMaxRunSpeed(idx, cat)
      });
    });
  });

  on('change:lp', () => {
    getAttrs(['lp', 'lp_max'], (values) => {
      let lp = parseValues(values, 'lp');
      let lpmax = parseValues(values, 'lp_max');
      if (lp >= lpmax)
        setAttrs({lp: ''});
    })
  });

  on('change:char_race change:char_str', function() {
    getAttrs(['char_race', 'char_str', 'load_cat'], (values) => {
      const _str = parseValues(values, 'char_str');
      const race = values.char_race;
      const cat = values.load_cat;
      const lp = getBaseLP(_str, race);
      const load = getMaxLoad(_str);
      const speed = getMaxRunSpeed(load.run_idx, cat);
      setAttrs({
        base_lp: lp,
        lp_max: lp,
        full_load: load.max,
        run_idx: load.run_idx,
        max_run: speed,
        base_bs: _str,
        bs_max: _str
      });
    })

  });
  
  on('change:char_dex' , () => {
    set_dex_bonus();
  });

  on('clicked:lpadd clicked:bsadd', (event) => {
    const att = event.triggerName.slice(8, 10);
    getAttrs([att, att+'_max'], (values) => {
      let q = parseValues(values, att, 'str');
      let qmax = parseValues(values, att+'_max');
      if (q === '') return;
      else q = parseInt(q) + 1;

      if (q >= qmax) q = '';
      const _atts = {};
      _atts[att] = q;
      setAttrs(_atts);
    });
  });

  on('clicked:lpminus clicked:bsminus', (event) => {
    const att = event.triggerName.slice(8, 10);
    getAttrs([att, att+'_max'], (values) => {
      let q = parseValues(values, att, 'str');
      let qmax = parseValues(values, att+'_max');
      if (q === '') q = qmax - 1;
      else q = parseInt(q) - 1;
      const _atts = {};
      _atts[att] = q;
      setAttrs(_atts);
    });
  });

  on('change:af', () => {
    getAttrs(['af'], (values) => {
      let plus = values.af.match(/(^[+]\d|^[m])/);
      if (plus !== null) {
        plus = plus[0];
        setAttrs(
          {af_plus: plus.length === 1 ? 4 : parseInt(plus.charAt(1))});
      } else {
        setAttrs({af_plus: ''});
      }
    });
  });

  on('change:df change:ar', (event) => {
    const att = event.triggerName;

    let plus = event.newValue.match(/^[+]\d/);
    const _attrs = {};
    if (plus !== null) {
      plus = plus[0];
      _attrs[att+'_plus'] = parseInt(plus.charAt(1));
    } else {
      _attrs[att+'_plus'] = '';
    }
    setAttrs(_attrs);

  });

  const ep_el_breakpoints = {
    fighter: [ 0, 20, 60, 200, 1200, 4000, 10000 ],
    thief: [ 0, 30, 100, 500, 1800, 7500 ],
    magician: [ 1, 20, 70, 250, 1500, 5000, 15000, 30000 ],
    alchemist: [ 1, 20, 50, 200, 1300, 6500 ],
    priest: [ 0, 20, 100, 400, 1500, 7000, 20000 ]
  }
  
  on("change:ep_fighter \
      change:ep_thief \
      change:ep_magician \
      change:ep_alchemist \
      change:ep_priest", (event) => {
    klass = event.sourceAttribute.slice(3);
    bps = ep_el_breakpoints[klass];
    let el = 0;
    const ep = parseInt(event.newValue);
    
    for(let bp of bps) {
      if(ep > bp) el += 1;
    }
    attr = {};
    attr[`el_${klass}`] = el;
    setAttrs(attr);
    
    if(klass === 'thief') set_Thief_Functions(el);
  });
  
  const set_dex_bonus = () => {
    getAttrs(['char_dex'], (values) => {
      dex = parseValues(values, 'char_dex');
      console.log('dex:', dex);
      let bonus = dex - 8;
      if(dex < 9) bonus = " ";
      console.log('dex bonus:', bonus);
      
      setAttrs({dex_bonus: bonus});
    });
  }
  
  const set_Thief_Functions = (el) => {
    getAttrs(['char_race'], (values) => {
      race = values.race;
      
    
    })
  }

</script>

/* Define functions that may not always exist */
            if (!log) {
                log = function (input) {
                    console.log(input);
                }
            }
            
            if (!sendChat) {
                sendChat = function (sender, msg) {
                    log(sender + " says " + msg);
                }
            }
            /* End special function definitions*/
            
            
            /* Begin Sheet Character Sheet Auto Creator */
            var Charsheet = Charsheet || {};
            
            on('chat:message', function (msg) {
                // Exit if not an api command
                if (msg.type != "api") {
                    return;
                }
                if (msg.content.indexOf('!charsheet') != -1) {
                    Charsheet.Generate(msg);
                }
            });
            
            Charsheet.Generate = function (msg) {
                var player = msg.who;
                var character_name = msg.who + Date.now();
            
                var character = createObj('character', {
                    name: character_name,
                    inplayerjournals: msg.playerid,
                    controlledby: msg.playerid
                });
                /* Create attributes */
                createObj('attribute', {
                    name: 'player_name',
                    current: player,
                    _characterid: character.id
                });
                createObj('attribute', {
                    name: 'name',
                    current: character_name,
                    _characterid: character.id
                });
                sendChat("Dice System", "/w " + msg.who + " a blank character sheet was created for you named \"" + character_name);
                sendChat("GM", "/w " + "gm " + "A blank character sheet was created for " + msg.who)
            };
            
            if (!Date.now) {
                Date.now = function now() {
                    return new Date().getTime();
                };
            }
            /* End Sheet Character Sheet Auto Creator */
            
            function SuggestionEngine() {
                var that = this;
            
                var flags = {
                    displayOption: null,
                    generalSuggesting: true,
                    combatSuggesting: true,
                    combatType: null,
                    isFearCheck: false
                };
            
                function convertToBoolean(value) {
                    // will trap the following properly: false, true, "false", "true", 0, 1, "", and undefined
                    //noinspection RedundantConditionalExpressionJS
                    return !value || value == 1 || value === 'true'
                }
            
                this.suggestions = {
                
                    general: {
                        
                        Attaque: {
                            
			                advantage: [
                                { text: " <b>1 :</b> Ajoutez 1 $BOOST$ à votre prochain test.<br><b>2 : </b>Ajoutez 1 $SETBACK$ au prochain test de votre cible.<br><b>3 : </b>Déclenchez un Attribut ou un Talent. ", required: 1 },
                                { text: " <b>1 :</b> Ajoutez 1 $BOOST$ au prochain test d'un allié à 2 ps ou moins.<br><b>2 :</b> Éliminez 1 Fatigue.<br><b>3 : </b>Effectuez une manœuvre gratuite.<br><b>4 :</b> Déclenchez un Attribut ou un Talent. ", required: 2 },
                                { text: " <b>1 :</b> La cible effectue un test de Pilonnage Moyen (2) OU est Hébétée.<br><b>2 :</b> Ignorez la Défense de votre cible lors de votre prochaine attaque contre elle.<br><b>3 : </b>Votre cible laisse tomber quelque chose ou tombe à terre.<br><b>4 : </b>Augmentez votre valeur de Défense de 1 jusqu'au début de votre prochain tour de jeu.<br><b>5 : </b>Déclenchez un Attribut ou un Talent.", required: 3 },
                                { text: "[[1d3]]", required: 1 },
                                { text: "[[1d4]]", required: 2 },
                                { text: "[[1d5]]", required: 3 }
                            ],
		                    triumph: [
                                { text: "<b>1 : </b>Une arme ou un équipement porté par votre cible subit 1 niveau de dégât.<br><b>2 :</b> Ajoutez 1 $CHALLENGE$ au prochain test de votre cible.<br><b>3 : </b>Réduisez de 1 la Difficulté de votre prochain test ou de celui d'un allié à 2 ps ou moins.<br><b>4 : </b>Infligez une Blessure critique à votre cible.", required: 1 },
                                { text: "[[1d4]]", required: 1 },
                                { text: "<b>1 : </b>Une arme ou un équipement porté par votre cible subit 1 niveau de dégât.<br><b>2 :</b> Ajoutez 1 $CHALLENGE$ au prochain test de votre cible.<br><b>3 : </b>Réduisez de 1 la Difficulté de votre prochain test ou de celui d'un allié à 2 ps ou moins.<br><b>4 : </b>Infligez une Blessure critique à votre cible.", required: 2 },
                                { text: "[[1d4]]", required: 2 },
                                { text: "<b>1 : </b>Une arme ou un équipement porté par votre cible subit 1 niveau de dégât.<br><b>2 :</b> Ajoutez 1 $CHALLENGE$ au prochain test de votre cible.<br><b>3 : </b>Réduisez de 1 la Difficulté de votre prochain test ou de celui d'un allié à 2 ps ou moins.<br><b>4 : </b>Infligez une Blessure critique à votre cible.", required: 3 },
                                { text: "[[1d4]]", required: 3 }
                            ],
                            threat: [
                                { text: " <b>1 :</b> Ajoutez 1 $SETBACK$ à votre prochain test.<br><b>2 : </b>Ajoutez 1 $BOOST$ au prochain test de votre cible.", required: 1 },
                                { text: " <b>1 :</b> Encaissez 1 Fatigue.<br><b>2 : </b>Votre cible peut immédiatement effectuez une manœuvre gratuite.", required: 2 },
                                { text: " <b>1 :</b> Effectuez un test de Pilonnage Moyen (2) OU vous êtes Hébété.<br><b>2 :</b> Vous êtes Sans défense contre la prochaine attaque qui vous prend pour cible.<br><b>3 : </b>Vous laissez tomber quelque chose ou tombez à terre.", required: 3 },
                                { text: "[[1d2]]", required: 1 },
                                { text: "[[1d2]]", required: 2 },
                                { text: "[[1d3]]", required: 3 }
                            ],
                            despair: [
                                { text: "<b>1 : </b>Votre arme subit 1 niveau de dégât.<br><b>2 :</b> Ajoutez 1 $CHALLENGE$ à votre prochain test.<br><b>3 : </b>Vous êtes Sans défense jusqu'au début de votre prochain tour de jeu.<br><b>4 : </b>Vous tombez à terre et êtes Hébété.", required: 1 },
                                { text: "[[1d4]]", required: 1 },
                                { text: "<b>1 : </b>Votre arme subit 1 niveau de dégât.<br><b>2 :</b> Ajoutez 1 $CHALLENGE$ à votre prochain test.<br><b>3 : </b>Vous êtes Sans défense jusqu'au début de votre prochain tour de jeu.<br><b>4 : </b>Vous tombez à terre et êtes Hébété.", required: 2 },
                                { text: "[[1d4]]", required: 2 },
                                { text: "<b>1 : </b>Votre arme subit 1 niveau de dégât.<br><b>2 :</b> Ajoutez 1 $CHALLENGE$ à votre prochain test.<br><b>3 : </b>Vous êtes Sans défense jusqu'au début de votre prochain tour de jeu.<br><b>4 : </b>Vous tombez à terre et êtes Hébété.", required: 3 },
                                { text: "[[1d4]]", required: 3 }
                            ]
                            
                        },
                        Psy: {
                            
			                advantage: [
                                { text: " Ajoutez 1 $BOOST$ à votre prochain test ou à celui d'un allié. ", required: 1 },
                                { text: " <b>1 :</b> Éliminez 1 Fatigue.<br><b>2 : </b>Effectuez une manœuvre gratuite.", required: 2 },
                                { text: " <b>1 :</b> Éliminez 1 Fatigue.<br><b>2 : </b>Effectuez une manœuvre gratuite.", required: 3 },
                                { text: "[[1d2]]", required: 2 },
                                { text: "[[1d2]]", required: 3 }
                            ],
		                    triumph: [
                                { text: "<b>1 : </b>Réduisez de 1 la Difficulté de votre prochain test ou de celui d'un allié.<br><b>2 : </b>Éliminez 2 Fatigues.", required: 1 },
                                { text: "[[1d2]]", required: 1 },
                                { text: "<b>1 : </b>Réduisez de 1 la Difficulté de votre prochain test ou de celui d'un allié.<br><b>2 : </b>Éliminez 2 Fatigues.", required: 2 },
                                { text: "[[1d2]]", required: 2 },
                                { text: "<b>1 : </b>Réduisez de 1 la Difficulté de votre prochain test ou de celui d'un allié.<br><b>2 : </b>Éliminez 2 Fatigues.", required: 3 },
                                { text: "[[1d2]]", required: 3 }
                            ],
                            threat: [
                                { text: " Ajoutez 1 $SETBACK$ à votre prochain test.", required: 1 },
                                { text: " <b>1 :</b> Encaissez 1 Fatigue.<br><b>2 : </b><b>3 : </b>Vous perdez votre manœuvre gratuite.", required: 2 },
                                { text: "Encaissez 1 Blessure.", required: 3 },
                                { text: "[[1d2]]", required: 2 }
                            ],
                            despair: [
                                { text: "Phénomène psychique.", required: 1 },
                                { text: "Phénomène psychique, avec un modificateur de +5 au jet.", required: 2 },
                                { text: "Phénomène psychique, avec un modificateur de +5 au jet.", required: 3 }
                               
                            ]
                            
                        },
                        Comp: {
                            
			                advantage: [
                                { text: " Ajoutez 1 $BOOST$ à votre prochain test ou à celui d'un allié. ", required: 1 },
                                { text: " <b>1 :</b> Éliminez 1 Fatigue.<br><b>2 : </b>Effectuez une manœuvre gratuite.", required: 2 },
                                { text: " <b>1 :</b> Éliminez 1 Fatigue.<br><b>2 : </b>Effectuez une manœuvre gratuite.", required: 3 },
                                { text: "[[1d2]]", required: 2 },
                                { text: "[[1d2]]", required: 3 }
                            ],
		                    triumph: [
                                { text: "<b>1 : </b>Réduisez de 1 la Difficulté de votre prochain test ou de celui d'un allié.<br><b>2 : </b>Éliminez 2 Fatigues.", required: 1 },
                                { text: "[[1d2]]", required: 1 },
                                { text: "<b>1 : </b>Réduisez de 1 la Difficulté de votre prochain test ou de celui d'un allié.<br><b>2 : </b>Éliminez 2 Fatigues.", required: 2 },
                                { text: "[[1d2]]", required: 2 },
                                { text: "<b>1 : </b>Réduisez de 1 la Difficulté de votre prochain test ou de celui d'un allié.<br><b>2 : </b>Éliminez 2 Fatigues.", required: 3 },
                                { text: "[[1d2]]", required: 3 }
                            ],
                            threat: [
                                { text: " Ajoutez 1 $SETBACK$ à votre prochain test.", required: 1 },
                                { text: " <b>1 :</b> Encaissez 1 Fatigue.<br><b>2 : </b><b>3 : </b>Vous perdez votre manœuvre gratuite.", required: 2 },
                                { text: "Encaissez 1 Blessure.", required: 3 },
                                { text: "[[1d2]]", required: 2 }
                            ],
                            despair: [
                                { text: "<b>1 : </b>Vous perdez une de vos pièces d'équipement.<br><b>2 :</b> Ajoutez 1 $CHALLENGE$ à votre prochain test.<br><b>3 : </b>Vous encaissez 1 Blessure grave.<br><b>4 : </b>Vous tombez à terre et êtes Hébété.", required: 1 },
                                { text: "[[1d4]]", required: 1 },
                                { text: "<b>1 : </b>Vous perdez une de vos pièces d'équipement.<br><b>2 :</b> Ajoutez 1 $CHALLENGE$ à votre prochain test.<br><b>3 : </b>Vous encaissez 1 Blessure grave.<br><b>4 : </b>Vous tombez à terre et êtes Hébété.", required: 2 },
                                { text: "[[1d4]]", required: 2 },
                                { text: "<b>1 : </b>Vous perdez une de vos pièces d'équipement.<br><b>2 :</b> Ajoutez 1 $CHALLENGE$ à votre prochain test.<br><b>3 : </b>Vous encaissez 1 Blessure grave.<br><b>4 : </b>Vous tombez à terre et êtes Hébété.", required: 3 },
                                { text: "[[1d4]]", required: 3 }
                            ]
                            
                        }
                        
                        
                    }
                    
                };
            
                this.enum = {
                    types: {
                        general: { number: 0, text: "general" }
                    },
                    displayOptions: {
                        none: { number: 0, text: "none" },          // Suggestions are not displayed
                        whisper: { number: 1, text: "whisper" },    // Suggestions are whispered to the GM
                        always: { number: 2, text: "always" }       // Suggestions are included in the dice roll result
                    }
                };
            
                this.setDisplayOption = function (input) {
                    if (input == null || input === "")
                        return;
            
                    var flag = null;
                    if (flag = that.enum.isValidInput(input, that.enum.displayOptions))
                        flags.displayOption = flag;
                };
            
                this.getDisplayOption = function () {
                    return flags.displayOption;
                };
            
                this.setGeneralSuggestions = function (input) {
                    if (input == null || input === "")
                        return;
                    log("input=" + input);
            
                    flags.generalSuggesting = convertToBoolean(input);
                    log("flags.generalSuggesting=" + flags.generalSuggesting);
                };
            
                this.getGeneralSuggesting = function () {
                    return flags.generalSuggesting;
                };
            
                this.setCombatSuggestions = function (input) {
                    if (input == null || input === "")
                        return;
                    log("input=" + input);
                    flags.combatSuggesting = convertToBoolean(input);
                    log("flags.combatSuggesting=" + flags.combatSuggesting);
                };
            
                this.getCombatSuggesting = function () {
                    return flags.combatSuggesting;
                };
            
                this.setIsFearCheck = function (input) {
                    if (input == null || input === "")
                        return;
            
                    flags.isFearCheck = convertToBoolean(input);
                };
            
                this.getIsFearCheck = function () {
                    return flags.isFearCheck;
                };
            
                this.setCombatType = function (input) {
                    if (input == null || input === "") {
                        flags.combatType = null;
                        return;
                    }
            
                    var flag = null;
                    if (flag = that.enum.isValidInput(input, that.enum.combatType))
                        flags.combatType = flag;
                };
            
                this.getCombatType = function () {
                    return flags.combatType;
                };
            
                this.enum.isValidInput = function (input, enumToUse) {
                    if (input == null || input === "" || !enumToUse)
                        return;
            
                    var retVal = null;
            
                    Object.keys(enumToUse).some(function (key) {
                        var object = enumToUse[key];
            
                        if (input == object || input === object.text || input === object.number) {
                            return retVal = object;
                        }
                    });
            
                    return retVal;
                };
            
                this.enum.mapTextToNumber = function (input, enumToUse) {
                    if (input == null || input === "")
                        return;
            
                    var flag = null;
                    if (flag = that.enum.isValidInput(input, enumToUse))
                        return flag.number;
                };
            
                this.enum.mapNumberToText = function (input, enumToUse) {
                    if (input == null || input === "")
                        return;
            
                    var flag = null;
                    if (flag = that.enum.isValidInput(input, enumToUse))
                        return flag.text;
                };
            
            
                /* Suggestion Handling */
                function addSkillSuggestionsFromArray(diceObj, array, key, rollResultForSymbol, suggestionsType) {
                    for (var i = 0; i < array.length; i++) {
                        if (array[i].required == rollResultForSymbol) {
                            suggestionsType[key] += "<li>" + array[i].text + "</li>";
                            diceObj.vars.suggestions.suggestionsExist = true;
                        }
                    }
                    return diceObj;
                }
            
                function buildSuggestionSet(suggestionSet, symbol, rollResultForSymbol, suggestionJSON) {
                    if (suggestionSet == null)
                        suggestionSet = new Set();
            
                    var item = {};
                    for (var i = 0; i < suggestionJSON.length; i++) {
                        item = suggestionJSON[i];
                        if (item.hasOwnProperty(symbol) && item[symbol] <= rollResultForSymbol) {
                            suggestionSet.add(item.text);
                        }
                    }
            
                    return suggestionSet;
                }
                 
            
                function buildRollTemplateItem(key, value) {
                    return "{{" + key + "=<ul>" + value + "</ul>}}";
                }
            
                function generateSuggestions(diceObj, symbol, rollResultForSymbol) {
                    var skillName = diceObj.vars.skillName;
            
                    
                        var generalSkills = that.suggestions.general;
                        if (generalSkills.hasOwnProperty(skillName)) {
                            var skill = generalSkills[skillName];
                            var fearJSON = (diceObj.vars.isFearCheck ? that.suggestions.special.fear : null);
            
                            if (skill.hasOwnProperty(symbol)) {
                                diceObj = addSkillSuggestionsFromArray(diceObj, skill[symbol], symbol, rollResultForSymbol, diceObj.vars.suggestions.general);
                            }
            
                            if (fearJSON && fearJSON.allowedSkills.indexOf(skillName)) {
                                diceObj = addSkillSuggestionsFromArray(diceObj, fearJSON[symbol], symbol, rollResultForSymbol, diceObj.vars.suggestions.general);
                            }
                        }
                    
                    return diceObj;
                }
            
                this.processSuggestions = function (diceObj) {
                    if (flags.displayOption === that.enum.displayOptions.none)
                        return diceObj;
            
                    diceObj.vars.suggestions = {
                        general: {
                            advantage: "",
                            triumph: "",
                            threat: "",
                            despair: ""
                        },
                        suggestionsExist: false
                    };
            
            
                    var failedCheck = !diceObj.totals.success > 0;
                    Object.keys(diceObj.totals).forEach(function (key) {
                        var rollResultForSymbol = diceObj.totals[key];
                        
                        if (rollResultForSymbol > 3) {
                            rollResultForSymbol = 3;
                        }
                        if (rollResultForSymbol > 0) {
                            diceObj = generateSuggestions(diceObj, key, rollResultForSymbol, failedCheck);
                        }
                    });
            
                    return diceObj;
                };
            
                this.buildSuggestionsRollTemplate = function (diceObj) {
                    var suggestions = diceObj.vars.suggestions;
                    var suggestionsRollTemplate = "";
            
                    // display results shown to character owners and GM
                    Object.keys(suggestions).forEach(function (property) {
                        if (property === "suggestionsExist")
                            return;
            
                        var propertyObject = suggestions[property];
                        Object.keys(propertyObject).forEach(function (symbol) {
                            var object = propertyObject[symbol];
            
                            if (!object)
                                return;
            
                            if (typeof object === "string")
                                suggestionsRollTemplate += buildRollTemplateItem(symbol, object);
                            else if (object.size > 0) {
                                var suggestionList = "";
                                object.forEach(function (value) {
                                    suggestionList += "<li>" + value + "</li>";
                                });
                                suggestionsRollTemplate += buildRollTemplateItem(symbol, suggestionList);
                            }
                        });
                    });
                    return suggestionsRollTemplate;
                }
            }
            
            /*TODO refactor eote to be genesys*/
            var eote = {};
            
            eote.init = function () {
                eote.setCharacterDefaults();
                eote.createGMDicePool();
                eote.events();
                convertTokensToTags(suggestionEngine.suggestions, eote.defaults.graphics.SymbolicReplacement);
                attemptRegisterGMObj();
            };
            
            
            eote.defaults = {
                globalVars: {
                    diceLogChat: true,
                    diceGraphicsChat: true,
                    diceGraphicsChatSize: 30,//medium size
                    diceTextResult: "",
                    diceTextResultLog: "",
                    diceGraphicResult: "",
                    diceGraphicResultLog: "",
                    diceTestEnabled: false,
                    diceLogRolledOnOneLine: true,
                    scriptDebug: false
                },
                '-GameMasterCharacterSheetID': '',
                GMSheet: {
                    obj: null,
                    name: "-GameMasterCharacterSheet"
                },
                character: {
                    attributes: [
                        /* Don't need to update characterID
                         * 
                         *{
                         name : "characterID",
                         current : "UPDATES TO CURRENT ID",
                         max : "",
                         update : false
                         }*/
                    ],
                    abilities: []
                },
                graphics: {
                    SIZE: {
                        SMALL: 20,
                        MEDIUM: 30,
                        LARGE: 40
                    },
                    ABILITY: {
                        BLANK: "https://i.imgur.com/NhSglh7.png",
                        A: "https://i.imgur.com/mHG4eh2.png",
                        AA: "https://i.imgur.com/c4Zbeod.png",
                        S: "https://i.imgur.com/wSsxsjb.png",
                        SA: "https://i.imgur.com/fjMdzc5.png",
                        SS: "https://i.imgur.com/SiEZtMf.png"
                    },
                    BOOST: {
                        BLANK: "https://i.imgur.com/gzPXiBK.png",
                        A: "https://i.imgur.com/g4zZseK.png",
                        AA: "https://i.imgur.com/YOTIuFZ.png",
                        S: "https://i.imgur.com/NjGJpYK.png",
                        SA: "https://i.imgur.com/dhStIX6.png"
                    },
                    CHALLENGE: {
                        BLANK: "https://i.imgur.com/56lp8IN.png",
                        F: "https://i.imgur.com/itob7iS.png",
                        FF: "https://i.imgur.com/TZCVOU4.png",
                        FT: "https://i.imgur.com/3aEjzhC.png",
                        T: "https://i.imgur.com/buFGnLb.png",
                        TT: "https://i.imgur.com/zhSCsAn.png",
                        DESPAIR: "https://i.imgur.com/N7ywBJp.png"
                    },
                    DIFFICULTY: {
                        BLANK: "https://i.imgur.com/SmEKzyC.png",
                        F: "https://i.imgur.com/thdeWgR.png",
                        FF: "https://i.imgur.com/GuWpUnC.png",
                        FT: "https://i.imgur.com/IIsVCKN.png",
                        T: "https://i.imgur.com/tYU5juG.png",
                        TT: "https://i.imgur.com/CmZJ16T.png"
                    },
                    PROFICIENCY: {
                        BLANK: "https://i.imgur.com/Cem6BPL.png",
                        A: "https://i.imgur.com/XCqPA0s.png",
                        S: "https://i.imgur.com/VtnKaoM.png",
                        SA: "https://i.imgur.com/v4cUwLN.png",
                        SS: "https://i.imgur.com/VpITyqd.png",
                        AA: "https://i.imgur.com/KRYnzZ1.png",
                        TRIUMPH: "https://i.imgur.com/kU33Rfs.png"
                    },
                    SETBACK: {
                        BLANK: "https://i.imgur.com/XXG63Z9.png",
                        F: "https://i.imgur.com/motDdx2.png",
                        T: "https://i.imgur.com/rdXo6xd.png"
                    },
                    SYMBOLS: {
                        A: "https://i.imgur.com/hx652xW.png",
                        S: "https://i.imgur.com/1xJfMqo.png",
                        T: "https://i.imgur.com/bIuRi96.png",
                        F: "https://i.imgur.com/br3Qlxy.png",
                        TRIUMPH: "https://i.imgur.com/vLLnmhi.png",
                        DESPAIR: "https://i.imgur.com/uhpy4vl.png"
                    },
                    SymbolicReplacement: {}
                },
                regex: {
                    cmd: /!eed/,
                    log: /log (on|multi|single|off)/,
                    debug: /debug (on|off)/,
                    graphics: /graphics (on|off|s|m|l)/,
                    test: /test/,
                    resetdice: /(resetgmdice|resetdice)/,
                    initiative: /\bnpcinit|\bpcinit/,
                    characterID: /characterID\((.*?)\)/,
                    rollPlayer: /rollPlayer(\(.*?\))/,
                    label: /label\((.*?)\)/,
                    skill: /skill\((.*?)\)/g,
                    fear: /fear (on|off)/,
                    suggestionDisplay: /suggestionDisplay (none|whisper|always)/,
                    opposed: /opposed\((.*?)\)/g,
                    upgrade: /upgrade\((.*?)\)/g,
                    downgrade: /downgrade\((.*?)\)/g,
                    gmdice: /\(gmdice\)/,
                    fatigue: /fatigue\((.*?)\)/g,
                    saturation: /saturation\((.*?)\)/g,
                    encum: /encum\((.*?)\)/g,
                    dice: /(-?\d{1,2}blk)\b|(-?\d{1,2}b)\b|(-?\d{1,2}g)\b|(-?\d{1,2}y)\b|(-?\d{1,2}p)\b|(-?\d{1,2}r)\b|(-?\d{1,2}w)\b|(-?\d{1,2}a)\b|(-?\d{1,2}s)|(-?\d{1,2}t)\b|(-?\d{1,2}f)/g,
                    crit: /crit\((.*?)\)/,
                    critShip: /critship\((.*?)\)/,
                    unusable: /unusableWeapon/,
                    destiny: /destiny (useDark|useLight|registerPlayer|sendUpdate|doRoll|clearPool)/,
                    combat: /combat\(personal|vehicle\)/
                },
                destinyListeners: []
            };
            
            var GMSheet = eote.defaults.GMSheet;
            var suggestionEngine = new SuggestionEngine();
            
            function buildReplacementObject(title, src, size) {
                return { matcher: new RegExp("\\$" + title.toUpperCase() + "\\$", "g"), replacer: '<img src="' + src + '" title="' + title + '" height="' + size + '" width="' + size + '"/>' };
            }
            
            // dice symbols
            eote.defaults.graphics.SymbolicReplacement.success = buildReplacementObject("success", eote.defaults.graphics.SYMBOLS.S, eote.defaults.graphics.SIZE.SMALL);
            eote.defaults.graphics.SymbolicReplacement.advantage = buildReplacementObject("advantage", eote.defaults.graphics.SYMBOLS.A, eote.defaults.graphics.SIZE.SMALL);
            eote.defaults.graphics.SymbolicReplacement.triumph = buildReplacementObject("triumph", eote.defaults.graphics.SYMBOLS.TRIUMPH, eote.defaults.graphics.SIZE.SMALL);
            eote.defaults.graphics.SymbolicReplacement.failure = buildReplacementObject("failure", eote.defaults.graphics.SYMBOLS.F, eote.defaults.graphics.SIZE.SMALL);
            eote.defaults.graphics.SymbolicReplacement.threat = buildReplacementObject("threat", eote.defaults.graphics.SYMBOLS.T, eote.defaults.graphics.SIZE.SMALL);
            eote.defaults.graphics.SymbolicReplacement.despair = buildReplacementObject("despair", eote.defaults.graphics.SYMBOLS.DESPAIR, eote.defaults.graphics.SIZE.SMALL);
            
            // dice icons
            eote.defaults.graphics.SymbolicReplacement.ability = buildReplacementObject("ability", eote.defaults.graphics.ABILITY.BLANK, eote.defaults.graphics.SIZE.SMALL);
            eote.defaults.graphics.SymbolicReplacement.boost = buildReplacementObject("boost", eote.defaults.graphics.BOOST.BLANK, eote.defaults.graphics.SIZE.SMALL);
            eote.defaults.graphics.SymbolicReplacement.proficiency = buildReplacementObject("proficiency", eote.defaults.graphics.PROFICIENCY.BLANK, eote.defaults.graphics.SIZE.SMALL);
            eote.defaults.graphics.SymbolicReplacement.difficulty = buildReplacementObject("difficulty", eote.defaults.graphics.DIFFICULTY.BLANK, eote.defaults.graphics.SIZE.SMALL);
            eote.defaults.graphics.SymbolicReplacement.setback = buildReplacementObject("setback", eote.defaults.graphics.SETBACK.BLANK, eote.defaults.graphics.SIZE.SMALL);
            eote.defaults.graphics.SymbolicReplacement.challenge = buildReplacementObject("challenge", eote.defaults.graphics.CHALLENGE.BLANK, eote.defaults.graphics.SIZE.SMALL);
            
            function attemptRegisterGMObj() {
                var GMObj = GMSheet.obj;
            
                // if the GMObj is null then it means that this is the first time this version of the script is being run on this campaign.
                if (!GMObj) {
                    GMObj = findObjs({
                        _type: "character",
                        name: GMSheet.name
                    });
                    if (GMObj.length > 0) {
                        GMSheet.obj = GMObj[0];
                        eote.process.logger("attemptRegisterGMObj", "Registering of GMObj successful");
                    }
                    else {
                        var msg = "The character sheet called " + GMSheet.name + " was not found in your campaign.";
                        eote.process.logger("attemptRegisterGMObj", msg);
                        sendChat("System", "/w gm " + msg);
                    }
                } else {
                    eote.process.logger("attemptRegisterGMObj", "GMObj previously registered.");
                }
            }
            
            eote.createGMDicePool = function () {
            
                var charObj_DicePool = findObjs({ _type: "character", name: "-GameMasterCharacterSheet" })[0];
                var attrObj_DicePool = [
                    {
                        name: 'pcgm',
                        current: 3,
                        max: '',
                        update: true
                    },
                    {
                        name: 'gmdicepool',
                        current: 2,
                        max: '',
                        update: true
                    }
                ];
                //create character -GameMasterCharacterSheet
                if (!charObj_DicePool) {
                    charObj_DicePool = createObj("character", {
                        name: GMSheet.name,
                        bio: "GM Dice Pool"
                    });
                }
                eote.defaults['-GameMasterCharacterSheetID'] = charObj_DicePool.id;
                GMSheet.obj = charObj_DicePool;
                eote.updateAddAttribute(charObj_DicePool, attrObj_DicePool);
            };
            
            eote.createObj = function () {//Create Object Fix - Firebase.set failed
                var obj = createObj.apply(this, arguments);
                var id = obj.id;
                var characterID = obj.get('characterid');
                var type = obj.get('type');
                if (obj && !obj.fbpath && obj.changed) {
                    obj.fbpath = obj.changed._fbpath.replace(/([^\/]*\/){4}/, "/");
                } else if (obj && !obj.changed && type == 'attribute') { //fix for dynamic attribute after in character created in game
                    obj.fbpath = '/char-attribs/char/' + characterID + '/' + id;
                    // /char-attribs/char/characterID/attributeID
                }
                return obj;
            };
            
            eote.setCharacterDefaults = function (characterObj) {
            
                var charObj = [characterObj];
            
                if (!characterObj) {
                    charObj = findObjs({ _type: "character" });
                }
                //add/update characterID field
                _.each(charObj, function (charObj) {
                    //updates default attr:CharacterID to current character id
                    //_.findWhere(eote.defaults.character.attributes, {'name':'characterID'}).current = charObj.id;
            
                    //Attributes
                    eote.updateAddAttribute(charObj, eote.defaults.character.attributes);//Update Add Attribute defaults
                    //Abilities
                });
            };
            
            eote.updateListeners = function (attributes) {
            
                _.each(eote.defaults.destinyListeners, function (charID) {
            
                    var charObj = findObjs({
                        _type: "character",
                        _id: charID
                    });
                    //add/update characterID field
                    _.each(charObj, function (charObj) {
                        //Attributes
                        eote.updateAddAttribute(charObj, attributes); //Update Add Attribute defaults
                    });
                });
                //Update GM
                var GMObj = findObjs({
                    _type: "character",
                    name: GMSheet.name
                });
                GMSheet.obj = GMSheet.obj || GMObj;
                eote.updateAddAttribute(GMObj, attributes);
            };
            
            eote.updateAddAttribute = function (charactersObj, updateAddAttributesObj) { // charactersObj = object or array objects, updateAddAttributesObj = object or array objects
                if (!charactersObj) {
                    log("error: charactersObj passed into eote.updateAddAttribute is not set");
                    return;
                }
            
                //check if object or array
                if (!_.isArray(charactersObj)) {
                    charactersObj = [charactersObj];
                }
                if (!_.isArray(updateAddAttributesObj)) {
                    updateAddAttributesObj = [updateAddAttributesObj];
                }
                _.each(charactersObj, function (characterObj) {//loop characters
            
                    var characterName = '';
            
                    if (characterObj.name) {
                        characterName = characterObj.name;
                    } else {
                        characterName = characterObj.get('name');
                    }
                    //find attribute via character ID
                    var characterAttributesObj = findObjs({ _type: "attribute", characterid: characterObj.id });
            
                    if (updateAddAttributesObj.length != 0) {
            
                        log('UPDATE/ADD ATTRIBUTES FOR:--->' + characterName);
            
                        _.each(updateAddAttributesObj, function (updateAddAttrObj) { //loop attributes to update / add
            
                            attr = _.find(characterAttributesObj, function (a) {
                                return (a.get('name') === updateAddAttrObj.name);
                            });
                            if (attr) {
                                if (updateAddAttrObj.update) {
                                    log('Update Attr: ' + updateAddAttrObj.name);
                                    attr.set({ current: updateAddAttrObj.current });
                                    attr.set({ max: updateAddAttrObj.max ? updateAddAttrObj.max : '' });
                                }
                            } else {
                                // log('Add Attr: '+ updateAddAttrObj.name);
                                eote.createObj('attribute', {
                                    characterid: characterObj.id,
                                    name: updateAddAttrObj.name,
                                    current: updateAddAttrObj.current,
                                    max: updateAddAttrObj.max ? updateAddAttrObj.max : ''
                                });
                            }
                        });
                    }
                });
            };
            
            /* DICE PROCESS 
             * 
             * Matches the different regex commands and runs that dice processing step
             * The order of step should not be change or dice could be incorrectly rolled.
             * example: All dice needs to be 'upgraded" before it can be 'downgraded'
             * ---------------------------------------------------------------- */
            
            eote.defaults.dice = function () {
                this.vars = {
                    characterName: '',
                    characterID: '',
                    playerName: '',
                    playerID: '',
                    label: '',
                    suggestions: {},
                    skillName: '',
                    isFearCheck: false,
                    combatCheck: false
                };
                this.totals = {
                    success: 0,
                    failure: 0,
                    advantage: 0,
                    threat: 0,
                    triumph: 0,
                    despair: 0,
                    light: 0,
                    dark: 0
                };
                this.graphicsLog = {
                    Boost: '',
                    Ability: '',
                    Proficiency: '',
                    SetBack: '',
                    Difficulty: '',
                    Challenge: '',
                    Success: '',
                    Advantage: '',
                    Threat: '',
                    Failure: ''
                };
                this.textLog = {
                    Boost: '',
                    Ability: '',
                    Proficiency: '',
                    SetBack: '',
                    Difficulty: '',
                    Challenge: '',
                    Success: '',
                    Advantage: '',
                    Threat: '',
                    Failure: ''
                };
                this.count = {
                    boost: 0,
                    ability: 0,
                    proficiency: 0,
                    setback: 0,
                    difficulty: 0,
                    challenge: 0,
                    success: 0,
                    advantage: 0,
                    threat: 0,
                    failure: 0
                }
            };
            
            eote.process = {};
            
            eote.process.logger = function (functionName, cmd) {
                if (eote.defaults.globalVars.debugScript) {
                    log(functionName + ' : ' + cmd);
                }
            };
            
            eote.process.setup = function (cmd, playerName, playerID) {
            
                if (!cmd.match(eote.defaults.regex.cmd)) { //check for api cmd !eed
                    return false;
                }
                var debugMatch = cmd.match(eote.defaults.regex.debug);
                if (debugMatch) {
                    eote.process.debug(debugMatch);
                    return false;
                }
                var fearMatch = cmd.match(eote.defaults.regex.fear);
                if (fearMatch) {
                    eote.process.fear(fearMatch);
                    return false;
                }
            
                var suggestionDisplayMatch = cmd.match(eote.defaults.regex.suggestionDisplay);
                if (suggestionDisplayMatch) {
                    eote.process.suggestionDisplay(suggestionDisplayMatch);
                    return false;
                }
            
                eote.process.logger("eote.process.setup", "NEW ROLL");
                eote.process.logger("eote.process.setup", "Original Command: " + cmd);
            
                /* reset dice - test, might not need this */
                var diceObj = new eote.defaults.dice();
                diceObj.vars.playerName = playerName;
                diceObj.vars.playerID = playerID;
            
                /* Dice config
                 * Description: Change dice roller default config
                 * --------------------------------------------------------------*/
                var logMatch = cmd.match(eote.defaults.regex.log);
            
                if (logMatch) {
                    eote.process.log(logMatch);
                    return false; //Stop current roll and run test
                }
                var graphicsMatch = cmd.match(eote.defaults.regex.graphics);
            
                if (graphicsMatch) {
                    eote.process.graphics(graphicsMatch);
                    return false; //Stop current roll and run test
                }
                var testMatch = cmd.match(eote.defaults.regex.test);
            
                if (testMatch) {
                    eote.process.test(testMatch);
                    return false; //Stop current roll and run test
                }
                /* Roll information
                 * Description: Set default dice roll information Character Name and Skill Label
                 * --------------------------------------------------------------*/
            
                var rollPlayerMatch = cmd.match(eote.defaults.regex.rollPlayer);
            
                if (rollPlayerMatch) {
                    diceObj = eote.process.rollPlayer(rollPlayerMatch, diceObj);
            
                    if (!diceObj) {
                        return false;
                    }
                }
                var characterIDMatch = cmd.match(eote.defaults.regex.characterID);
            
                if (characterIDMatch) {
                    diceObj = eote.process.characterID(characterIDMatch, diceObj);
                    //Once Character ID is parsed, remove it from the cmd.
                    //it is possible that the character ID could contain dice values
                    //for ex. characterID(-JMBFmYX1i0L259bjb-X)  will add 59 blue dice to the pool
                    cmd = cmd.replace(characterIDMatch[0], '');
                    eote.process.logger("eote.process.setup.characterIDMatch", "New command: " + cmd);
                }
                var unusableMatch = cmd.match(eote.defaults.regex.unusable);
            
                if (unusableMatch) {
                    eote.process.logger("eote.process.setup.unusableMatch", "Roll ended because of unusable weapon");
                    sendChat(diceObj.vars.characterName, "&{template:base} {{title=" + diceObj.vars.characterName + "}} {{wide=L\'arme est trop endommagée pour être utilisée. Réparez-la.}}");
                    return false;
                }
                var labelMatch = cmd.match(eote.defaults.regex.label);
            
                if (labelMatch) {
                    diceObj = eote.process.label(labelMatch, diceObj);
                }
                /* Dice rolls 
                 * Description: Create dice pool before running any custom roll
                 * script commands that may need dice evaluated.
                 * --------------------------------------------------------------*/
                var gmdiceMatch = cmd.match(eote.defaults.regex.gmdice);
            
                if (gmdiceMatch) {
                    cmd = eote.process.gmdice(cmd); // update the cmd string to contain the gmdice
                    eote.process.logger("eote.process.setup.gmDice", "New command: " + cmd);
                }
                var encumMatch = cmd.match(eote.defaults.regex.encum);
            
                if (encumMatch) {
                    diceObj = eote.process.encum(encumMatch, diceObj);
                    //eote.process.logger("eote.process.setup.encumMatch","New dice:" + diceObj);
                }
                var fatigueMatch = cmd.match(eote.defaults.regex.fatigue);
            
                if (fatigueMatch) {
                    diceObj = eote.process.fatigue(fatigueMatch, diceObj);
                    //eote.process.logger("eote.process.setup.encumMatch","New dice:" + diceObj);
                }
                
                var saturationMatch = cmd.match(eote.defaults.regex.saturation);
            
                if (saturationMatch) {
                    diceObj = eote.process.saturation(saturationMatch, diceObj);
                    //eote.process.logger("eote.process.setup.encumMatch","New dice:" + diceObj);
                }
            
                var combatMatch = cmd.match(eote.defaults.regex.combat);
                if (combatMatch) {
                    suggestionEngine.setCombatType(cmd[1]);
                } else {
                    suggestionEngine.setCombatType(null);
                }
            
                var skillMatch = cmd.match(eote.defaults.regex.skill);
                if (skillMatch) {
                    suggestionEngine.setIsFearCheck(getAttrByName(GMSheet.obj.id, "skill_suggestion_setting_fear"));
                    
                    var generalSuggestions = getAttrByName(GMSheet.obj.id, "skill_suggestion_setting_general");
                    log("generalSuggestions=" + generalSuggestions);
                    suggestionEngine.setGeneralSuggestions(generalSuggestions);
                    suggestionEngine.setIsFearCheck(getAttrByName(GMSheet.obj.id, "skill_suggestion_setting_fear"));
            
                    suggestionEngine.setDisplayOption(getAttrByName(GMSheet.obj.id, "skill_suggestion_setting_display"));
                    diceObj = eote.process.skill(skillMatch, diceObj);
                }
            
                var opposedMatch = cmd.match(eote.defaults.regex.opposed);
                if (opposedMatch) {
                    diceObj = eote.process.opposed(opposedMatch, diceObj);
                }
            
                var diceMatch = cmd.match(eote.defaults.regex.dice);
                if (diceMatch) {
                    diceObj = eote.process.setDice(diceMatch, diceObj);
                }
            
                var upgradeMatch = cmd.match(eote.defaults.regex.upgrade);
                if (upgradeMatch) {
                    diceObj = eote.process.upgrade(upgradeMatch, diceObj);
                }
            
                var downgradeMatch = cmd.match(eote.defaults.regex.downgrade);
                if (downgradeMatch) {
                    diceObj = eote.process.downgrade(downgradeMatch, diceObj);
                }
            
                /* Roll dice and update success / fail 
                 * ------------------------------------------------------------- */
                diceObj = eote.process.rollDice(diceObj);
            
                // process and display skill suggestions
                if (diceObj.vars.skillName != null || suggestionEngine.getCombatType() != null) {
                    diceObj = suggestionEngine.processSuggestions(diceObj);
                }
            
                /* Custom rolls
                 * Description: Custom dice components have their own message, results and
                 * often will return false to not allow proceeding scripts to fire
                 * --------------------------------------------------------------*/
                var resetdiceMatch = cmd.match(eote.defaults.regex.resetdice);
            
                if (resetdiceMatch) {
                    eote.process.resetdice(resetdiceMatch, diceObj);
                    return false;
                }
                var initiativeMatch = cmd.match(eote.defaults.regex.initiative);
            
                if (initiativeMatch) {
                    eote.process.initiative(initiativeMatch, diceObj);
                    //return false;
                }
                var destinyMatch = cmd.match(eote.defaults.regex.destiny);
            
                if (destinyMatch) {
                    eote.process.logger("eote.process.setup.destiny", "Destiny Point Command");
                    var doRoll = eote.process.destiny(destinyMatch, diceObj);
                    if (!doRoll) {
                        return false;
                    }
                }
                var critMatch = cmd.match(eote.defaults.regex.crit);
            
                if (critMatch) {
                    eote.process.crit(critMatch, diceObj);
                    return false;
                }
                var critShipMatch = cmd.match(eote.defaults.regex.critShip);
            
                if (critShipMatch) {
                    eote.process.crit(critShipMatch, diceObj);
                    return false;
                }
            
                /* Display dice output in chat window 
                 * ------------------------------------------------------------- */
                eote.process.diceOutput(diceObj, playerName, playerID);
            };
            
            /* DICE PROCESS FUNCTION
             * 
             * ---------------------------------------------------------------- */
            
            
            
            eote.process.log = function (cmd) {
            
                /* Log
                 * default: 'on' and 'single'
                 * Description: Sets the visual output in the chat window for the dice rolls
                 * Command: !eed log on|off|multi|single
                 * ---------------------------------------------------------------- */
            
                switch (cmd[1]) {
                    case "on": //if 'on' outputs dice to chat window
                        eote.defaults.globalVars.diceLogChat = true;
                        sendChat("Dice System", 'Output rolled dice to chat window "On"');
                        break;
                    case "off": //if 'off' outputs only results to chat window
                        eote.defaults.globalVars.diceLogChat = false;
                        sendChat("Dice System", 'Output rolled dice to chat window "Off"');
                        break;
                    case "multi": //if 'multi' multiple sets dice per line
                        eote.defaults.globalVars.diceLogRolledOnOneLine = false;
                        sendChat("Dice System", 'Multiple line output "Off". NOTE: This setting can cause issues with the Roll Templates. Recommended setting is !eed log single');
                        break;
                    case "single": //if 'single' single set of dice per line
                        eote.defaults.globalVars.diceLogRolledOnOneLine = true;
                        sendChat("Dice System", 'Multiple line output "On"');
                        break;
                }
            };
            
            eote.process.debug = function (cmd) {
                switch (cmd[1]) {
                    case "on":
                        eote.defaults.globalVars.debugScript = true;
                        sendChat("Dice System", 'Debug Script "On"');
                        break;
                    case "off":
                        eote.defaults.globalVars.debugScript = false;
                        sendChat("Dice System", 'Debug Script "Off"');
                        break;
                }
            };
            
            eote.process.fear = function (cmd) {
            
                /* Fear
                 * Description: Sets the state of the Fear check status on the DicePool
                 * Command: !eed fear on|off
                 * ---------------------------------------------------------------- */
            
                var value = null;
                switch (cmd[1]) {
                    case "off":
                        value = 0;
                        break;
                    case "on":
                        value = 1;
                        break;
                }
            
                if (value != null) {
                    eote.updateAddAttribute(GMSheet.obj, {
                        name: "skill_suggestion_setting_fear",
                        current: value,
                        update: true
                    });
                }
            };
            
            eote.process.suggestionDisplay = function (cmd) {
            
                /* SuggestionDisplay
                 * Description: Sets the state of the skill_suggestion_setting_display check status on the DicePool
                 * Command: !eed suggestionDisplay none|whisper|always
                 * ---------------------------------------------------------------- */
            
                /*TODO fix why suggestionDisplay is no longer working*/
                var value = (suggestionEngine.enum.displayOptions.hasOwnProperty(cmd[1]) ? cmd[1] : null);
            
                if (value != null) {
                    eote.updateAddAttribute(GMSheet.obj, {
                        name: "skill_suggestion_setting_display",
                        current: value,
                        update: true
                    });
                } else {
                    sendChat("Error", "/w gm " + cmd[1] + " is not a valid argument for suggestionDisplay.");
                }
            };
            
            eote.process.graphics = function (cmd) {
            
                /* Graphics
                 * default: 'on' and 'm'
                 * Description: Sets chat window dice output as graphic, small, medium, or large if "on" or as text if "off"
                 * Command: !eed graphics on|off|s|m|l
                 * ---------------------------------------------------------------- */
            
                //log(cmd[1]);
                switch (cmd[1]) {
                    case "on":
                        eote.defaults.globalVars.diceGraphicsChat = true;
                        sendChat("Dice System", 'Chat graphics "On"');
                        break;
                    case "off":
                        eote.defaults.globalVars.diceGraphicsChat = false;
                        sendChat("Dice System", 'Chat graphics "Off"');
                        break;
                    case "s":
                        eote.defaults.globalVars.diceGraphicsChatSize = eote.defaults.graphics.SIZE.SMALL;
                        sendChat("Dice System", 'Chat graphics size "Small"');
                        break;
                    case "m":
                        eote.defaults.globalVars.diceGraphicsChatSize = eote.defaults.graphics.SIZE.MEDIUM;
                        sendChat("Dice System", 'Chat graphics size "Medium"');
                        break;
                    case "l":
                        eote.defaults.globalVars.diceGraphicsChatSize = eote.defaults.graphics.SIZE.LARGE;
                        sendChat("Dice System", 'Chat graphics size "Large"');
                        break;
                }
            };
            
            eote.process.test = function (cmd) {
            
                eote.process.logger("eote.process.test", cmd);
            
                //Set test vars to true
                eote.defaults.globalVars.diceTestEnabled = true;
                tmpLogChat = eote.defaults.globalVars.diceLogChat;
                tmpGraphicsChat = eote.defaults.globalVars.diceGraphicsChat;
                eote.defaults.globalVars.diceLogChat = true;
                eote.defaults.globalVars.diceGraphicsChat = true;
            
                //Roll dice
                eote.process.setup('!eed 1b 1g 1y 1blk 1p 1r 1w', 'GM', 'Dice Test');
            
                //After test reset vars back
                eote.defaults.globalVars.diceTestEnabled = false;
                eote.defaults.globalVars.diceLogChat = tmpLogChat;
                eote.defaults.globalVars.diceGraphicsChat = tmpGraphicsChat;
            };
            
            eote.process.rollPlayer = function (cmd, diceObj) {
                //Build cmd string
                //get characterID
                //get skills
                //get encum
                //remove rollPlayer(xxxx) from string
                var match = {
                    skill: /skill:(.*?)[\|\)]/,
                    encum: /encum/,
                    fatigue: /fatigue/,
                    ammo: /ammo/,
                    saturation: /saturation/,
                    character: /character:(.*?)[\|\)]/
                };
                var characterMatch = cmd[1].match(match.character);
            
                var companion = null;
                var character = null;
                if (characterMatch) {
                    var charObj = findObjs({ _type: "character", name: characterMatch[1] });
            
                    if (charObj.length > 0) {
                        diceObj.vars.characterName = charObj[0].get('name');
                        diceObj.vars.characterID = charObj[0].id;
                    }
                    else {
                        sendChat("Alert", "Can't find character. Please update character, or npc, name field to match sheet character name and try again.");
                        return false;
                    }
                }
                else {
                    sendChat("Alert", "Please update character, or npc, name field.");
                    return false;
                }
                var encumMatch = cmd[1].match(match.encum);
                var attr_1 = null;
                var attr_2 = null;
                if (encumMatch) {
                    //encumbrance
                    attr_1 = getAttrByName(diceObj.vars.characterID, 'encumbrance', 'max');
                    attr_2 = getAttrByName(diceObj.vars.characterID, 'encumbrance');
                    var cmdEncum = ['encum(' + attr_1 + '|' + attr_2 + ')']; //["encum(3|5)"]
            
                    diceObj = eote.process.encum(cmdEncum, diceObj);
                }
                
             
                
                
                
                var skillMatch = cmd[1].match(match.skill);
                if (eote.defaults.globalVars.debugScript) sendChat("Alert", "skillmatch=" + skillMatch.toString());
            
                if (skillMatch) {
            
                    var attrArray = skillMatch[1].split(',');
                    attr_1 = getAttrByName(diceObj.vars.characterID, attrArray[0]);
                    attr_2 = getAttrByName(diceObj.vars.characterID, attrArray[1]);
            
                    if (eote.defaults.globalVars.debugScript) {
                        sendChat("Alert", "attr_1 = " + attr_1);
                        sendChat("Alert", "attr_2 = " + attr_2);
                    }
            
                    var cmdSkill;
                    if (!isNaN((parseFloat(attr_1)) && isFinite(attr_1))) { // is numeric
                        cmdSkill = ['skill(' + attr_1 + '|' + attr_2 + ')']; //['skill(0|2)']
                    } else {
                        var attr_3 = getAttrByName(diceObj.vars.characterID, attr_1.substr(2, attr_1.length - 3));
                        cmdSkill = ['skill(' + attr_3 + '|' + attr_2 + ')']; //['skill(0|2)']
                    }
            
                    diceObj = eote.process.skill(cmdSkill, diceObj);
                }
                return diceObj;
            };
            
            eote.process.destiny = function (cmd, diceObj) {
            
                var charObj_DicePool = findObjs({ _type: "character", name: "-GameMasterCharacterSheet" })[0];
                var doRoll = false;
            
                if (!charObj_DicePool) {
                    sendChat("GM", "/w " + "gm The -GameMasterCharacterSheet could not be found! Re-save this script and it should be recreated. In the future do not rename the -GameMasterCharacterSheet.");
                    return doRoll;
                }
                //GM's Destiny Point Pool
                var currentLightSidePoints = findObjs({
                    _characterid: charObj_DicePool.get("_id"),
                    _type: "attribute",
                    _name: "lightSidePoints"
                });
                var currentDarkSidePoints = findObjs({
                    _characterid: charObj_DicePool.get("_id"),
                    _type: "attribute",
                    _name: "darkSidePoints"
                });
                if (!currentDarkSidePoints[0] || !currentLightSidePoints[0]) {
                    sendChat("Dice System", "No Destiny Points Defined. The GM has been whispered with instructions to reset the Destiny Pool.");
                    sendChat("GM", "/w " + "gm The Destiny Pool system needs to be (or has been) reset. To fix this functionality, go to the -GameMasterCharacterSheet and add 1 GM Story Point and 1 Player Story Point point, then click the Force Player Update button. This should clear up the issue.");
                    return doRoll;
                }
                var darkSide = parseInt(currentDarkSidePoints[0].get("current"));
                var lightSide = parseInt(currentLightSidePoints[0].get("current"));
            
                var displayPool = '';
                //noinspection FallThroughInSwitchStatementJS
                switch (cmd[1]) {
                    case "useDark":
                        if (darkSide > 0) {
                            darkSide = darkSide - 1;
                            lightSide = lightSide + 1;
            
                            displayPool = '/direct &{template:base} {{title=' + 'The GM uses a GM Story Point' + '}}';
                            displayPool = displayPool + '{{GM Story points remaining=' + darkSide + '}}';
                            displayPool = displayPool + '{{New Player Story Point total=' + lightSide + '}}';
            
                            sendChat('Dice System', displayPool);
                        }
                        else {
                            sendChat("GM", "/w " + "gm There are no GM Story Points left in the Story Point Pool. Encourage your Players to use a Player Story Point.");
                            return doRoll;
                        }
                        break;
                    case "useLight":
                        if (lightSide > 0) {
                            lightSide = lightSide - 1;
                            darkSide = darkSide + 1;
            
                            displayPool = '/direct &{template:base} {{title=' + diceObj.vars.characterName + ' uses a Player Story Point' + '}}';
                            displayPool = displayPool + '{{New GM Story Point total=' + darkSide + '}}';
                            displayPool = displayPool + '{{Player Story Points remaining=' + lightSide + '}}';
            
                            sendChat('Dice System', displayPool);
                        }
                        else {
                            sendChat("Dice System", "/w " + diceObj.vars.characterName + " There are no Player Story Points left in the Story Point Pool. Suggest to your GM to use a GM Story Point to make one available.");
                            return doRoll;
                        }
                        break;
                    case "doRoll":
                        sendChat(diceObj.vars.characterName, '/direct Rolling a Destiny Point.');
                        doRoll = true;
                    // falls through on purpose (I think) to sync automatically when destiny point is rolled
                    case "registerPlayer":
                        if (!doRoll) {
                            sendChat("Dice System", "/w " + diceObj.vars.characterName + '&{template:base} {{title=Syncing your Story Point Pool to the GM\'s}}')
                        }
                        darkSide = darkSide + diceObj.totals.dark;
                        lightSide = lightSide + diceObj.totals.light;
            
                        //Register 
                        if (eote.defaults.destinyListeners.indexOf(diceObj.vars.characterID) == -1) {
                            eote.defaults.destinyListeners.push(diceObj.vars.characterID);
                        }
                        break;
                    case "sendUpdate":
                        sendChat("Dice System", "Updating Players' Story Point Pools");
                        break;
                    case "clearPool":
                        sendChat("Dice System", '&{template:base} {{title=The GM cleared the Story Point Pool}}');
                        lightSide = 0;
                        darkSide = 0;
                        break;
                }
                var newDestPool = [
                    {
                        name: 'lightSidePoints',
                        current: lightSide,
                        max: '',
                        update: true
                    },
                    {
                        name: 'darkSidePoints',
                        current: darkSide,
                        max: '',
                        update: true
                    }
                ];
                eote.updateListeners(newDestPool);
                return doRoll;
            };
            
            eote.process.characterID = function (cmd, diceObj) {
            
                /* CharacterId
                 * default: null
                 * Description: looks up the characters name based on character ID
                 * Command: !eed characterID(##########)
                 * ---------------------------------------------------------------- */
            
                eote.process.logger("eote.process.characterID", cmd);
            
                var characterID = cmd[1];
            
                if (characterID) {
            
                    diceObj.vars.characterName = getObj("character", characterID).get('name');
                    diceObj.vars.characterID = characterID;
                }
                return diceObj;
            };
            
            eote.process.label = function (cmd, diceObj) {
            
                /* Label
                 * default: null
                 * Description: set the skill name of the roll
                 * Command: !eed label(Name of Skill)
                 * ---------------------------------------------------------------- */
                //log(cmd);
            
                var label = cmd[1];
            
                if (label) {
            
                    var labelStr = '';
                    var labelArray = label.split('|');
            
                    _.each(labelArray, function (labelVal) {
                        var labelArray = labelVal.split(':');
                        var label = labelArray[0];
                        var message = labelArray[1];
                        var labelTest = label.toLowerCase();
            
                        switch (labelTest) {
                            case 'skill':
                                labelStr = '{{title=' + labelStr + message + '}}';
                                break;
                            case 'dice':
                                labelStr = '{{title=' + labelStr + message + '}}';
                                break;
                            case 'weapon':
                                labelStr = '{{title=' + labelStr + message + '}}';
                                break;
                            default:
                                labelStr = labelStr + '{{' + label + '=' + message + '}}';
                        }
            
                    });
                    diceObj.vars.label = labelStr;
                }
                return diceObj;
            };
            
            eote.process.resetdice = function (cmd, diceObj) {
            
                var characterObj = [{ name: diceObj.vars.characterName, id: diceObj.vars.characterID }];
                eote.process.logger("eote.process.resetdice", cmd);
                var resetdice = [];
            
                if (cmd[1] == 'resetdice') {
                    resetdice = [
                        {
                            name: "b",
                            current: 0,
                            update: true
                        },
                        {
                            name: "g",
                            current: 0,
                            update: true
                        },
                        {
                            name: "y",
                            current: 0,
                            update: true
                        },
                        {
                            name: "blk",
                            current: 0,
                            update: true
                        },
                        {
                            name: "r",
                            current: 0,
                            update: true
                        },
                        {
                            name: "p",
                            current: 0,
                            update: true
                        },
                        {
                            name: "upgradeAbility",
                            current: 0,
                            update: true
                        },
                        {
                            name: "downgradeProficiency",
                            current: 0,
                            update: true
                        },
                        {
                            name: "upgradeDifficulty",
                            current: 0,
                            update: true
                        },
                        {
                            name: "downgradeChallenge",
                            current: 0,
                            update: true
                        }
                    ]
                }
            
                if (cmd[1] == 'resetgmdice') {
                    resetdice = [
                        {
                            name: "bgm",
                            current: 0,
                            update: true
                        },
                        {
                            name: "ggm",
                            current: 0,
                            update: true
                        },
                        {
                            name: "ygm",
                            current: 0,
                            update: true
                        },
                        {
                            name: "blkgm",
                            current: 0,
                            update: true
                        },
                        {
                            name: "rgm",
                            current: 0,
                            update: true
                        },
                        {
                            name: "pgm",
                            current: 0,
                            update: true
                        },
                        {
                            name: "upgradeAbilitygm",
                            current: 0,
                            update: true
                        },
                        {
                            name: "downgradeProficiencygm",
                            current: 0,
                            update: true
                        },
                        {
                            name: "upgradeDifficultygm",
                            current: 0,
                            update: true
                        },
                        {
                            name: "downgradeChallengegm",
                            current: 0,
                            update: true
                        }
                    ]
                }
                eote.updateAddAttribute(characterObj, resetdice);
            };
            
            eote.process.initiative = function (cmd, diceObj) {

    /* initiative
     * default: false
     * Description: Set NPC/PC initiative true
     * Command: !eed npcinit or pcinit
     * ---------------------------------------------------------------- */
    
    var type = diceObj.vars.characterName;
    var NumSuccess = diceObj.totals.success;
    var NumAdvantage = diceObj.totals.advantage;
    var turnorder;

    eote.process.logger("eote.process.initiative.diceObj", diceObj);
    eote.process.logger("eote.process.initiative.NumSuccess", NumSuccess);
    eote.process.logger("eote.process.initiativeNumAdvantage", NumAdvantage);

    if (Campaign().get("turnorder") == "") turnorder = []; //NOTE: We check to make sure that the turnorder isn't just an empty string first. If it is treat it like an empty array.
    else turnorder = JSON.parse(Campaign().get("turnorder"));

  
    //Add a new custom entry to the end of the turn order.
    turnorder.push({
        id: "-1",
        pr: NumSuccess + ":" + NumAdvantage,
        custom: type
    });
    turnorder.sort(function (x, y) {
        // verify that x or y contains a colon, if it doesn't put it below
        if (x.toString().indexOf(":") < 1 || y.toString().indexOf(":") < 1) {
            return 1;
        } else {
            var a = x.pr.split(":");
            var b = y.pr.split(":");

            if (b[0] - a[0] != 0) {//First rank on successes
                return b[0] - a[0];
            } else if (b[1] - a[1] != 0) {//Then rank on Advantage
                return b[1] - a[1];
            } else { //If they are still tied, PC goes first

                if (x.custom == y.custom) {
                    return 0;
                } else if (x.custom == "NPC") {
                    return 1;
                } else {
                    return -1;
                }
            }
        }
    });
    Campaign().set("turnorder", JSON.stringify(turnorder));
};
            
            eote.process.crit = function (cmd, diceObj) {
            
                /* Crit
                 * default: 
                 * Description: Rolls critical injury table
                 * Command: !eed crit(roll) crit(roll|#) crit(heal|#)
                 * ---------------------------------------------------------------- */
            
                eote.process.logger("eote.process.crit", "");
            
                var characterObj = [{ name: diceObj.vars.characterName, id: diceObj.vars.characterID }];
                var critTableLifeform = [
                   {
                        percent: '1 to 2',
                        severity: 1,
                        name: 'Essoufflé',
                        Result: 'Vous encaissez 1 Fatigue.'
                    },
                    {
                        percent: '3 to 3',
                        severity: 1,
                        name: 'Ralenti',
                        Result: 'Vous devrez agir en dernier lors du prochain round de combat.'
                    },
                    {
                        percent: '4 to 4',
                        severity: 1,
                        name: 'Claquage',
                        Result: 'Vous êtes Ralenti lors de votre prochain tour de jeu.'
                    },
                    {
                        percent: '5 to 5',
                        severity: 1,
                        name: 'Déséquilibré',
                        Result: 'Vous ajoutez 1blk à votre prochain test.'
                    },
                    {
                        percent: '6 to 6',
                        severity: 1,
                        name: 'Secoué',
                        Result: 'Vous ajoutez 1r à votre prochain test.'
                    },
                    {
                        percent: '7 to 7',
                        severity: 1,
                        name: 'Étourdi',
                        Result: 'Vous encaissez 1 Fatigue et êtes Hébété.'
                    },
                    {
                        percent: '8 to 8',
                        severity: 1,
                        name: 'Assommé',
                        Result: 'Vous subissez la Condition Assommée (2).'
                    },
                    //----------------------------- Severity 2
                    {
                        percent: '9 to 9',
                        severity: 2,
                        name: 'Renversé',
                        Result: 'Vous êtes jeté à terre et encaissez 1 Fatigue.'
                    },
                    {
                        percent: '10 to 10',
                        severity: 2,
                        name: 'Sonné',
                        Result: 'Jusqu\'à la fin de la rencontre, vous ajoutez 1blk à tous vos tests d\'Intelligence et d\'Instinct.'
                    },
                    {
                        percent: '11 to 11',
                        severity: 2,
                        name: 'Blessure effrayante',
                        Result: 'Jusqu\'à la fin de la rencontre, vous ajoutez 1blk à tous vos tests de Force Mentale et de Présence.'
                    },
                    {
                        percent: '12 to 12',
                        severity: 2,
                        name: 'Blessure handicapante',
                        Result: 'Jusqu\'à la fin de la rencontre, vous ajoutez 1blk à tous vos tests de Force et d\'Agilité.'
                    },
                    {
                        percent: '13 to 13',
                        severity: 2,
                        name: 'Stupéfié',
                        Result: 'Jusqu\'à la fin de la rencontre, vous ajoutez 1blk à tous vos tests.'
                    },
                    {
                        percent: '14 to 14',
                        severity: 2,
                        name: 'Rupture',
                        Result: 'Vous encaissez 2 Fatigues.'
                    },
                    {
                        percent: '15 to 15',
                        severity: 2,
                        name: 'Ankylosé',
                        Result: 'Vous êtes Hébété jusqu\'à la fin de la rencontre.'
                    },
                    {
                        percent: '16 to 16',
                        severity: 2,
                        name: 'Déstabilisé',
                        Result: 'Jusqu\'à la fin de la rencontre, vous réduisez votre Défense de 1.'
                    },
                    {
                        percent: '17 to 17',
                        severity: 2,
                        name: 'Essoufflé',
                        Result: 'Vous encaissez 2 Fatigues et, jusqu\'à la fin de la rencontre, vous ne pouvez plus choisir de subir de la Fatigue pour déclencher une capacité, un talent ou recourir à une manœuvre supplémentaire.'
                    },
                    {
                        percent: '18 to 18',
                        severity: 3,
                        name: 'Épuisé',
                        Result: 'Jusqu\'à la fin de la rencontre, vous ajoutez 2blk à tous vos tests.'
                    },
                    //---------------------------------------- Severity 3
                    {
                        percent: '19 to 19',
                        severity: 2,
                        name: 'Saignement',
                        Result: 'Jusqu\'à ce que cette Blessure critique soit soignée, vous encaissez 1 Fatigue au début de chaque tour de jeu.'
                    },
                    {
                        percent: '20 to 20',
                        severity: 3,
                        name: 'Bras mutilé',
                        Result: 'Un de vos bras est sérieusement endommagé. Jusqu\'à ce que cette Blessure critique soit soignée (ou que ce bras soit remplacé par une prothèse cybernétique), vous ajoutez 1blk à tous vos tests. '
                    },
                    {
                        percent: '21 to 21',
                        severity: 3,
                        name: 'Boiteux',
                        Result: 'Jusqu\'à ce que cette Blessure critique soit soignée, vous êtes Ralenti.'
                    },
                    {
                        percent: '22 to 22',
                        severity: 3,
                        name: 'Bras arraché',
                        Result: 'Un de vos bras est arraché. Jusqu\'à ce que vous le remplaciez par une prothèse cybernétique, vous ne pouvez pas soigner cette Blessure critique et vous ajoutez 1blk à tous vos tests. De plus, vous ne pouvez plus utiliser d\'équipement qui nécessite l\'usage des deux mains. '
                    },
                    {
                        percent: '23 to 23',
                        severity: 3,
                        name: 'Jambe arrachée',
                        Result: 'Une de vos jambes est arrachée. Jusqu\'à ce que vous la remplaciez par une prothèse cybernétique, vous ne pouvez pas soigner cette Blessure critique, vous êtes Ralenti et vous ajoutez 2blk à tous vos tests. '
                    },
                    {
                        percent: '24 to 24',
                        severity: 3,
                        name: 'Blessure grave',
                        Result: 'Lancez 1d10 : résultat (1-2 = Force, 3-4 = Agilité, 5-6 = Endurance, 7 = Intelligence, 8 = Instinct, 9 = Présence, 10 = Force Mentale. Jusqu\'à ce que cette Blessure critique soit soignée, la Caractéristique obtenue est réduite de 1.'
                    },
                    {
                        percent: '25 to 25',
                        severity: 3,
                        name: 'Organe interne endommagé',
                        Result: 'Jusqu\'à ce que vous ayez recours à la cybernétique (cœur ou système respiratoire bionique), vous ne pouvez pas soigner cette Blessure Critique et vous réduisez votre Seuil de Fatigue de 2.'
                    },
                    
                    //---------------------------------------- Severity 4
                    {
                        percent: '26 to 26',
                        severity: 4,
                        name: 'Séquelle macabre',
                        Result: 'Lancez 1d10 : résultat (1-2 = Force, 3-4 = Agilité, 5-6 = Endurance, 7 = Intelligence, 8 = Instinct, 9 = Présence, 10 = Force Mentale. La Caractéristique obtenue est définitivement réduite de 1. Cette réduction impacte également votre valeur Maximale. '
                    },
                    {
                        percent: '27 to 28',
                        severity: 4,
                        name: 'Hémorragie',
                        Result: 'Jusqu\'à ce que cette Blessure critique soit soignée, vous subissez 1 Blessure et 1 Fatigue au début de chacun de vos tour de jeu. Cet effet ne peut pas vous faire subir de Blessure critique.'
                    },
                    {
                        percent: '29 to 30',
                        severity: 4,
                        name: 'La fin est proche',
                        Result: 'Si cette Blessure critique n\'est pas soignée avant la fin du prochain round de combat, vous mourrez.'
                    },
                    {
                        percent: '31',
                        severity: 4,
                        name: 'Mort',
                        Result: 'Vous mourrez, tout simplement.'
                    }
                ];
            
                var critTableChocPeur = [
                    {
                        percent: '1 to 4',
                        severity: '',
                        name: 'Choc',
                        Result: 'Vous êtes Hébété sous le coup de la surprise et de l’effroi. '
                    },
                    {
                        percent: '5 to 8',
                        severity: '',
                        name: 'Tremblement',
                        Result: 'La peur s’empare de vous et vous vous mettez à trembler. Ajoutez 1blk à tous vos tests pour le reste de la rencontre.'
                    },
                    {
                        percent: '9 to 12',
                        severity: '',
                        name: 'Titubant',
                        Result: 'Vacillant d’effroi, vous reculez devant la source de votre terreur. Vous ne pouvez pas l’approcher volontairement, mais restez capable d’agir normalement, en ajoutant 1blk à tous vos tests jusqu’à la fin de la rencontre. De plus, vous gagnez 1 point de Folie.'
                    },
                    {
                        percent: '13 to 16',
                        severity: '',
                        name: 'Paralysé',
                        Result: 'Vous êtes paralysé par la terreur. Vous ne pouvez entreprendre aucune action/Manoeuvre pendant 1d5 rounds. Une fois le choc surmonté, vous gagnez 1d5 points de Folie et ajoutez 1blk à tous vos tests jusqu’à la fin de la rencontre. '
                    },
                    {
                        percent: '17 to 20',
                        severity: '',
                        name: 'Panique',
                        Result: 'La panique s’empare de vous.  Vous gagnez 1d5 points de Folie et vous devez fuir la source de votre peur si vous le pouvez, aussi vite que possible, et si quelque chose vous en empêche, vous êtes Hébété et ajoutez 1r à tous vos tests. Une fois écarté du danger, vous pouvez tenter de surmonter le choc. '
                    },
                    {
                        percent: '21 to 24',
                        severity: '',
                        name: 'Inconscience',
                        Result: 'Vous gagnez 1d5 points de Folie et vous vous effondrez, évanoui, et demeurez inconscient pendant 1d5 rounds. Une fois que vous reprennez conscience, vous restez secoué et ajoutez 1blk à tous vos tests jusqu’à la fin de la rencontre. '
                    },
                    {
                        percent: '25 to 28',
                        severity: '',
                        name: 'Hystérie',
                        Result: 'Vous gagnez 1d5 points de Folie et vous éclatez d’un rire hystérique et, dans un état de frénésie démente, attaquez toutes les créatures proche de vous, faisant feu au hasard ou utilisant n’importe quelle arme que vous avez sous la main. Cet effet dure jusqu’à ce que vous soyez Assommé ou que vous sombriez dans l\'insconcience. '
                    },
                    {
                        percent: '29',
                        severity: '',
                        name: 'Annihilation',
                        Result: 'Vous gagnez 1d5+1 points de Folie et vous vous affaissez au sol pendant 1d5+1 rounds en sanglotant, en bafouillant et en arrachant votre propre peau. Vous ne pouvez rien faire d’autre. Même quand vous reprennez vos esprits, vous êtes complètement annihilé et ajoutez 1r à tous vos tests jusqu’à la fin de la rencontre.'
                    }
                 
                ];
                var critTableFolie = [
                            {
                        Percent: '1 to 1',
                        severity: 'Énigme ou Trauma',
                        name: 'Agoraphobie',
                        Result: 'Les masses grouillantes de l\'humanité se pressent autour de vous… vous devez trouver un abri sûr et tranquille ! En combat, vous encaissez 1 Fatigue si vous terminez votre tour de jeu avec plus de 5 individus dans un rayon de 6 ps. '
                    },
                    {
                        percent: '2 to 2',
                        severity: 'Énigme',
                        name: 'Xénophobie',
                        Result: 'On ne peut pas leur faire confiance. À aucun d\'entre eux ! Augmentez de 1 la Difficulté de tous vos tests de Présence avec des xenos.'
                    },
                    {
                        percent: '3 to 3',
                        severity: 'Chaos ou Surnaturel',
                        name: 'Funeste intuition',
                        Result: 'Vous avez obtenu un aperçu des horreurs à venir et chaque fois qu\'une autre de ces révélations se confirme, votre désespoir augmente. Vous encaissez 1 Fatigue à chaque fois que vous réussissez un test de Discipline.'
                    },
                    {
                        percent: '4 to 4',
                        severity: 'Surnaturel ou Violence',
                        name: 'Terreur débilitante',
                        Result: 'Que l\'Empereur est pitié de moi ! Nous allons tous mourir ! Lorsque vous ratez un test de Peur, vous encaissez 2 Fatigues. '
                    },
                    {
                        percent: '5 to 5',
                        severity: 'Énigme',
                        name: 'Égoïsme',
                        Result: 'Je peux me débrouiller tout seul ! Je n\'ai pas besoin de votre aide ! Vous ne pouvez pas bénéficiez d\'une manœuvre d\'Assistance ou de b bonus offert par un allié. De plus, vous encaissez 1 Fatigue lorsque vous recourez vous-même à cette manœuvre ou que vous offrez des b à un allié. '
                    },
                    {
                        percent: '6 to 6',
                        severity: 'Chaos ou Énigme',
                        name: 'Fatalisme',
                        Result: 'Vous n\'avez plus foi en rien. De sombres pensées broient petit à petit votre esprit. Ajoutez 1blk à vos tests de Résistance. '
                    },
                    {
                        percent: '7 to 7',
                        severity: 'Trauma ou Violence',
                        name: 'Trouillard',
                        Result: 'Certains vous traitent de couard... Vous avez tout simplement une conscience aigüe du danger qui vous entoure. Vous encaissez 1 Fatigue si vous terminez votre tour de jeu engagé avec plus d\'ennemis que d\'alliés. '
                    },
                    {
                        percent: '8 to 8',
                        severity: 'Énigme ou Violence',
                        name: 'Autophobie',
                        Result: 'La solitude est la chose la plus terrible au monde. En combat, vous encaissez 1 Fatigue si vous terminez votre tour de jeu sans aucun allié dans un rayon de 3ps.'
                    },
                     {
                        percent: '9 to 9',
                        severity: 'Énigme ou Surnaturel',
                        name: 'Cauchemar sans fin',
                        Result: 'Quand vous dormez, vous êtes assailli de terrifiantes visions d\'abominations. Après que vous vous soyez reposé, vous encaissez 2 Fatigues. '
                    },
                    {
                        percent: '10 to 10',
                        severity: 'Chaos ou Trauma',
                        name: 'Nerfs fragiles',
                        Result: 'Vous avez vu trop de choses horribles... Ajoutez 1blk à vos tests de Discipline, d\'Intimidation et de Commandement.'
                    },
                     {
                        percent: '11 to 11',
                        severity: 'Énigme ou Trauma',
                        name: 'Outrecuidance',
                        Result: 'Comment osez-vous douter de moi? J\'ai des années, que dis-je des décennies d\'expérience de plus que vous dan ce domaine ! Ajoutez 2blk à vos tests de Charisme et de Duperie.'
                    },
                    {
                        percent: '12 to 12',
                        severity: 'Surnaturel ou Violence',
                        name: 'Trépidation',
                        Result: 'Vous êtes terrifié à l\'idée d\'agir ou de prendre une mauvaise décision. Ajoutez 1blk à vos tests d\'Initiative. '
                    },
                    {
                        percent: '13 to 13',
                        severity: 'Énigme ou Trauma',
                        name: 'Manque d\'assurance',
                        Result: 'Vous étiez sûr à peu près de savoir ce que vous faisiez, mais maintenant que vous y pensez, vous en êtes de moins en moins sûr... Ajoutez 1blk à tous vos tests de Compétences générales dont le rang est de 3 ou plus.'
                    },
                    {
                        percent: '14 to 14',
                        severity: 'Énigme ou Surnaturel',
                        name: 'Désir contre nature',
                        Result: 'Tant de choix si tentant... En prendre un petit bout de ferait de mal à personne, non? Je me demande quel goût il a... Ajoutez 1blk à vos tests d\'Instinct.'
                    },
                    {
                        percent: '15 to 15',
                        severity: 'Surnaturel ou Trauma',
                        name: 'Amnésie',
                        Result: 'Par bonheur, vous avez du mal à vous rappelez les détails de cet horrible incident. Malheureusement, vous avez du mal à simplement vous rappelez quoi que ce soit. Ajoutez 1blk à vos tests d\'Intelligence.'
                    },
                    {
                        percent: '16 to 16',
                        severity: 'Trauma ou Violence',
                        name: 'Léthargie',
                        Result: 'Je vais peut être resté assis là. Allez-y sans moi, je vais juste me reposer un peu... Ajoutez 1blk à vos tests de Force. '
                    },
                    {
                        percent: '17 to 17',
                        severity: 'Chaos ou Violence',
                        name: 'Tremblote',
                        Result: 'Ignorez vos tremblements, tout va bien. N\'y pensez pas... Ajoutez 1blk à vos tests d\'Agilité.'
                    },
                    {
                        percent: '18 to 18',
                        severity: 'Chaos ou Trauma',
                        name: 'Suspicieux',
                        Result: 'Vous ne faite plus confiance à personne. Ajoutez 1blk à vos tests de Présence.'
                    },
                    {
                        percent: '19 to 19',
                        severity: 'Énigme ou Violence',
                        name: 'Souvenirs macabres',
                        Result: 'Vous ne cessez de vous remémorez des évènements douloureux. Ajoutez 1blk à vos tests de Force Mentale.'
                    },
                    {
                        percent: '20 to 20',
                        severity: 'Surnaturel ou Violence',
                        name: 'Phobie du pourrissement',
                        Result: 'Tout le monde prétend que vous avez bonne mine, que vous ne dégagez pas une odeur de chair pourrie, mais vous n\'êtes pas dupe ! Ajoutez 1blk à vos tests d\'Endurance.'
                    },
                    {
                        percent: '21 to 21',
                        severity: 'Énigme',
                        name: 'Appât du gain',
                        Result: 'Je le veux... tous pour moi ! Plus, toujours plus ! Ajoutez 2r à vos tests de Commerce.'
                    },
                    {
                        percent: '22 to 22',
                        severity: 'Surnaturel ou Trauma',
                        name: 'Vision funeste',
                        Result: 'L\'image de votre trauma se matérialise parfois juste sous vos yeux, tandis que la bile vous monte à la gorge. Lorsque vous encaissez au moins 1 Fatigue, vous en encaissez 1 de plus.'
                    },
                    {
                        percent: '23 to 23',
                        severity: 'Chaos ou Violence',
                        name: 'Peur oppressante',
                        Result: 'Ce monde est plein de créatures qui veulent votre mort. L\'une d\'elles finira bien par y arriver un jour... Vous encaissez 1 Fatigue à chaque fois que vous subissez 1 Blessure ou plus. '
                    },
                    {
                        percent: '24 to 24',
                        severity: 'Surnaturel ou Violence',
                        name: 'Angoissé',
                        Result: 'Concentrez-vous. Respirez. Ce n\'est pas le moment de s\'effondrer. Réduisez votre Seuil de Fatigue de 2.'
                    },
                    {
                        percent: '25 to 25',
                        severity: 'Chaos ou Violence',
                        name: 'Furie irrationelle',
                        Result: 'Du Sang pour le Dieu du S... de quoi j\'parlais déjà ? En combat, vous encaissez 1 Fatigue si vous n\'attaquez pas durant votre tour. '
                    },
                     {
                        percent: '26 to 26',
                        severity: 'Trauma ou Violence',
                        name: 'Fantasme d\'invulnérabilité',
                        Result: 'rien ne peut vous tuer. La bénédiction de l\'Empereur coule dans vos veines ! Pour fuir un combat ou vous désengager d’un corps à corps, vous devez réussir un test de Discipline Difficulté (3).' 
                    },
                            {
                        percent: '27 to 27',
                        severity: 'Énigme ou Trauma',
                        name: 'Folie des grandeurs',
                        Result: 'Ne vous avisez pas de me faire part de votre avis ! Vous êtes indigne de mon attention, je vous suis supérieur en tout point ! À moins d\'être en combat, à chaque fois que vous ratez un test de Compétences générales, vous subissez 1 Fatigue. '
                    }
                 
                ];
                var critTableCorruption = [
                    {
                        percent: '1 to 2',
                        severity: 'Malignité',
                        name: 'Maladie de peau',
                        Result: 'Vous êtes victime de furoncles, de croûtes, de plaies suppurantes et autres. Ajoutez 2r à vos tests de Charisme.'
                    },
                    {
                        percent: '3 to 4',
                        severity: 'Malignité',
                        name: 'Goût de cendre',
                        Result: 'Toute nourriture et toute boisson ont un goût épouvantable et vous nourri peu, tandis que vous supporter à peine de manger quoi que ce soit. Lorsque vous éliminez de la Fatigue, éliminez-en 1 de moins. '
                    },
                    {
                        percent: '5 to 6',
                        severity: 'Malignité',
                        name: 'Soif de sang',
                        Result: 'Vous êtes toujours au bord de la crise de rage meurtrière. Quand vous êtes blessé au combat, vous devez réussir un test de Discipline Difficile (3) sous peine de devoir tuer tous vos opposants, même quand vous voudriez les garder en vie. '
                    },
                    {
                        percent: '7 to 8',
                        severity: 'Malignité',
                        name: 'Morbide ',
                        Result: 'Vous avez du mal à vous concentrer, car votre esprit est empli de visions macabres et de pensées torturées et sinistres. Ajoutez 1r à vos tests de Logique et réduisez vos points de Compétence par session de 1.'
                    },
                    {
                        percent: '9 to 10',
                        severity: 'Malignité',
                        name: 'Dessèchement',
                        Result: 'Vous devenez d’une pâleur cadavérique et vos muscles s’atrophient. Ajoutez 1r à vos tests d\'Athlétisme et réduisez les dégâts de vos armes de corps à corps de 1.'
                    },
                    {
                        percent: '11 to 12',
                        severity: 'Malignité',
                        name: 'Cœur de pierre',
                        Result: 'Vous devenez de plus en plus cruel, inhumain et vindicatif. Ajoutez 1r à vos tests de Présence.'
                    },
                    {
                        percent: '13 to 14',
                        severity: 'Malignité',
                        name: 'Santé fragile',
                        Result: 'Vous êtes constamment victime d’insignifiantes maladies et de douleurs fantômes, et vos blessures semblent ne jamais guérir entièrement. Ajoutez 1r aux tests de Médicae visant à vous soigner.'
                    },
                    {
                        percent: '15 to 16',
                        severity: 'Malignité',
                        name: 'Les yeux du malin',
                        Result: 'Le monde semble s’assombrir, se ternir et pourrir littéralement dès que vous vous attardez trop à observer quoi que ce soit. Ajoutez 1r à vos tests de Vigilance et d’Observation.'
                    },
                    {
                        percent: '17',
                        severity: 'Mutation',
                        name: 'Mutation',
                        Result: 'Relancez sur la table des mutations.'
                    }
                ];
                var critTableMutation = [
                    {
                        percent: '1 to 2',
                        severity: 'Mutation',
                        name: 'Grotesque',
                        Result: 'Vous êtes difforme, couturé de cicatrices ou bestial. Ajoutez 1r à vos tests de Présence et vos tests d’Intimidation sont maintenant basés sur votre Force.'
                    },
                    {
                        percent: '3 to 4',
                        severity: 'Mutation',
                        name: 'Déformé',
                        Result: 'Votre épine dorsale ou vos membres sont atrocement difforme. Ajoutez 1blk à vos tests d\'Initiative et de Coordination et réduisez votre valeur de Mouvement de 1. '
                    },
                    {
                        percent: '5 to 6',
                        severity: 'Mutation',
                        name: 'Nocturne',
                        Result: 'Vous gagnez le Trait Nyctalope. '
                    },
                    {
                        percent: '7 to 8',
                        severity: 'Mutation',
                        name: 'Peau dure ',
                        Result: 'Vous augmentez votre valeur d\'Encaissement de 1 grâce à la densité de votre peau et de vos tissus cutanés.'
                    },
                    {
                        percent: '9 to 10',
                        severity: 'Mutation',
                        name: 'Brute',
                        Result: 'Vous êtes fort et arboré une masse musculaire impressionnante. Ajoutez 1b à vos tests d\'Athlétisme et de Résistance et 2blk à vos tests de Coordination.'
                    },
                    {
                        percent: '11 to 12',
                        severity: 'Mutation',
                        name: 'Griffes / crocs',
                        Result: 'Vous êtes dotés de griffes tranchantes, d\'une gueule garnie de crocs ou de tout autres appendices comptant comme une arme naturelle.'
                    },
                    {
                        percent: '13 to 14',
                        severity: 'Mutation',
                        name: 'Sens surnaturels',
                        Result: 'Vous êtes dotés d\'une ouïe perçante, d\'une détection des vibrations ou d\'une vision psychique. Vous gagnez le Trait Sens surnaturels (6).'
                    },
                    {
                        percent: '15 to 16',
                        severity: 'Mutation',
                        name: 'Corpulent',
                        Result: 'Vous êtes imposant et bouffi. Augmentez votre Seuil de blessure de 2 et ajoutez 1b à vos tests de Résistance.'
                    },
                    {
                        percent: '17 to 18',
                        severity: 'Mutation',
                        name: 'Vile alacrité',
                        Result: 'Vous trépidé et bouger sans cesse, vous déplaçant à la vitesse de l\'éclair. Augmentez votre valeur de Mouvement de 2 et ajoutez 2b à vos tests de Coordination.'
                    },
                    {
                        percent: '19 to 20',
                        severity: 'Mutation',
                        name: 'Force repoussante',
                        Result: 'Votre musculature est au-dela de l\'humain. Ajoutez 1b à vos tests d\'Athlétisme et augmentez vos Dégâts aux corps à corps de 1. '
                    },
                    {
                        percent: '21 to 24',
                        severity: 'Mutation',
                        name: 'Rejeton de l\'ombre',
                        Result: 'Vous n\'avez plus qu\'une faible emprise sur la réalité et vous pouvez filer dans le Warp quand bon vous semble. Vous gagnez le Trait Phase, mais vous réduisez de manière permanente votre valeur de Force et d\'Endurance de 1. Cette réduction affecte également leur valeur maximale, qui passe à 4 au lieu de 5. '
                    },
                    {
                        percent: '25',
                        severity: 'Mutation',
                        name: 'Rejeton des enfers',
                        Result: 'Saturé des énergies du Warp, vous débordé d\'une vigueur démoniaque. Vous gagnez les Traits Au-delà, Démoniaque (X) et Peur (2). X est égal à votre Degré de Corruption. '
                    }
                ];
            
                var critTableMachine = [
                    {
                        percent: '1 to 4',
                        severity: 1,
                        name: 'Secoué',
                        Result: 'Le véhicule subit 1 Saturation et chaque membre de son équipage encaisse 1 Fatigue. '
                    },
                    {
                        percent: '5 to 7',
                        severity: 1,
                        name: 'Shrapnel',
                        Result: 'Le véhicule subit 1 Saturation et une pièce de métal chauffée à blanc est projetée dans l\'habitacle. Tous les membres d\'équipages subissent 5 Blessures, -1 par Succès obtenu sur un test de Résistance ou de Vigilance Difficile (3). '
                    },
                    {
                        percent: '8 to 10',
                        severity: 1,
                        name: 'Coque endommagée',
                        Result: 'Le véhicule réduit sa valeur d\'Encaissement de moitié (arrondit à l\'inférieur).'
                    },
                    // --------------- severity : 2
                    {
                        percent: '11 to 13',
                        severity: 2,
                        name: 'Navigation endommagée',
                        Result: 'La valeur de Manœuvrabilité du véhicule passe à -3.'
                    },
                    
                    {
                        percent: '14 to 16',
                        severity: 2,
                        name: 'Propulsion endommagée',
                        Result: 'Le véhicule subit 1 Saturation et il ne peut se déplacer qu\'en ligne droite. Sa Vitesse tactique est réduite de moitié (arrondit à l\'inférieur). '
                    },
                    {
                        percent: '17 to 20',
                        severity: 2,
                        name: 'Blindage endommagée',
                        Result: 'Le véhicule subit 1 Saturation et toutes ses valeurs de Défense passe à 0.'
                    },
                    // --------------- severity : 3
                    {
                        percent: '21 to 25',
                        severity: 3,
                        name: 'Armement endommagé',
                        Result: 'Le véhicule subit 1 Saturation et un de ses armements est hors service. '
                    },
                    {
                        percent: '26 to 27',
                        severity: 3,
                        name: 'Propulsion détruite',
                        Result: 'Le véhicule subit 2 Saturations et est immobilisé. Il ne peut plus pivoter ou se déplacer.'
                    },
                    // --------------- severity : 4
                    {
                        percent: '28 to 30',
                        severity: 4,
                        name: 'Systèmes HS',
                        Result: 'Le véhicule subit 2 Saturations et n\'est plus qu\'une épave. Tout son armement et ses équipements (radio, radar, lumière, ect...) sont inutilisables.'
                    },
                    {
                        percent: '31 to 33',
                        severity: 4,
                        name: 'En feu !',
                        Result: 'Le véhicule subit 2 Saturations et prend feu ! Tous les occupants de ce dernier subissent des dégâts environnementaux de dangerosité 3. Le feu peut être éteint en réussissant un (ou plusieurs si le véhicule est grand) test d\'Athlétisme ou de Discipline Difficile (3).'
                    },
                    {
                        percent: '34 to 36',
                        severity: 4,
                        name: 'Explosion imminante',
                        Result: 'Le véhicule s\'appréte à exploser. À la fin du round de combat, il explose. Tous les occupants encore à bord à ce moment sont tués. '
                    },
                    {
                        percent: '37',
                        severity: 4,
                        name: 'Vaporisé',
                        Result: 'Le véhicule est complètement détruit, consommé par une gigantesque boule de feu. Personne ne survit.'
                    }
                ];;
                var critRoll = function (addCritNum, type) {
                    var openSlot = false;
                    var diceRoll = '';
                    var critMod = '';
                    var rollTotal = '';
                    var rollOffset = parseInt(getAttrByName(diceObj.vars.characterID, type + '-critAddOffset'));
                    rollOffset = rollOffset ? rollOffset : 0;
                    var totalcrits = parseInt(getAttrByName(diceObj.vars.characterID, type + '-critTotal'));
                    if (!totalcrits) {
                        totalcrits = 0;
                    }
            
                    //roll random
                    if (!addCritNum) {
                        diceRoll = randomInteger(20);
                        critMod = (totalcrits * 2);
                        rollTotal = diceRoll + critMod + rollOffset;
                        rollTotal = rollTotal < 1 ? 1 : rollTotal;
                        eote.process.logger("critRoll", "diceRoll: " + diceRoll);
                        eote.process.logger("critRoll", "critMod: " + critMod);
                        eote.process.logger("critRoll", "rollTotal " + rollTotal);
                    } else {
                        rollTotal = parseInt(addCritNum);
                    }
                    //find crit in critical table
                    if (type == "character" || type == "npc" || type == "companion" || type == "beast") {
                        critTable = critTableLifeform;
                    }
                    if (type == "starship" || type == "vehicle") {
                        critTable = critTableMachine;
                    }
                    if (type == "folie") {
                        critTable = critTableFolie;
                    }
                     if (type == "chocpeur") {
                        critTable = critTableChocPeur;
                    }
                    if (type == "corruption") {
                        critTable = critTableCorruption;
                    }
                    if (type == "mutation") {
                        critTable = critTableMutation;
                    }
                    for (var key in critTable) {
                        var percent = critTable[key].percent.split(' to ');
                        var low = parseInt(percent[0]);
                        var high = percent[1] ? parseInt(percent[1]) : 1000;
            
                        if ((rollTotal >= low) && (rollTotal <= high)) {
            
                            critAttrs = [
                                {
                                    name: type + '-critTotal',
                                    current: totalcrits + 1,
                                    max: '',
                                    update: true
                                },
                            ];
                            critAttrs2 = [
                                {
                                    name: type + '-critName',
                                    current: critTable[key].name,
                                    max: '',
                                    update: true
                                },
                                {
                                    name: type + '-critSeverity',
                                    current: critTable[key].severity,
                                    max: '',
                                    update: true
                                },
                                {
                                    name: type + '-critRange',
                                    current: critTable[key].percent,
                                    max: '',
                                    update: true
                                },
                                {
                                    name: type + '-critSummary',
                                    current: critTable[key].Result,
                                    max: '',
                                    update: true
                                },
                            ];
                            var chat = '/direct &{template:base} {{title=' + diceObj.vars.characterName + '}}';
                            chat = chat + '{{Mod. de base=' + totalcrits + ' x 2}}';
                            if (rollOffset) {
                                chat = chat + '{{Mod. au jet=' + rollOffset + '}}';
                            }
                            chat = chat + '{{Jet de dé (1d20)=' + diceRoll + '}}';
                            chat = chat + '{{Total=' + rollTotal + '}}';
                            chat = chat + '{{wide=<b>' + critTable[key].name + '</b><br>';
                            chat = chat + critTable[key].Result + '<br>}}';
            
                            sendChat(diceObj.vars.characterName, chat);
                        }
                    }
                    eote.updateAddAttribute(characterObj, critAttrs);
                    eote.process.createRepeatingCrit(type, characterObj, critAttrs2);
                };
                
                var critHeal = function (critID, type) {
                    log(critID);
                    log(type);
                    var rowid = critID;
                    var regex = new RegExp('^repeating_.*?_' + rowid + '_.*?$');
                    var attrsInRow = filterObjs(function (obj) {
                        if (obj.get('type') !== 'attribute' || obj.get('characterid') !== diceObj.vars.characterID) return false;
                        return regex.test(obj.get('name'));
                    });
                    _.each(attrsInRow, function (attribute) {//loop characters
                        attribute.remove();
                    });
                    var totalcrits = parseInt(getAttrByName(diceObj.vars.characterID, type + '-critTotal'));
                    critAttrs = [
                        {
                            name: type + '-critTotal',
                            current: totalcrits - 1,
                            max: '',
                            update: true
                        },
            
                    ];
                    eote.updateAddAttribute(characterObj, critAttrs);
                };
                var critArray = cmd[1].split('|');
                var command = critArray[0];
                var type = critArray[1] ? critArray[1] : null;
                var input = critArray[2] ? critArray[2] : null;
            
                if (type == null) {
                    sendChat("Alert", "Type not supplied. Needs character, companion or beast");
                    return;
                }
            
                if (command == 'heal') {
                    critHeal(input, type);
                } else if (command == 'add') {
                    critRoll(input, type);
                } else { // crit(roll)
                    critRoll(null, type);
                }
            };
            
            
            
            //-----------------------------------
            eote.process.createRepeatingCrit = function (type, charactersObj, critAttrs) {
                eote.process.logger("repeating", "repeating");
                eote.process.logger("type", type);
                eote.process.logger("critAttrs", critAttrs);
                var newId = eote.process.generateRowID();
                //check if object or array
                if (!_.isArray(charactersObj)) {
                    charactersObj = [charactersObj];
                }
                if (!_.isArray(critAttrs)) {
                    critAttrs = [critAttrs];
                }
                var characterId = "";
                _.each(charactersObj, function (characterObj) {//loop characters
            
                    var characterName = '';
            
                    if (characterObj.name) {
                        characterName = characterObj.name;
                    } else {
                        characterName = characterObj.get('name');
                    }
                    characterId = characterObj.id;
                    //find attribute via character ID
                    var characterAttributesObj = findObjs({ _type: "attribute", characterid: characterObj.id });
            
                    if (critAttrs.length != 0) {
            
                        log('UPDATE/ADD ATTRIBUTES FOR:--->' + characterName);
            
                        _.each(critAttrs, function (critAttr) { //loop attributes to update / add
            
                            attr = _.find(characterAttributesObj, function (a) {
                                return (a.get('name') === critAttr.name);
                            });
                            if (attr) {
                                if (critAttr.update) {
                                    log('Update Attr: ' + critAttr.name);
                                    attr.set({ current: critAttr.current });
                                    attr.set({ max: critAttr.max ? critAttr.max : '' });
                                }
                            } else {
                                log('Add Attr: ' + critAttr.name);
                                log('Value: ' + critAttr.current);
                                eote.createObj('attribute', {
                                    characterid: characterObj.id,
                                    name: "repeating_crit" + type + "_" + newId + "_" + critAttr.name,
                                    current: critAttr.current,
                                    max: critAttr.max ? critAttr.max : ''
                                });
                            }
                        });
                    }
                });
                eote.createObj('attribute', {
                    characterid: characterId,
                    name: "repeating_crit" + type + "_" + newId + "_" + type + "-critId",
                    current: newId
                });
            
            };
            
            
            
            eote.process.generateRowID = function () {
                "use strict";
                var a = 0, b = [];
                var c = (new Date()).getTime() + 0, d = c === a;
                a = c;
                for (var e = new Array(8), f = 7; 0 <= f; f--) {
                    e[f] = "-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz".charAt(c % 64);
                    c = Math.floor(c / 64);
                }
                c = e.join("");
                if (d) {
                    for (f = 11; 0 <= f && 63 === b[f]; f--) {
                        b[f] = 0;
                    }
                    b[f]++;
                } else {
                    for (f = 0; 12 > f; f++) {
                        b[f] = Math.floor(64 * Math.random());
                    }
                }
                for (f = 0; 12 > f; f++) {
                    c += "-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz".charAt(b[f]);
                }
                return c.replace(/_/g, "Z");
            };
            
            
            eote.process.gmdice = function (cmd) {
            
                /* gmdice
                 * default: 
                 * Description: Update CMD string to include -GameMasterCharacterSheet dice
                 * Command: (gmdice)
                 * ---------------------------------------------------------------- */
            
                //var charObj = findObjs({ _type: "character", name: "-GameMasterCharacterSheet" });
                var charID = eote.defaults['-GameMasterCharacterSheetID'];//charObj[0].id;
            
                var g = getAttrByName(charID, 'ggm');
                var y = getAttrByName(charID, 'ygm');
                var p = getAttrByName(charID, 'pgm');
                var r = getAttrByName(charID, 'rgm');
                var b = getAttrByName(charID, 'bgm');
                var blk = getAttrByName(charID, 'blkgm');
                var upAbility = getAttrByName(charID, 'upgradeAbilitygm');
                var upDifficulty = getAttrByName(charID, 'upgradeDifficultygm');
                var downProficiency = getAttrByName(charID, 'downgradeProficiencygm');
                var downChallenge = getAttrByName(charID, 'downgradeChallengegm');
            
                var gmdiceCMD = g + 'g ' + y + 'y ' + p + 'p ' + r + 'r ' + b + 'b ' + blk + 'blk ' + ' upgrade(ability|' + upAbility + ') downgrade(proficiency|' + downProficiency + ') upgrade(difficulty|' + upDifficulty + ') downgrade(challenge|' + downChallenge + ')';
            
                eote.process.logger("eote.process.gmDice.charID", charID);
                cmd = cmd.replace('(gmdice)', gmdiceCMD);
                //log(cmd);
                return cmd;
            };
            
            eote.process.encum = function (cmd, diceObj) {
            
                /* Encumberment
                 * default: 
                 * Description: If the current encum is great than threshold add 1 setback per unit over current encum
                 * Command: !eed encum(encum_current|encum_threshold)
                 * ---------------------------------------------------------------- */
            
                eote.process.logger("eote.process.encum", cmd);
            
                _.each(cmd, function (encum) {
            
                    var diceArray = encum.match(/\((.*?)\|(.*?)\)/);
            
                    if (diceArray && diceArray[1] && diceArray[2]) {
            
                        var num1 = eote.process.math(diceArray[1]);
                        var num2 = eote.process.math(diceArray[2]);
                        var setbackDice = diceObj.count.setback;
            
                        if (num2 > num1) {
                            diceObj.count.setback = setbackDice + (num2 - num1);
                            eote.process.logger("eote.process.encum.NewSetbackTotal", diceObj.count.setback + "blk");
                            //sendChat("Dice System", "/w " + diceObj.vars.characterName + " **Overencumbered** " + diceObj.count.setback + " Setbacks added");
                        }
                        else {
                            eote.process.logger("eote.process.encum", "No New Setback");
                        }
                    }
                });
                return diceObj;
            };
            
            eote.process.fatigue = function (cmd, diceObj) {
            
                /* Fatigue
                 * default: 
                 * Description: If the current Fatigue is great than carac add 1 setback per unit over current carac
                 * Command: !eed fatigue(strain|Carac)
                 * ---------------------------------------------------------------- */
            
                eote.process.logger("eote.process.fatigue", cmd);
            
                _.each(cmd, function (fatigue) {
            
                    var diceArray = fatigue.match(/\((.*?)\|(.*?)\)/);
            
                    if (diceArray && diceArray[1] && diceArray[2]) {
            
                        var num1 = eote.process.math(diceArray[1]);
                        var num2 = eote.process.math(diceArray[2]);
                        var num3 = num2 - num1
                        var setbackDice = diceObj.count.setback;
            
                        if (num3 > 0) {
                            diceObj.count.setback = setbackDice + num3;
                            eote.process.logger("eote.process.fatigue.NewSetbackTotal", diceObj.count.setback + "blk");
                            //sendChat("Dice System", "/w " + diceObj.vars.characterName + " **Overencumbered** " + diceObj.count.setback + " Setbacks added");
                        }
                        if (num3 > 3) {
                            diceObj.count.setback = setbackDice + 3;
                            eote.process.logger("eote.process.fatigue.NewSetbackTotal", diceObj.count.setback + "blk");
                            //sendChat("Dice System", "/w " + diceObj.vars.characterName + " **Overencumbered** " + diceObj.count.setback + " Setbacks added");
                        }
                        
                        else {
                            eote.process.logger("eote.process.fatigue", "No New Setback");
                        }
                    }
                });
                return diceObj;
            };
            
            
            eote.process.saturation = function (cmd, diceObj) {
            
                /* saturation
                 * default: 
                 * Description: If the current saturation is great than carac add 1 setback per unit over current carac
                 * Command: !eed saturation(strain|Carac)
                 * ---------------------------------------------------------------- */
            
                eote.process.logger("eote.process.saturation", cmd);
            
                _.each(cmd, function (saturation) {
            
                    var diceArray = saturation.match(/\((.*?)\|(.*?)\)/);
            
                    if (diceArray && diceArray[1] && diceArray[2]) {
            
                        var num1 = eote.process.math(diceArray[1]);
                        var num2 = eote.process.math(diceArray[2]);
                        var setbackDice = diceObj.count.setback;
            
                        if (num2 > num1) {
                            diceObj.count.setback = setbackDice + (num2 - num1);
                            eote.process.logger("eote.process.saturation.NewSetbackTotal", diceObj.count.setback + "blk");
                            //sendChat("Dice System", "/w " + diceObj.vars.characterName + " **Overencumbered** " + diceObj.count.setback + " Setbacks added");
                        }
                        else {
                            eote.process.logger("eote.process.saturation", "No New Setback");
                        }
                    }
                });
                return diceObj;
            };
            
            eote.process.skill = function (cmd, diceObj) {
            
                /* Skill
                 * default: 
                 * Description: create the ability and proficiency dice for a skill check
                 * Command: !eed skill(char_value|skill_value|[NPC minion group size]|[Is minion skill])
                 * ---------------------------------------------------------------- */
            
                eote.process.logger("eote.process.skill", cmd);
            
                _.each(cmd, function (skill) {
                    var matchers = {
                        matchNPCGroupWSkillName: /\((.*?)\|(.*?)\|(.*?)\|(.*?)\|(.*?)\)/,
                        matchNPCGroupWOSkillName: /\((.*?)\|(.*?)\|(.*?)\|(.*?)\)/,
                        matchRegSkillWSkillName: /\((.*?)\|(.*?)\|(.*?)\)/,
                        matchRegSkillWOSkillName: /\((.*?)\|(.*?)\)/
                    };
                    var diceArray = null;
                    Object.keys(matchers).some(function (key) {
                        if ((diceArray = skill.match(matchers[key])) != null) {
                            return true;
                        }
                    });
            
                    if (diceArray && diceArray[1] && diceArray[2]) {
                        var num1 = eote.process.math(diceArray[1]);
                        if (diceArray[3] && diceArray[4] && diceArray[4] === "1") {
                            num1 += (eote.process.math(diceArray[3]) - 1);
                        }
                        var num2 = eote.process.math(diceArray[2]);
                        var totalAbil = Math.abs(num1 - num2);
                        var totalProf = (num1 < num2 ? num1 : num2);
                        var abilityDice = diceObj.count.ability;
                        var proficiencyDice = diceObj.count.proficiency;
            
                        diceObj.count.ability = abilityDice + totalAbil;
                        diceObj.count.proficiency = proficiencyDice + totalProf;
            
                        // check for skill name
                        if (diceArray[5] || diceArray[3] && !diceArray[4]) {
                            var name = (diceArray[5] ? diceArray[5] : diceArray[3]);
            
                            /*  remove all non-letter characters to bring the name in line with the JSON properties
                             *  in order to have the closest chance in getting a match.
                             *
                             *  does not guarantee a match.
                             */
                            name = name.replace(/[^A-Za-z]/g, "");
            
                            diceObj.vars.skillName = name;
                        } else {
                            diceObj.vars.skillName = null;
                        }
            
                        eote.process.logger("eote.process.skill.abilityTotal", diceObj.count.ability + "g");
                        eote.process.logger("eote.process.skill.proficiencyTotal", diceObj.count.proficiency + "y");
                    }
            
                });
                return diceObj;
            };
            
            
            eote.process.setDice = function (cmd, diceObj) {
            
                /* setDice
                 * default: 
                 * Description: Loop thru the dice and adds or subtracts them from the dice object
                 * Command: !eed g# y# b# blk# r# p# w# or g#+# or g#-#
                 * ---------------------------------------------------------------- */
            
                eote.process.logger("eote.process.setDice", cmd);
            
                _.each(cmd, function (dice) {
            
                    var diceArray = dice.match(/(-?\d{1,2})(\w{1,3})/);
            
                    if (diceArray && diceArray[1] && diceArray[2]) {
            
                        var diceQty = eote.process.math(diceArray[1]);
                        diceQty = (isNaN(diceQty) ? 0 : diceQty);
            
                        var abilityDice = diceObj.count.ability;
                        var proficiencyDice = diceObj.count.proficiency;
                        var difficultyDice = diceObj.count.difficulty;
                        var challengeDice = diceObj.count.challenge;
                        var boostDice = diceObj.count.boost;
                        var setbackDice = diceObj.count.setback;
                        var success = diceObj.count.success;
                        var advantage = diceObj.count.advantage;
                        var threat = diceObj.count.threat;
                        var failure = diceObj.count.failure;
            
                        switch (diceArray[2]) {
                            case 'b':
                                diceObj.count.boost = boostDice + diceQty;
                                break;
                            case 'g':
                                diceObj.count.ability = abilityDice + diceQty;
                                break;
                            case 'y':
                                diceObj.count.proficiency = proficiencyDice + diceQty;
                                break;
                            case 'blk':
                                diceObj.count.setback = setbackDice + diceQty;
                                break;
                            case 'p':
                                diceObj.count.difficulty = difficultyDice + diceQty;
                                break;
                            case 'r':
                                diceObj.count.challenge = challengeDice + diceQty;
                                break;
                            case 's':
                                diceObj.count.success = success + diceQty;
                                break;
                            case 'a':
                                diceObj.count.advantage = advantage + diceQty;
                                break;
                            case 't':
                                diceObj.count.threat = threat + diceQty;
                                break;
                            case 'f':
                                diceObj.count.failure = failure + diceQty;
                                break;
                        }
                    }
                });
                diceObj = eote.process.checkNegative(diceObj);
            
                eote.process.logger("eote.process.setDice.DiceToRoll", diceObj.count.boost + "b," + diceObj.count.ability + "g," + diceObj.count.proficiency + "y," + diceObj.count.setback + "blk," + diceObj.count.difficulty + "p," + diceObj.count.challenge + "r," + diceObj.count.advantage + "a," + diceObj.count.threat + "t," + diceObj.count.failure + "f");
            
                return diceObj;
            };
            
            eote.process.checkNegative = function (diceObj) {
                if (diceObj.count.boost < 0) {
                    eote.process.logger("eote.process.checkNegative.boost", "Setting count to 0 for being negative.");
                    diceObj.count.boost = 0;
                }
                if (diceObj.count.ability < 0) {
                    eote.process.logger("eote.process.checkNegative.ability", "Setting count to 0 for being negative.");
                    diceObj.count.ability = 0;
                }
                if (diceObj.count.proficiency < 0) {
                    eote.process.logger("eote.process.checkNegative.proficiency", "Setting count to 0 for being negative.");
                    diceObj.count.proficiency = 0;
                }
                if (diceObj.count.setback < 0) {
                    eote.process.logger("eote.process.checkNegative.setback", "Setting count to 0 for being negative.");
                    diceObj.count.setback = 0;
                }
                if (diceObj.count.difficulty < 0) {
                    eote.process.logger("eote.process.checkNegative.difficulty", "Setting count to 0 for being negative.");
                    diceObj.count.difficulty = 0;
                }
                if (diceObj.count.challenge < 0) {
                    eote.process.logger("eote.process.checkNegative.challenge", "Setting count to 0 for being negative.");
                    diceObj.count.challenge = 0;
                }
                if (diceObj.count.success < 0) {
                    eote.process.logger("eote.process.checkNegative.success", "Setting count to 0 for being negative.");
                    diceObj.count.success = 0;
                }
                if (diceObj.count.advantage < 0) {
                    eote.process.logger("eote.process.checkNegative.advantage", "Setting count to 0 for being negative.");
                    diceObj.count.advantage = 0;
                }
                if (diceObj.count.threat < 0) {
                    eote.process.logger("eote.process.checkNegative.threat", "Setting count to 0 for being negative.");
                    diceObj.count.threat = 0;
                }
                if (diceObj.count.failure < 0) {
                    eote.process.logger("eote.process.checkNegative.failure", "Setting count to 0 for being negative.");
                    diceObj.count.failure = 0;
                }
                return diceObj;
            };
            
            eote.process.upgrade = function (cmd, diceObj) {
            
                /* Upgrade
                 * default: 
                 * Description: upgrades ability and difficulty dice
                 * Command: !eed upgrade(ability|#) or upgrade(difficulty|#)
                 * ---------------------------------------------------------------- */
            
                eote.process.logger("eote.process.upgrade", cmd);
            
                _.each(cmd, function (dice) {
            
                    var diceArray = dice.match(/\((.*?)\|(.*?)\)/);
            
                    if (diceArray && diceArray[1] && diceArray[2]) {
            
                        var type = diceArray[1];
                        var upgradeVal = eote.process.math(diceArray[2]);
                        var abilityDice = diceObj.count.ability;
                        var proficiencyDice = diceObj.count.proficiency;
                        var difficultyDice = diceObj.count.difficulty;
                        var challengeDice = diceObj.count.challenge;
            
                        switch (type) {
                            case 'ability':
            
                                var totalProf = (upgradeVal < abilityDice ? upgradeVal : abilityDice);
                                var totalAbil = Math.abs(upgradeVal - abilityDice);
            
                                if (upgradeVal > abilityDice) {
                                    totalProf = totalProf + Math.floor(totalAbil / 2);
                                    totalAbil = totalAbil % 2;
                                }
                                diceObj.count.ability = totalAbil;
                                diceObj.count.proficiency = proficiencyDice + totalProf;
            
                                eote.process.logger("eote.process.upgrade.abilityTotal", diceObj.count.ability + "g");
                                eote.process.logger("eote.process.upgrade.proficiencyTotal", diceObj.count.proficiency + "y");
            
                                break;
                            case 'difficulty':
            
                                var totalChall = (upgradeVal < difficultyDice ? upgradeVal : difficultyDice);
                                var totalDiff = Math.abs(upgradeVal - difficultyDice);
            
                                if (upgradeVal > difficultyDice) {
                                    totalChall = totalChall + Math.floor(totalDiff / 2);
                                    totalDiff = totalDiff % 2;
                                }
                                diceObj.count.difficulty = totalDiff;
                                diceObj.count.challenge = challengeDice + totalChall;
            
                                eote.process.logger("eote.process.upgrade.difficultyTotal", diceObj.count.difficulty + "p");
                                eote.process.logger("eote.process.upgrade.challengeTotal", diceObj.count.challenge + "r");
            
                                break;
                        }
                    }
                });
                return diceObj;
            };
            //Fix this code
            eote.process.downgrade = function (cmd, diceObj) {
            
                /* Downgrade
                 * default: 
                 * Description: downgrades proficiency and challenge dice
                 * Command: !eed downgrade(proficiency|#) or downgrade(challenge|#)
                 * ---------------------------------------------------------------- */
            
                eote.process.logger("eote.process.downgrade", cmd);
            
                _.each(cmd, function (dice) {
            
                    var diceArray = dice.match(/\((.*?)\|(.*?)\)/);
            
                    if (diceArray && diceArray[1] && diceArray[2]) {
            
                        var type = diceArray[1];
                        var downgradeVal = eote.process.math(diceArray[2]);
                        var abilityDice = diceObj.count.ability;
                        var proficiencyDice = diceObj.count.proficiency;
                        var difficultyDice = diceObj.count.difficulty;
                        var challengeDice = diceObj.count.challenge;
            
                        switch (type) {
                            case 'proficiency':
            
                                var profConvertedToAbil = proficiencyDice * 2;
            
                                if (downgradeVal > (abilityDice + profConvertedToAbil)) {
                                    diceObj.count.ability = 0;
                                    diceObj.count.proficiency = 0;
                                } else if (downgradeVal > profConvertedToAbil) {
                                    downgradeVal = Math.abs(downgradeVal - profConvertedToAbil);
                                    diceObj.count.ability = Math.abs(downgradeVal - abilityDice);
                                    diceObj.count.proficiency = 0;
                                } else {
                                    diceObj.count.ability = abilityDice + (profConvertedToAbil - downgradeVal) % 2;
                                    diceObj.count.proficiency = Math.floor((profConvertedToAbil - downgradeVal) / 2);
                                }
                                break;
                            case 'challenge':
            
                                var challConvertedToDiff = challengeDice * 2;
            
                                if (downgradeVal > (difficultyDice + challConvertedToDiff)) {
                                    diceObj.count.difficulty = 0;
                                    diceObj.count.challenge = 0;
                                } else if (downgradeVal > challConvertedToDiff) {
                                    downgradeVal = Math.abs(downgradeVal - challConvertedToDiff);
                                    diceObj.count.difficulty = Math.abs(downgradeVal - difficultyDice);
                                    diceObj.count.challenge = 0;
                                } else {
                                    diceObj.count.difficulty = difficultyDice + (challConvertedToDiff - downgradeVal) % 2;
                                    diceObj.count.challenge = Math.floor((challConvertedToDiff - downgradeVal) / 2);
                                }
                                break;
                        }
                    }
                });
                return diceObj;
            };
            //End Fix this code
            eote.process.math = function (expr) {
            
                /* Math
                 * Returns: Number
                 * Description: Evaluates a mathematical expression (as a string) and return the result 
                 * ---------------------------------------------------------------- */
            
                var chars = expr.split("");
                var n = [], op = [], index = 0, oplast = true;
            
                n[index] = "";
            
                // Parse the expression
                for (var c = 0; c < chars.length; c++) {
            
                    if (isNaN(parseInt(chars[c])) && chars[c] !== "." && !oplast) {
                        op[index] = chars[c];
                        index++;
                        n[index] = "";
                        oplast = true;
                    } else {
                        n[index] += chars[c];
                        oplast = false;
                    }
                }
                // Calculate the expression
                expr = parseFloat(n[0]);
                for (var o = 0; o < op.length; o++) {
                    var num = parseFloat(n[o + 1]);
                    switch (op[o]) {
                        case "+":
                            expr = expr + num;
                            break;
                        case "-":
                            expr = expr - num;
                            break;
                        case "*":
                            expr = expr * num;
                            break;
                        case "/":
                            expr = expr / num;
                            break;
                    }
                }
                return expr;
            };
            
            eote.process.addDiceValues = function (diceTotalObj, diceResult) {
            
                diceTotalObj.success = diceTotalObj.success + diceResult.success;
                diceTotalObj.failure = diceTotalObj.failure + diceResult.failure;
                diceTotalObj.advantage = diceTotalObj.advantage + diceResult.advantage;
                diceTotalObj.threat = diceTotalObj.threat + diceResult.threat;
                diceTotalObj.triumph = diceTotalObj.triumph + diceResult.triumph;
                diceTotalObj.despair = diceTotalObj.despair + diceResult.despair;
                diceTotalObj.light = diceTotalObj.light + diceResult.light;
                diceTotalObj.dark = diceTotalObj.dark + diceResult.dark;
            
                return diceTotalObj;
            };
            
            eote.process.totalDiceValues = function (diceTotalObj) {
            
                var diceTS = {
                    success: 0,
                    failure: 0,
                    advantage: 0,
                    threat: 0,
                    triumph: 0,
                    despair: 0,
                    light: 0,
                    dark: 0,
                    diceGraphicsLog: "",
                    diceTextLog: ""
                };
                var i = 0;
            
                i = diceTotalObj.success - diceTotalObj.failure;
            
                if (i >= 0) {
                    diceTS.success = i;
                } else {
                    diceTS.failure = Math.abs(i);
                }
                
                
                i = diceTotalObj.advantage - diceTotalObj.threat;
            
                if (i >= 0) {
                    diceTS.advantage = i;
                } else {
                    diceTS.threat = Math.abs(i);
                }
                
                
                i = diceTotalObj.triumph - diceTotalObj.despair;
            
                if (i >= 0) {
                    diceTS.triumph = i;
                } else {
                    diceTS.despair = Math.abs(i);
                }
                
                diceTS.light = diceTotalObj.light;
                diceTS.dark = diceTotalObj.dark;
            
                return diceTS;
            };
            
            eote.process.rollDice = function (diceObj) {
            
                results = {
                    success: 0,
                    failure: 0,
                    advantage: 0,
                    threat: 0,
                    triumph: 0,
                    despair: 0,
                    light: 0,
                    dark: 0,
                    diceGraphicsLog: '',
                    diceTextLog: ''
                };
                eote.process.logger("eote.process.rollDice.FinalDiceToRoll", diceObj.count.boost + "b," + diceObj.count.ability + "g," + diceObj.count.proficiency + "y," + diceObj.count.setback + "blk," + diceObj.count.difficulty + "p," + diceObj.count.challenge + "r," + diceObj.count.advantage + "a," + diceObj.count.threat + "t," + diceObj.count.failure + "f");
            
                //Blue "Boost" die (d6)
                if (diceObj.count.boost > 0) {
                    results = eote.roll.boost(diceObj.count.boost);
                    diceObj.graphicsLog.Boost = results.diceGraphicsLog;
                    diceObj.textLog.Boost = results.diceTextLog;
                    diceObj.totals = eote.process.addDiceValues(diceObj.totals, results);
                }
                //Green "Ability" die (d8) 
                if (diceObj.count.ability > 0) {
                    results = eote.roll.ability(diceObj.count.ability);
                    diceObj.graphicsLog.Ability = results.diceGraphicsLog;
                    diceObj.textLog.Ability = results.diceTextLog;
                    diceObj.totals = eote.process.addDiceValues(diceObj.totals, results);
                }
                //Yellow "Proficiency" die (d12)
                if (diceObj.count.proficiency > 0) {
                    results = eote.roll.proficiency(diceObj.count.proficiency);
                    diceObj.graphicsLog.Proficiency = results.diceGraphicsLog;
                    diceObj.textLog.Proficiency = results.diceTextLog;
                    diceObj.totals = eote.process.addDiceValues(diceObj.totals, results);
                }
                //Black "SetBack" die (d6)
                if (diceObj.count.setback > 0) {
                    results = eote.roll.setback(diceObj.count.setback);
                    diceObj.graphicsLog.SetBack = results.diceGraphicsLog;
                    diceObj.textLog.SetBack = results.diceTextLog;
                    diceObj.totals = eote.process.addDiceValues(diceObj.totals, results);
                }
                //Purple "Difficulty" die (d8)
                if (diceObj.count.difficulty > 0) {
                    results = eote.roll.difficulty(diceObj.count.difficulty);
                    diceObj.graphicsLog.Difficulty = results.diceGraphicsLog;
                    diceObj.textLog.Difficulty = results.diceTextLog;
                    diceObj.totals = eote.process.addDiceValues(diceObj.totals, results);
                }
                //Red "Challenge" die (d12)
                if (diceObj.count.challenge > 0) {
                    results = eote.roll.challenge(diceObj.count.challenge);
                    diceObj.graphicsLog.Challenge = results.diceGraphicsLog;
                    diceObj.textLog.Challenge = results.diceTextLog;
                    diceObj.totals = eote.process.addDiceValues(diceObj.totals, results);
                }
                // Free Successes (from skills)
                if (diceObj.count.success > 0) {
                    results = eote.roll.success(diceObj.count.success);
                    diceObj.graphicsLog.Success = results.diceGraphicsLog;
                    diceObj.textLog.Success = results.diceTextLog;
                    diceObj.totals = eote.process.addDiceValues(diceObj.totals, results);
                }
                // Free Advantage (from skills)
                if (diceObj.count.advantage > 0) {
                    results = eote.roll.advantage(diceObj.count.advantage);
                    diceObj.graphicsLog.Advantage = results.diceGraphicsLog;
                    diceObj.textLog.Advantage = results.diceTextLog;
                    diceObj.totals = eote.process.addDiceValues(diceObj.totals, results);
                }
                //Free Threat (from skills)
                if (diceObj.count.threat > 0) {
                    results = eote.roll.threat(diceObj.count.threat);
                    diceObj.graphicsLog.Threat = results.diceGraphicsLog;
                    diceObj.textLog.Threat = results.diceTextLog;
                    diceObj.totals = eote.process.addDiceValues(diceObj.totals, results);
                }
                // Free Failure (from skills)
                if (diceObj.count.failure > 0) {
                    results = eote.roll.failure(diceObj.count.failure);
                    diceObj.graphicsLog.Failure = results.diceGraphicsLog;
                    diceObj.textLog.Failure = results.diceTextLog;
                    diceObj.totals = eote.process.addDiceValues(diceObj.totals, results);
                }
                //finds the sum of each dice attribute
                diceObj.totals = eote.process.totalDiceValues(diceObj.totals);
                return diceObj;
            };
            
            eote.process.diceOutput = function (diceObj, playerName, playerID) {
            
                //log(diceObj);
                var s1 = '<img src="';
                var s2 = '" title="';
                var s3 = '" height="';
                var s4 = '" width="';
                var s5 = '"/>';
                var chatGlobal = '';
                var diceGraphicsResults = "";
                var diceGraphicsRolled = "";
                var diceTextRolled = "";
                var diceTextResults = "";
            
                diceTextResults = "[";
                if (diceObj.totals.success > 0) {
                    diceTextResults = diceTextResults + " Success:" + diceObj.totals.success;
                    for (i = 1; i <= diceObj.totals.success; i++) {
                        diceGraphicsResults = diceGraphicsResults + s1 + eote.defaults.graphics.SYMBOLS.S + s2 + "Succès" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                }
                if (diceObj.totals.failure > 0) {
                    diceTextResults = diceTextResults + " Fail:" + diceObj.totals.failure;
                    for (i = 1; i <= diceObj.totals.failure; i++) {
                        diceGraphicsResults = diceGraphicsResults + s1 + eote.defaults.graphics.SYMBOLS.F + s2 + "Échec" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                }
                if (diceObj.totals.advantage > 0) {
                    diceTextResults = diceTextResults + " Advant:" + diceObj.totals.advantage;
                    for (i = 1; i <= diceObj.totals.advantage; i++) {
                        diceGraphicsResults = diceGraphicsResults + s1 + eote.defaults.graphics.SYMBOLS.A + s2 + "Avantage" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                }
                if (diceObj.totals.threat > 0) {
                    diceTextResults = diceTextResults + " Threat:" + diceObj.totals.threat;
                    for (i = 1; i <= diceObj.totals.threat; i++) {
                        diceGraphicsResults = diceGraphicsResults + s1 + eote.defaults.graphics.SYMBOLS.T + s2 + "Handicap" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                }
                if (diceObj.totals.triumph > 0) {
                    diceTextResults = diceTextResults + " Triumph:" + diceObj.totals.triumph;
                    for (i = 1; i <= diceObj.totals.triumph; i++) {
                        diceGraphicsResults = diceGraphicsResults + s1 + eote.defaults.graphics.SYMBOLS.TRIUMPH + s2 + "Critique" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                }
                if (diceObj.totals.despair > 0) {
                    diceTextResults = diceTextResults + " Despair:" + diceObj.totals.despair;
                    for (i = 1; i <= diceObj.totals.despair; i++) {
                        diceGraphicsResults = diceGraphicsResults + s1 + eote.defaults.graphics.SYMBOLS.DESPAIR + s2 + "Désastre" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                }
                if (diceObj.totals.light > 0) {
                    diceTextResults = diceTextResults + " Light:" + diceObj.totals.light;
            
                    for (i = 1; i <= diceObj.totals.light; i++) {
                        diceGraphicsResults = diceGraphicsResults + s1 + eote.defaults.graphics.SYMBOLS.L + s2 + "Light" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                }
                if (diceObj.totals.dark > 0) {
                    diceTextResults = diceTextResults + " Dark:" + diceObj.totals.dark;
                    for (i = 1; i <= diceObj.totals.dark; i++) {
                        diceGraphicsResults = diceGraphicsResults + s1 + eote.defaults.graphics.SYMBOLS.D + s2 + "Dark" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                }
                diceTextResults = diceTextResults + "]";
                //------------------------------------>
                if (eote.defaults.globalVars.diceTestEnabled === true) {
                    characterPlayer = 'TEST';
                } else if (diceObj.vars.characterName) {
                    characterPlayer = diceObj.vars.characterName;
                } else {
                    characterPlayer = playerName;
                }
            
                var templateName = (diceObj.vars.suggestions.suggestionsExist
                    && suggestionEngine.getDisplayOption() == suggestionEngine.enum.displayOptions.always ? "suggestion" : "base");
            
                /*Dice roll images work just fine when whispered*/
                var label = diceObj.vars.label;
                if (eote.defaults.globalVars.diceTestEnabled === true) {
                    chatGlobal = "/direct <br>6b 8g 12y 6blk 8p 12r 12w <br>";
                } else if (label) {
                    chatGlobal = "/direct &{template:" + templateName + "} " + diceObj.vars.label + "{{subtitle=" + characterPlayer + "}}";
                } else {
                    chatGlobal = "/direct &{template:" + templateName + "} {{title=" + characterPlayer + "}}";
                }
                //------------------------------------>
                if (eote.defaults.globalVars.diceLogChat === true) {
                    if (eote.defaults.globalVars.diceLogRolledOnOneLine === true) {
            
                        diceGraphicsRolled = diceObj.graphicsLog.Boost + diceObj.graphicsLog.Ability + diceObj.graphicsLog.Proficiency + diceObj.graphicsLog.SetBack + diceObj.graphicsLog.Difficulty + diceObj.graphicsLog.Challenge + diceObj.graphicsLog.Success + diceObj.graphicsLog.Advantage + diceObj.graphicsLog.Failure + diceObj.graphicsLog.Threat;
            
                        if (diceObj.textLog.Boost != "") diceTextRolled = diceTextRolled + "Boost:" + diceObj.textLog.Boost;
                        if (diceObj.textLog.Ability != "") diceTextRolled = diceTextRolled + "Ability:" + diceObj.textLog.Ability;
                        if (diceObj.textLog.Proficiency != "") diceTextRolled = diceTextRolled + "Proficiency:" + diceObj.textLog.Proficiency;
                        if (diceObj.textLog.SetBack != "") diceTextRolled = diceTextRolled + "SetBack:" + diceObj.textLog.SetBack;
                        if (diceObj.textLog.Difficulty != "") diceTextRolled = diceTextRolled + "Difficulty:" + diceObj.textLog.Difficulty;
                        if (diceObj.textLog.Challenge != "") diceTextRolled = diceTextRolled + "Challenge:" + diceObj.textLog.Challenge;
                        if (diceObj.textLog.Success != "") diceTextRolled = diceTextRolled + "Success:" + diceObj.textLog.Success;
                        if (diceObj.textLog.Advantage != "") diceTextRolled = diceTextRolled + "Advantage:" + diceObj.textLog.Advantage;
                        if (diceObj.textLog.Failure != "") diceTextRolled = diceGraphicsRolled + "Failure:" + diceObj.textLog.Failure;
                        if (diceObj.textLog.Threat != "") diceTextRolled = diceGraphicsRolled + "Threat:" + diceObj.textLog.Threat;
            
                        if (eote.defaults.globalVars.diceGraphicsChat === true) {
                            chatGlobal = chatGlobal + '{{roll=' + diceGraphicsRolled + '}}';
                        } else {
                            sendChat("", diceTextRolled);
                        }
                    } else {
            
                        if (eote.defaults.globalVars.diceGraphicsChat === true) {
            
                            if (diceObj.vars.label) {
                                sendChat(characterPlayer, "/direct " + diceObj.vars.label + '<br>');
                            }
                            if (diceObj.graphicsLog.Boost != "") sendChat("", "/direct " + diceObj.graphicsLog.Boost);
                            if (diceObj.graphicsLog.Ability != "") sendChat("", "/direct " + diceObj.graphicsLog.Ability);
                            if (diceObj.graphicsLog.Proficiency != "") sendChat("", "/direct " + diceObj.graphicsLog.Proficiency);
                            if (diceObj.graphicsLog.SetBack != "") sendChat("", "/direct " + diceObj.graphicsLog.SetBack);
                            if (diceObj.graphicsLog.Difficulty != "") sendChat("", "/direct " + diceObj.graphicsLog.Difficulty);
                            if (diceObj.graphicsLog.Challenge != "") sendChat("", "/direct " + diceObj.graphicsLog.Challenge);
                            if (diceObj.graphicsLog.Success != "") sendChat("", "/direct " + diceObj.graphicsLog.Success);
                            if (diceObj.graphicsLog.Advantage != "") sendChat("", "/direct " + diceObj.graphicsLog.Advantage);
                            if (diceObj.graphicsLog.Failure != "") sendChat("", "/direct " + diceObj.graphicsLog.Failure);
                            if (diceObj.graphicsLog.Threat != "") sendChat("", "/direct " + diceObj.graphicsLog.Threat);
                        } else {
                            if (diceObj.vars.label) {
                                sendChat(characterPlayer, "/direct " + diceObj.vars.label + '<br>');
                            }
                            if (diceObj.textLog.Boost != "") sendChat("", "Boost:" + diceObj.textLog.Boost);
                            if (diceObj.textLog.Ability != "") sendChat("", "Ability:" + diceObj.textLog.Ability);
                            if (diceObj.textLog.Proficiency != "") sendChat("", "Proficiency:" + diceObj.textLog.Proficiency);
                            if (diceObj.textLog.SetBack != "") sendChat("", "SetBack:" + diceObj.textLog.SetBack);
                            if (diceObj.textLog.Difficulty != "") sendChat("", "Difficulty:" + diceObj.textLog.Difficulty);
                            if (diceObj.textLog.Challenge != "") sendChat("", "Challenge:" + diceObj.textLog.Challenge);
                            if (diceObj.textLog.Success != "") sendChat("", "Success:" + diceObj.textLog.Success);
                            if (diceObj.textLog.Advantage != "") sendChat("", "Advantage:" + diceObj.textLog.Advantage);
                            if (diceObj.textLog.Failure != "") sendChat("", "Failure:" + diceObj.textLog.Failure);
                            if (diceObj.textLog.Threat != "") sendChat("", "Threat:" + diceObj.textLog.Threat);
                        }
                    }
                }
            
                var suggestions = suggestionEngine.buildSuggestionsRollTemplate(diceObj);
                var suggestionStatus = suggestionEngine.enum.displayOptions;
                var suggestionsFlag = suggestionEngine.getDisplayOption();
                var suggestionsExist = diceObj.vars.suggestions.suggestionsExist;
            
                if (suggestionsExist) {
                    switch (suggestionsFlag) {
                        case suggestionStatus.none:
                            // not really needed since the other checks won't allow a status of none to do anything
                            // but this prevents the default from yelling at you.
                            suggestions = null;
                            break;
                        case suggestionStatus.whisper:
                            suggestions = "&{template:base} {{title=Suggestions de dépense de symboles}} " + suggestions;
                            break;
                        case suggestionStatus.always:
                            suggestions = " {{suggestionsExist=true}} " + suggestions;
                            break;
                        case null:
                            var msg = "No display option determined! Please set the display option on the " + eote.defaults.GMSheet.name;
                            log(msg);
                            sendChat("System", "/w gm " + msg);
                            break;
                        default:
                            // this should never be entered
                            log("Report Me! A suggestionFlag of '" + suggestionsFlag + "' is not handled properly!");
                    }
                }
            
                if (eote.defaults.globalVars.diceGraphicsChat === true) {
                    chatGlobal = chatGlobal + '{{results=' + diceGraphicsResults + '}}';
                    if (suggestions && suggestionsFlag == suggestionStatus.always)
                        chatGlobal += " " + suggestions;
                    sendChat(characterPlayer, chatGlobal);
                } else {
                    sendChat("Roll", diceTextResults);
                }
            
                if (suggestions && suggestionsFlag == suggestionStatus.whisper) {
                    sendChat("System", "/w gm " + suggestions);
                }
                eote.process.logger("eote.process.rollResult", diceTextResults);
            };
            
            eote.roll = {
            
                boost: function (diceQty) {
                    //Blue "Boost" die (d6)
                    //1 Blank
                    //2 Blank
                    //3 Success
                    //4 Advantage
                    //5 Advantage + Advantage
                    //6 Success + Advantage
                    var roll = 0;
                    var diceResult = {
                        success: 0,
                        failure: 0,
                        advantage: 0,
                        threat: 0,
                        triumph: 0,
                        despair: 0,
                        light: 0,
                        dark: 0,
                        diceGraphicsLog: "",
                        diceTextLog: ""
                    };
                    var i = 0;
                    var s1 = '<img src="';
                    var s2 = '" title="';
                    var s3 = '" height="';
                    var s4 = '" width="';
                    var s5 = '"/>';
            
                    if (eote.defaults.globalVars.diceTestEnabled === true) {
                        diceQty = 6;
                    }
                    for (i = 1; i <= diceQty; i++) {
                        if (eote.defaults.globalVars.diceTestEnabled === true) {
                            roll = roll + 1;
                        } else {
                            roll = randomInteger(6);
                        }
                        switch (roll) {
                            case 1:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Blank)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.BOOST.BLANK + s2 + "Bleu Vierge" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                break;
                            case 2:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Blank)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.BOOST.BLANK + s2 + "Bleu Vierge" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                break;
                            case 3:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.BOOST.S + s2 + "Bleu Succès" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                break;
                            case 4:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Advantage)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.BOOST.A + s2 + "Bleu Avantage" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.advantage = diceResult.advantage + 1;
                                break;
                            case 5:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Advantage)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.BOOST.A + s2 + "Bleu Avantage" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.advantage = diceResult.advantage + 1;
                                break;
                            case 6:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success + Advantage)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.BOOST.SA + s2 + "Bleu Succès + Avantage" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                diceResult.advantage = diceResult.advantage + 1;
                                break;
                        }
                    }
                    return diceResult;
                },
                ability: function (diceQty) {
                    //Green "Ability" die (d8)
                    //1 Blank
                    //2 Success
                    //3 Success
                    //4 Advantage
                    //5 Advantage
                    //6 Success + Advantage
                    //7 Advantage + Advantage
                    //8 Success + Success
                    var roll = 0;
                    var diceTextLog = "";
                    var diceGraphicsLog = "";
                    var diceResult = {
                        success: 0,
                        failure: 0,
                        advantage: 0,
                        threat: 0,
                        triumph: 0,
                        despair: 0,
                        light: 0,
                        dark: 0,
                        diceGraphicsLog: "",
                        diceTextLog: ""
                    };
                    var i = 0;
                    var s1 = '<img src="';
                    var s2 = '" title="';
                    var s3 = '" height="';
                    var s4 = '" width="';
                    var s5 = '"/>';
            
                    if (eote.defaults.globalVars.diceTestEnabled === true) {
                        diceQty = 8;
                    }
                    for (i = 1; i <= diceQty; i++) {
                        if (eote.defaults.globalVars.diceTestEnabled === true) {
                            roll = roll + 1;
                        }
                        else {
                            roll = randomInteger(8);
                        }
                        switch (roll) {
                            case 1:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Blank)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.ABILITY.BLANK + s2 + "Vert Vierge" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                break;
                            case 2:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.ABILITY.S + s2 + "Vert Succès" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                break;
                            case 3:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.ABILITY.S + s2 + "Vert Succès" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                break;
                            case 4:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Advantage)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.ABILITY.A + s2 + "Vert Avantage" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.advantage = diceResult.advantage + 1;
                                break;
                            case 5:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Blank)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.ABILITY.BLANK + s2 + "Vert Vierge" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                break;
                            case 6:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success + Advantage)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.ABILITY.SA + s2 + "Vert Succès + Avantage" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                diceResult.advantage = diceResult.advantage + 1;
                                break;
                            case 7:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.ABILITY.S + s2 + "Vert Succès" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                break;
                            case 8:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success x2)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.ABILITY.SS + s2 + "Vert Succès x2" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 2;
                                break;
                        }
                    }
                    return diceResult;
                },
                proficiency: function (diceQty) {
                    //Yellow "Proficiency" die (d12)
                    //1 Blank
                    //2 Triumph
                    //3 Success
                    //4 Success
                    //5 Advantage
                    //6 Success + Advantage
                    //7 Success + Advantage
                    //8 Success + Advantage
                    //9 Success + Success
                    //10 Success + Success
                    //11 Advantage + Advantage
                    //12 Advantage + Advantage
                    var roll = 0;
                    var diceTextLog = "";
                    var diceGraphicsLog = "";
                    var diceResult = {
                        success: 0,
                        failure: 0,
                        advantage: 0,
                        threat: 0,
                        triumph: 0,
                        despair: 0,
                        light: 0,
                        dark: 0,
                        diceGraphicsLog: "",
                        diceTextLog: ""
                    };
                    var i = 0;
                    var s1 = '<img src="';
                    var s2 = '" title="';
                    var s3 = '" height="';
                    var s4 = '" width="';
                    var s5 = '"/>';
            
                    if (eote.defaults.globalVars.diceTestEnabled === true) {
                        diceQty = 12;
                    }
                    for (i = 1; i <= diceQty; i++) {
                        if (eote.defaults.globalVars.diceTestEnabled === true) {
                            roll = roll + 1;
                        }
                        else {
                            roll = randomInteger(12);
                        }
                        switch (roll) {
                            case 1:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Blank)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.BLANK + s2 + "Jaune Vierge" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                break;
                            case 2:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Triumph(+Success))";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.TRIUMPH + s2 + "Jaune Critique" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.triumph = diceResult.triumph + 1;
                                diceResult.success = diceResult.success + 1;
                                break;
                            case 3:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.S + s2 + "Jaune Succès" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                break;
                            case 4:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.S + s2 + "Jaune Succès" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                break;
                            case 5:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Advantage)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.A + s2 + "Jaune Avantage" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.advantage = diceResult.advantage + 1;
                                break;
                            case 6:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success + Advantage)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.SA + s2 + "Jaune Avantage + Succès" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                diceResult.advantage = diceResult.advantage + 1;
                                break;
                            case 7:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success + Advantage)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.SA + s2 + "Jaune Avantage + Succès" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                diceResult.advantage = diceResult.advantage + 1;
                                break;
                            case 8:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success + Advantage)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.SA + s2 + "Jaune Avantage + Succès" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 1;
                                diceResult.advantage = diceResult.advantage + 1;
                                break;
                            case 9:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success x2)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.SS + s2 + "Jaune Succès x2" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 2;
                                break;
                            case 10:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Success x2)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.SS + s2 + "Jaune Succès x2" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.success = diceResult.success + 2;
                                break;
                            case 11:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Advantage)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.A + s2 + "Jaune Avantage" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.advantage = diceResult.advantage + 1;
                                break;
                            case 12:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Blank)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.PROFICIENCY.BLANK + s2 + "Jaune Vierge" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                break;
                        }
                    }
                    return diceResult;
                },
                setback: function (diceQty) {
                    //Black "Setback" die (d6)
                    //1 Blank
                    //2 Blank
                    //3 Failure
                    //4 Failure
                    //5 Threat
                    //6 Threat
                    var roll = 0;
                    var diceTextLog = "";
                    var diceGraphicsLog = "";
                    var diceResult = {
                        success: 0,
                        failure: 0,
                        advantage: 0,
                        threat: 0,
                        triumph: 0,
                        despair: 0,
                        light: 0,
                        dark: 0,
                        diceGraphicsLog: "",
                        diceTextLog: ""
                    };
                    var i = 0;
                    var s1 = '<img src="';
                    var s2 = '" title="';
                    var s3 = '" height="';
                    var s4 = '" width="';
                    var s5 = '"/>';
            
                    if (eote.defaults.globalVars.diceTestEnabled === true) {
                        diceQty = 6;
                    }
                    for (i = 1; i <= diceQty; i++) {
                        if (eote.defaults.globalVars.diceTestEnabled === true) {
                            roll = roll + 1;
                        }
                        else {
                            roll = randomInteger(6);
                        }
                        switch (roll) {
                            case 1:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Blank)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.SETBACK.BLANK + s2 + "Noir Vierge" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                break;
                            case 2:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Blank)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.SETBACK.BLANK + s2 + "Noir Vierge" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                break;
                            case 3:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.SETBACK.F + s2 + "Noir Échec" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 1;
                                break;
                            case 4:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.SETBACK.F + s2 + "Noir Échec" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 1;
                                break;
                            case 5:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Threat)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.SETBACK.T + s2 + "Noir Handicap" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.threat = diceResult.threat + 1;
                                break;
                            case 6:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Threat)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.SETBACK.T + s2 + "Noir Handicap" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.threat = diceResult.threat + 1;
                                break;
                        }
                    }
                    return diceResult;
                },
                difficulty: function (diceQty) {
                    //Purple "Difficulty" die (d8)
                    //1 Blank
                    //2 Failure
                    //3 Threat
                    //4 Threat
                    //5 Threat
                    //6 Failure + Failure
                    //7 Failure + Threat
                    //8 Threat + Threat
                    var roll = 0;
                    var diceTextLog = "";
                    var diceGraphicsLog = "";
                    var diceResult = {
                        success: 0,
                        failure: 0,
                        advantage: 0,
                        threat: 0,
                        triumph: 0,
                        despair: 0,
                        light: 0,
                        dark: 0,
                        diceGraphicsLog: "",
                        diceTextLog: ""
                    };
                    var i = 0;
                    var s1 = '<img src="';
                    var s2 = '" title="';
                    var s3 = '" height="';
                    var s4 = '" width="';
                    var s5 = '"/>';
            
                    if (eote.defaults.globalVars.diceTestEnabled === true) {
                        diceQty = 8;
                    }
                    for (i = 1; i <= diceQty; i++) {
                        if (eote.defaults.globalVars.diceTestEnabled === true) {
                            roll = roll + 1;
                        }
                        else {
                            roll = randomInteger(8);
                        }
                        switch (roll) {
                            case 1:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Blank)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.DIFFICULTY.BLANK + s2 + "Difficulty Blank" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                break;
                            case 2:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.DIFFICULTY.F + s2 + "Difficulty Failure" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 1;
                                break;
                            case 3:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Threat)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.DIFFICULTY.T + s2 + "Difficulty Threat" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.threat = diceResult.threat + 1;
                                break;
                            case 4:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Threat)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.DIFFICULTY.T + s2 + "Difficulty Threat" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.threat = diceResult.threat + 1;
                                break;
                            case 5:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Threat)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.DIFFICULTY.T + s2 + "Difficulty Threat" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.threat = diceResult.threat + 1;
                                break;
                            case 6:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure x2)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.DIFFICULTY.FF + s2 + "Difficulty Failure x2" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 2;
                                break;
                            case 7:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure + Threat)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.DIFFICULTY.FT + s2 + "Difficulty Failure + Threat" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 1;
                                diceResult.threat = diceResult.threat + 1;
                                break;
                            case 8:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Threat x2)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.DIFFICULTY.TT + s2 + "Difficulty Threat x2" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.threat = diceResult.threat + 2;
                                break;
                        }
                    }
                    return diceResult;
                },
                challenge: function (diceQty) {
                    //Red "Challenge" die (d12)
                    //1 Blank
                    //2 Despair
                    //3 Failure
                    //4 Failure
                    //5 Threat
                    //6 Threat
                    //7 Failure + Failure
                    //8 Failure + Failure
                    //9 Threat + Threat
                    //10 Threat + Threat
                    //11 Failure + Threat
                    //12 Failure + Threat
                    var roll = 0;
                    var diceTextLog = "";
                    var diceGraphicsLog = "";
                    var diceResult = {
                        success: 0,
                        failure: 0,
                        advantage: 0,
                        threat: 0,
                        triumph: 0,
                        despair: 0,
                        light: 0,
                        dark: 0,
                        diceGraphicsLog: "",
                        diceTextLog: ""
                    };
                    var i = 0;
                    var s1 = '<img src="';
                    var s2 = '" title="';
                    var s3 = '" height="';
                    var s4 = '" width="';
                    var s5 = '"/>';
            
                    if (eote.defaults.globalVars.diceTestEnabled === true) {
                        diceQty = 12;
                    }
                    for (i = 1; i <= diceQty; i++) {
                        if (eote.defaults.globalVars.diceTestEnabled === true) {
                            roll = roll + 1;
                        }
                        else {
                            roll = randomInteger(12);
                        }
                        switch (roll) {
                            case 1:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Threat x2)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.TT + s2 + "Rouge Handicap x2" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.threat = diceResult.threat + 2;
                                break;
                            case 2:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Despair)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.DESPAIR + s2 + "Rouge Désastre" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.despair = diceResult.despair + 1;
                                diceResult.failure = diceResult.failure + 1;
                                break;
                            case 3:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.F + s2 + "Rouge Échec" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 1;
                                break;
                            case 4:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.F + s2 + "Rouge Échec" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 1;
                                break;
                            case 5:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Threat)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.T + s2 + "Rouge Handicap" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.threat = diceResult.threat + 1;
                                break;
                            case 6:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure x2)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.FF + s2 + "Rouge Échec x2" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 2;
                                break;
                            case 7:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure x2)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.FF + s2 + "Rouge Échec x2" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 2;
                                break;
                            case 8:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure x2)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.FF + s2 + "Rouge Échec x2" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 2;
                                break;
                            case 9:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure + Threat)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.FT + s2 + "Rouge Échec + Handicap" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 1;
                                diceResult.threat = diceResult.threat + 1;
                                break;
                            case 10:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Threat x2)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.TT + s2 + "Rouge Handicap x2" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.threat = diceResult.threat + 2;
                                break;
                            case 11:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Failure + Threat)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.FT + s2 + "Rouge Échec + Handicap" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                diceResult.failure = diceResult.failure + 1;
                                diceResult.threat = diceResult.threat + 1;
                                break;
                             case 12:
                                diceResult.diceTextLog = diceResult.diceTextLog + "(Blank)";
                                diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.CHALLENGE.BLANK + s2 + "Vierge" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                                break;
                        }
                    }
                    return diceResult;
                },
                success: function (diceQty) {
                    //Free Success
                    var i = 0;
                    var s1 = '<img src="';
                    var s2 = '" title="';
                    var s3 = '" height="';
                    var s4 = '" width="';
                    var s5 = '"/>';
            
                    var roll = 0;
                    var diceTextLog = "";
                    var diceGraphicsLog = "";
            
                    var diceResult = {
                        success: 0,
                        failure: 0,
                        advantage: 0,
                        threat: 0,
                        triumph: 0,
                        despair: 0,
                        light: 0,
                        dark: 0,
                        diceGraphicsLog: "",
                        diceTextLog: ""
                    };
                    diceResult.diceTextLog = diceTextLog + "(Success x" + diceQty + ")";
                    diceResult.success = diceResult.success + diceQty;
                    for (i = 0; i < diceQty; i++) {
                        diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.SYMBOLS.S + s2 + "Success" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                    return diceResult;
                },
                advantage: function (diceQty) {
                    //Free Advantage
                    var i = 0;
                    var s1 = '<img src="';
                    var s2 = '" title="';
                    var s3 = '" height="';
                    var s4 = '" width="';
                    var s5 = '"/>';
            
                    var roll = 0;
                    var diceTextLog = "";
                    var diceGraphicsLog = "";
            
                    var diceResult = {
                        success: 0,
                        failure: 0,
                        advantage: 0,
                        threat: 0,
                        triumph: 0,
                        despair: 0,
                        light: 0,
                        dark: 0,
                        diceGraphicsLog: "",
                        diceTextLog: ""
                    };
                    diceResult.diceTextLog = diceTextLog + "(Advantage x" + diceQty + ")";
                    diceResult.advantage = diceResult.advantage + diceQty;
                    for (i = 0; i < diceQty; i++) {
                        diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.SYMBOLS.A + s2 + "Advantage" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                    return diceResult;
                },
                threat: function (diceQty) {
                    //Free threat
                    var i = 0;
                    var s1 = '<img src="';
                    var s2 = '" title="';
                    var s3 = '" height="';
                    var s4 = '" width="';
                    var s5 = '"/>';
            
                    var roll = 0;
                    var diceTextLog = "";
                    var diceGraphicsLog = "";
            
                    var diceResult = {
                        success: 0,
                        failure: 0,
                        advantage: 0,
                        threat: 0,
                        triumph: 0,
                        despair: 0,
                        light: 0,
                        dark: 0,
                        diceGraphicsLog: "",
                        diceTextLog: ""
                    };
                    diceResult.diceTextLog = diceTextLog + "(Threat x" + diceQty + ")";
                    diceResult.threat = diceResult.threat + diceQty;
                    for (i = 0; i < diceQty; i++) {
                        diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.SYMBOLS.T + s2 + "Threat" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                    return diceResult;
                },
                failure: function (diceQty) {
                    //Free Failure
                    var i = 0;
                    var s1 = '<img src="';
                    var s2 = '" title="';
                    var s3 = '" height="';
                    var s4 = '" width="';
                    var s5 = '"/>';
            
                    var roll = 0;
                    var diceTextLog = "";
                    var diceGraphicsLog = "";
            
                    var diceResult = {
                        success: 0,
                        failure: 0,
                        advantage: 0,
                        threat: 0,
                        triumph: 0,
                        despair: 0,
                        light: 0,
                        dark: 0,
                        diceGraphicsLog: "",
                        diceTextLog: ""
                    };
                    diceResult.diceTextLog = diceTextLog + "(Failure x" + diceQty + ")";
                    diceResult.failure = diceResult.failure + diceQty;
                    for (i = 0; i < diceQty; i++) {
                        diceResult.diceGraphicsLog = diceResult.diceGraphicsLog + s1 + eote.defaults.graphics.SYMBOLS.F + s2 + "Success" + s3 + eote.defaults.globalVars.diceGraphicsChatSize + s4 + eote.defaults.globalVars.diceGraphicsChatSize + s5;
                    }
                    return diceResult;
                }
            };
            
            eote.events = function () {
            
                //event listener Add character defaults to new characters
                on("add:character", function (characterObj) {
                    eote.setCharacterDefaults(characterObj);
                });
                on("chat:message", function (msg) {
            
                    if (msg.type != 'api') {
                        return;
                    }
                    eote.process.setup(msg.content, msg.who, msg.playerid);
                });
            };
            
            // this only runs once per initialization of the script in order to prevent this process from running too frequently
            // this converts any $\w$ token that matches a defined list of tokens into a html image tag.
            function convertTokensToTags(skillSuggestions, symReplace) {
                Object.keys(skillSuggestions).forEach(function (categoryKey) {
                    var category = skillSuggestions[categoryKey];
                    Object.keys(category).forEach(function (categoryElemKey) {
                        var categoryElem = category[categoryElemKey];
                        Object.keys(categoryElem).forEach(function (symbolKey) {
                            var item = categoryElem[symbolKey];
                            for (var i = 0; i < item.length; i++) {
                                var itemElem = item[i];
                                if (typeof itemElem == "object") {
                                    if (itemElem.text.indexOf("$") > 0) {
                                        Object.keys(symReplace).forEach(function (symReplaceKey) {
                                            itemElem.text = itemElem.text.replace(symReplace[symReplaceKey].matcher, symReplace[symReplaceKey].replacer);
                                        });
                                    }
                                }
                            }
                        });
                    });
                });
                log("Finished converting tokens to tags");
            }
            
            
            on('ready', function () {
                eote.init();
            });
            
            // Github:   https://github.com/shdwjk/Roll20API/blob/master/Ammo/Ammo.js
// By:       The Aaron, Arcane Scriptomancer
// Contact:  https://app.roll20.net/users/104025/the-aaron

var Ammo = Ammo || (function() {
    'use strict';

    var version = '0.3.7',
        lastUpdate = 1490362793,
		schemaVersion = 0.1,

	ch = function (c) {
		var entities = {
			'<' : 'lt',
			'>' : 'gt',
			"'" : '#39',
			'@' : '#64',
			'{' : '#123',
			'|' : '#124',
			'}' : '#125',
			'[' : '#91',
			']' : '#93',
			'"' : 'quot',
			'-' : 'mdash',
			' ' : 'nbsp'
		};

		if(_.has(entities,c) ){
			return ('&'+entities[c]+';');
		}
		return '';
	},
    sendMessage = function(message, who) {
		sendChat('Ammo', (who ? ('/w gm ') : '') + '<div style="padding:1px 3px;border: 1px solid #8B4513;background: #eeffee; color: #8B4513; font-size: 80%;"> '+
			message+
			'</div>'
		);
	},

	adjustAmmo = function (who,attr,amount,label,playerid) {
		var val = parseInt(attr.get('current'),10)||0,
			max = parseInt(attr.get('max'),10)||10000,
			adj = (val+amount),
			chr = getObj('character',attr.get('characterid')),
			valid = true;
        label=label||'AT';

		if(adj < 1 ) {
			sendMessage(
				'<b>'+chr.get('name') + ' Plus de Munition !</b> '+
				'<span style="font-weight:normal;color:#708090;>'+ch('[')+'Attribute: '+attr.get('name')+ch(']')+'</span>',
                'gm'
			);
			valid = false;
		} else if( adj > max) {
			sendMessage(
				'<b>'+chr.get('name') + '</b> does not have enough storage space for '+label+'.  Needs '+adj+', but only has '+
				'<span style="color: #ff0000;">'+max+'</span>.'+
				'<span style="font-weight:normal;color:#708090;>'+ch('[')+'Attribute: '+attr.get('name')+ch(']')+'</span>',
                'gm'
			);
			valid = false;
		}

		if( playerIsGM(playerid) || valid ) {
			attr.set({current: adj});
			sendMessage(
				'<b>'+chr.get('name') + '</b> '+( (adj<val) ? 'utilise' : 'gains' )+' '+Math.abs(amount)+' '+label+' - Restant '+adj,
                'gm'
			);
			if(!valid) {
				sendMessage(
					'Ignoring warnings and applying adjustment anyway.  Was: '+val+'/'+max+' Now: '+adj+'/'+max,
                    'gm'
				);
			}
		}
	},

	
    attrLookup = function(character,name,caseSensitive){
        let match=name.match(/^(repeating_.*)_\$(\d+)_.*$/);
        if(match){
            let index=match[2],
                attrMatcher=new RegExp(`^${name.replace(/_\$\d+_/,'_([-\\da-zA-Z]+)_')}$`,(caseSensitive?'i':'')),
                createOrderKeys=[],
                attrs=_.chain(findObjs({type:'attribute', characterid:character.id}))
                    .map((a)=>{
                        return {attr:a,match:a.get('name').match(attrMatcher)};
                    })
                    .filter((o)=>o.match)
                    .each((o)=>createOrderKeys.push(o.match[1]))
                    .reduce((m,o)=>{ m[o.match[1]]=o.attr; return m;},{})
                    .value(),
                sortOrderKeys = _.chain( ((findObjs({
                        type:'attribute',
                        characterid:character.id,
                        name: `_reporder_${match[1]}`
                    })[0]||{get:_.noop}).get('current') || '' ).split(/\s*,\s*/))
                    .intersection(createOrderKeys)
                    .union(createOrderKeys)
                    .value();
            if(index<sortOrderKeys.length && _.has(attrs,sortOrderKeys[index])){
                return attrs[sortOrderKeys[index]];
            }
            return;
        } 
        return findObjs({ type:'attribute', characterid:character.id, name: name}, {caseInsensitive: !caseSensitive})[0];
    },

	HandleInput = function(msg_orig) {
		var msg = _.clone(msg_orig),
			args,attr,amount,chr,token,text='',label, whisper=false,
            who;

		if (msg.type !== "api") {
			return;
		}
        who=(getObj('player',msg.playerid)||{get:()=>'API'}).get('_displayname');

		if(_.has(msg,'inlinerolls')){
			msg.content = _.chain(msg.inlinerolls)
				.reduce(function(m,v,k){
					m['$[['+k+']]']=v.results.total || 0;
					return m;
				},{})
				.reduce(function(m,v,k){
					return m.replace(k,v);
				},msg.content)
				.value();
		}

		args = msg.content.split(/\s+/);
		switch(args[0]) {
            case '!wammo':
                whisper = true;
                /* break; // intentional dropthrough */ /* falls through */

            case '!ammo':
				if(args.length > 1) {

					switch(args[1]) {
                        case '--help':
                            return showHelp(who,msg.playerid);

						case 'recover': // <character/token_id> <attribute_name>
							// apply policy to put amounts back in
						case 'check': // <character/token_id> <attribute_name>
							// print the amount in the attribute nicely formatted
						case 'recovery-policy': // [character/token_id] [attribute_name] <percentage>
							// create the right entry in the state
						case 'name': // [character/token_id] [attribute_name] <name>
							// create the right entry in the state

						// configs
						case 'recovery-updates-maximum': 
							// adjust the maximum to be whatever the current is
						case 'create-attributes-automatically': 
							// create the requested attribute and start using it.
					}


					chr = getObj('character', args[1]);
					if( ! chr ) {
						token = getObj('graphic', args[1]);
						if(token) {
							chr = getObj('character', token.get('represents'));
						}
					}
					if(chr) {
						if(! playerIsGM(msg.playerid) &&
							! _.contains(chr.get('controlledby').split(','),msg.playerid) &&
							! _.contains(chr.get('controlledby').split(','),'all') 
							)
						{
							sendMessage(
                                'You do not control the specified character: '+chr.id ,
                                (playerIsGM(msg.playerid) ? 'gm' : (whisper ? who :false))
                            );
							sendMessage(
								'<b>'+getObj('player',msg.playerid).get('_displayname')+'</b> attempted to adjust attribute <b>'+args[2]+'</b> on character <b>'+chr.get('name')+'</b>.',
								'gm'
							);
							return;
						}

						attr = attrLookup(chr,args[2],false);
					}
					amount=parseInt(args[3],10);
                    label=_.rest(args,4).join(' ');
					if(attr) {
						adjustAmmo(
                            'gm',
                            attr,amount,label,msg.playerid
                        );
					} else {
                        if(chr) {
                            sendMessage(
                                'Attribute ['+args[2]+'] was not found.  Please verify that you have the right name.',
                                (playerIsGM(msg.playerid) ? 'gm' : (whisper ? who :false))
                            );
                        } else {
                            sendMessage(
                                ( token ?  'Token id ['+args[1]+'] does not represent a character. ' : 'Character/Token id ['+args[1]+'] is not valid. ' ) +
                                'Please be sure you are specifying it correctly, either with '+ch('@')+ch('{')+'selected|token_id'+ch('}')+
                                ' or '+ch('@')+ch('{')+'selected|character_id'+ch('}')+'.',
                                (playerIsGM(msg.playerid) ? 'gm' : (whisper ? who :false))
                            );
						}
					}
				} else {
					showHelp(who,msg.playerid);
				}
                break;
		}

	},
    checkInstall = function() {    
        log('-=> Ammo v'+version+' <=-  ['+(new Date(lastUpdate*1000))+']');
        if( ! _.has(state,'Ammo') || state.Ammo.version !== schemaVersion) {
            log('  > Updating Schema to v'+schemaVersion+' <');
            state.Ammo = {
				version: schemaVersion,
				config: {
				},
				policies: {
					global: {
						recoveryUpdatesMaximum: false
					},
					byAttribute: {
					},
					byCharacter: {
					}
				}
			};
		}
	},

	RegisterEventHandlers = function() {
		on('chat:message', HandleInput);
	};

	return {
        CheckInstall: checkInstall,
		RegisterEventHandlers: RegisterEventHandlers
	};
}());

on("ready",function(){
	'use strict';

	Ammo.CheckInstall();
	Ammo.RegisterEventHandlers();
});